window.TplTool=function(template,options){if(template==null){throw new Error("template cannot be null")}var targetWindow=window;if(options&&options.targetWindow){targetWindow=options.targetWindow}try{var $items=$("#"+template);if($items.length>0){template=$items.html()}}catch(e){}var elementDisplayMode={block:1,inline:1,"list-item":1,"run-in":1,compact:1,marker:1,table:1,"inline-table":1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1};var _tpl={version:"1.0.0.10",author:"powerjeep@163.com",history:"1.0.0.10 针对上一个版本的改动增加其多浏览器支持的特性;1.0.0.9 支持构造函数直接传递 模版 element 的id;1.0.0.8 修订 template 模版展开时由于总是追加到尾部引起的次序混乱的问题; 1.0.0.7 支持 render 对象也提供 onResult 回调，以便风格一致; 1.0.0.6 options支持 targetWindow 属性，可将内容渲染到其他页面; 1.0.0.5 增加内置属性 item.$row 用于引用当前行号;1.0.0.4 render自动识别对象是否为数组，若为数组则直接按数组进行渲染,弱化 renderList的用法;        根据是否设置了el选项来调整条件渲染的搜索范围，避免多个TplTool实例互相干扰;append时自动完成条件渲染而不必等下一个时钟;.0.0.3 修订在对象的属性里引用表达式时，因为 && 条件里面字符被转义造成的问题;增加append方法，并修复 Template作为容器模板的问题;",_timeoutHandle:null,targetWindow:targetWindow,template:template,options:options,render:function(item,onProcessData,onResult){var arrayTypeConst="[object Array]";if(Object.prototype.toString.call(item)==arrayTypeConst){return _tpl.renderList(item,onProcessData,onResult)}else{return _tpl._render(item,onProcessData,onResult)}},_render:function(item,onProcessData,onResult){var eval2=function(text){try{return eval(text)}catch(e){var t2=text.replace(/&amp;/g,"&");if(t2!=text){return eval(t2)}else{throw e}}};var text="";var html=template;try{if(_tpl.template==null||item==null){html=null;return html}for(var key in item){var reg=new RegExp("#"+key+"#","g");var value=item[key]!=null?item[key]:"";value+="";html=html.replace(reg,_tpl.textToHtml(value))}for(var key in item){var reg=new RegExp("\\$"+key+"\\$","g");var value=item[key]!=null?item[key]:"";value+="";html=html.replace(reg,value)}html=html.replace(/({{)(.*?)(}})/ig,function(word){var reg=/({{)(.*?)(}})/;var matches=reg.exec(word);if(matches&&matches.length>=3){if(_tpl.options&&_tpl.options.key){this[_tpl.options.key]=item}text=matches[2];if(text==""){return text}else{if(text.indexOf("$")==0){if(text.indexOf("$quote")==0){text=text.substring("$quote".length);return _tpl.quoteToHtml(eval2(text))}else{if(text.indexOf("$single_quote")==0){text=text.substring("$single_quote".length);return _tpl.singleQuoteToHtml(eval2(text))}else{text=text.substring("$".length);return eval2(text)}}}else{return _tpl.textToHtml(eval2(text))}}}else{return""}});if(!_tpl._timeoutHandle){_tpl._timeoutHandle=setTimeout(function(){_tpl._makeConditionJudge()},0)}return html}catch(e){html="object"==typeof console&&console.error("TemplateUITool Error："+e+"\n"+(text||""));return html}finally{if(onResult){onResult(html)}}},append:function(item,onProcessData){if(_tpl.options&&_tpl.options.el&&_tpl.targetWindow.$(_tpl.options.el).length>0){_tpl.targetWindow.$(_tpl.options.el).append(_tpl.render(item,onProcessData));_tpl._makeConditionJudge()}else{throw new Error("TemplateUITool error of options.el not defined or not found, so cannot append.")}},_makeConditionJudge:function(){try{var searchPrefix=_tpl.options&&_tpl.options.el?_tpl.options.el+" ":"";_tpl.targetWindow.$(searchPrefix+"[t-show]").each(function(){var v=_tpl.targetWindow.$(this).attr("t-show");v=_tpl.trim(v);if(v==""){_tpl.targetWindow.$(this).css("display","none")}else{if(elementDisplayMode[v]==1){_tpl.targetWindow.$(this).css("display",v)}}});_tpl.targetWindow.$(searchPrefix+"[t-if]").each(function(){var v=_tpl.targetWindow.$(this).attr("t-if");v=_tpl.trim(v);if(v){if(_tpl.targetWindow.$(this)[0].tagName=="TEMPLATE"){_tpl.targetWindow.$(this).after(_tpl.targetWindow.$(this)[0].innerHTML)}else{var list=[];for(var i=0;i<_tpl.targetWindow.$(this)[0].childNodes.length;i++){list.push(_tpl.targetWindow.$(this)[0].childNodes[i])}for(var i=0;i<list.length;i++){_tpl.targetWindow.$(this)[0].parentNode.insertBefore(list[i],_tpl.targetWindow.$(this)[0])}}}_tpl.targetWindow.$(this).remove()})}finally{clearTimeout(_tpl._timeoutHandle);_tpl._timeoutHandle=null}},trim:function(str){return str.replace(/(^\s*)|(\s*$)/g,"")},renderList:function(list,onProcessData,onResult){var html="";for(var i=0;i<list.length;i++){var dataItem=list[i];dataItem["$row"]=i;if(onProcessData){onProcessData(dataItem)}html+=_tpl._render(dataItem)}if(onResult){onResult(html)}return html},quoteToHtml:function(str){str=(str==null||str===false)?"":str+"";str=str.replace(/"/g,"&quot;");return str},singleQuoteToHtml:function(str){str=(str==null||str===false)?"":str+"";str=str.replace(/'/g,"&apos;");return str},textToHtml:function(str){str=(str==null||str===false)?"":str+"";str=str.replace(/&/g,"&amp;");str=str.replace(/</g,"&lt;");str=str.replace(/>/g,"&gt;");str=str.replace(/ /g,"&nbsp;");str=str.replace(/'/g,"&apos;");str=str.replace(/"/g,"&quot;");str=str.replace(/\n/g,"<br>");return str}};return _tpl};var TemplateUITool={render:function(a,e,d,c){var b=TplTool(a);return b.render(e,d,c)},renderList:function(a,e,d,c){var b=TplTool(a);return b.renderList(e,d,c)}};