function xml2json(a){var b={toObj:function(d){var h={};if(d.nodeType==1){if(d.attributes.length){for(var g=0;g<d.attributes.length;g++){h["@"+d.attributes[g].nodeName]=(d.attributes[g].nodeValue||"").toString();}}if(d.firstChild){var c=0,f=0,e=false;for(var j=d.firstChild;j;j=j.nextSibling){if(j.nodeType==1){e=true;
}else{if(j.nodeType==3&&j.nodeValue.match(/[^ \f\n\r\t\v]/)){c++;}else{if(j.nodeType==4){f++;}}}}if(e){if(c<2&&f<2){b.removeWhite(d);for(var j=d.firstChild;j;j=j.nextSibling){if(j.nodeType==3){h["#text"]=b.escape(j.nodeValue);}else{if(j.nodeType==4){h["#cdata"]=b.escape(j.nodeValue);}else{if(h[j.nodeName]){if(h[j.nodeName] instanceof Array){h[j.nodeName][h[j.nodeName].length]=b.toObj(j);
}else{h[j.nodeName]=[h[j.nodeName],b.toObj(j)];}}else{h[j.nodeName]=b.toObj(j);}}}}}else{h["#text"]=b.escape(b.innerXml(d));}}else{if(c){h["#text"]=b.escape(b.innerXml(d));}else{if(f){if(f>1){h=b.escape(b.innerXml(d));}else{for(var j=d.firstChild;j;j=j.nextSibling){h["#cdata"]=b.escape(j.nodeValue);}}}}}}if(!d.attributes.length&&!d.firstChild){h=null;
}}else{if(d.nodeType==9){h=b.toObj(d.documentElement);}else{alert("unhandled node type: "+d.nodeType);}}return h;},innerXml:function(f){var e="";if("innerHTML" in f){e=f.innerHTML;}else{var d=function(l){var j="";if(l.nodeType==1){j+="<"+l.nodeName;for(var h=0;h<l.attributes.length;h++){j+=" "+l.attributes[h].nodeName+'="'+(l.attributes[h].nodeValue||"").toString()+'"';
}if(l.firstChild){j+=">";for(var k=l.firstChild;k;k=k.nextSibling){j+=d(k);}j+="</"+l.nodeName+">";}else{j+="/>";}}else{if(l.nodeType==3){j+=l.nodeValue;}else{if(l.nodeType==4){j+="<![CDATA["+l.nodeValue+"]]>";}}}return j;};for(var g=f.firstChild;g;g=g.nextSibling){e+=d(g);}}return e;},escape:function(c){return c.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r");
},removeWhite:function(d){d.normalize();for(var f=d.firstChild;f;){if(f.nodeType==3){if(!f.nodeValue.match(/[^ \f\n\r\t\v]/)){var c=f.nextSibling;d.removeChild(f);f=c;}else{f=f.nextSibling;}}else{if(f.nodeType==1){b.removeWhite(f);f=f.nextSibling;}else{f=f.nextSibling;}}}return d;}};if(a.nodeType==9){a=a.documentElement;
}return b.toObj(b.removeWhite(a));}function xml2jsonText(a,b){if(a.nodeType==9){a=a.documentElement;}var d={toJson:function(l,g,k){var j=g?('"'+g+'"'):"";if(l instanceof Array){for(var h=0,p=l.length;h<p;h++){l[h]=d.toJson(l[h],"",k+"\t");}j+=(g?":[":"[")+(l.length>1?("\n"+k+"\t"+l.join(",\n"+k+"\t")+"\n"+k):l.join(""))+"]";
}else{if(l==null){j+=(g&&":")+"null";}else{if(typeof(l)=="object"){var f=[];for(var e in l){f[f.length]=d.toJson(l[e],e,k+"\t");}j+=(g?":{":"{")+(f.length>1?("\n"+k+"\t"+f.join(",\n"+k+"\t")+"\n"+k):f.join(""))+"}";}else{if(typeof(l)=="string"){j+=(g&&":")+'"'+l.toString()+'"';}else{j+=(g&&":")+l.toString();
}}}}return j;}};var c=d.toJson(xml2json(a),a.nodeName,"\t");return"{\n"+b+(b?c.replace(/\t/g,b):c.replace(/\t|\n/g,""))+"\n}";}function EventDispatcherMgr(){}EventDispatcherMgr.put=function(a,b){EventDispatcherMgr._map[a]=b;};EventDispatcherMgr.getAllListenerInfo=function(){var d=new Array();for(var b in EventDispatcherMgr._map){var e=EventDispatcherMgr._map[b];
for(var c in e.listenerList){var a={"dispatcher_name":b,"listener_desc":e.listenerList[c].desc};d.push(a);}}return d;};EventDispatcherMgr.getAllDispatchInfo=function(){var d=new Array();for(var a in EventDispatcherMgr._map){var b=EventDispatcherMgr._map[a];var c={"name":a,"listener_count":b.listenerList.length};
d.push(c);}return d;};EventDispatcherMgr._map={};function EventDispatcher(a){if((!!!a)||(a=="")){var b="Fatal Error of EventDispatcher name cannot be null or blank. See PlugIn's commonUtil.js";try{throw new Error(b);}catch(c){log.error(c);throw c;}}this.listenerList=new Array();this.name=a;EventDispatcherMgr.put(a,this);
}EventDispatcher.prototype.addEventListener=function(c,b,d){var a={"listener":c,"data":b,"desc":d};this.listenerList.push(a);};EventDispatcher.prototype.dispatchEvent=function(a){for(var c in this.listenerList){try{if(!!this.listenerList[c].listener){this.listenerList[c].listener(a,this.listenerList[c].data);
}}catch(b){throw b;}}};EventDispatcher.prototype.removeEventListener=function(b){for(var a=0;a<this.listenerList.length;a++){if(this.listenerList[a].listener==b){this.listenerList.splice(a,1);break;}}};function QzTimerMgr(){}QzTimerMgr.maxId=0;QzTimerMgr.nextId=function(){QzTimerMgr.maxId++;return QzTimerMgr.maxId;
};QzTimerMgr.itemMap={};QzTimerMgr.keyTimeoutMap={};QzTimerMgr.getCurrentId=function(){return QzTimerMgr.maxId;};QzTimerMgr.getReportStr=function(){return JSON.stringify(QzTimerMgr.getReport());};QzTimerMgr.getReport=function(){var c={};for(var a in QzTimerMgr.itemMap){var b=QzTimerMgr.itemMap[a];c[a]=new QzTimeInfoItem(null,null,b.category,b.delayMiliSeconds,b.remark);
c[a].createTime=b.createTime;c[a].lastRunStartTime=b.lastRunStartTime;c[a].lastRunStopTime=b.lastRunStopTime;c[a].triggerCount=b.triggerCount;c[a].triggerSuccessCount=b.triggerSuccessCount;}return c;};function QzTimeInfoItem(e,b,c,a,d){this.timeHandle=e;this.jobFunction=b;this.category=c;this.delayMiliSeconds=a;
this.remark=d;this.createTime=new Date();this.lastRunStartTime=null;this.lastRunStopTime=null;this.triggerCount=0;this.triggerSuccessCount=0;this.uniqueKey=null;}QzTimerMgr.CATEGORY_TIMEOUT="timeout";QzTimerMgr.CATEGORY_INTERVAL="interval";QzTimerMgr.putInfoItem=function(a,b){QzTimerMgr.itemMap[a]=b;
};QzTimerMgr.removeInfoItem=function(b,a){var c=QzTimerMgr.itemMap[b+""];if(c){if(!a){if(c.category==QzTimerMgr.CATEGORY_TIMEOUT){clearTimeout(c.timeHandle);}else{clearInterval(c.timeHandle);}log.debug("QzTimerMgr.removeInfoItem real object deleted, key:"+b);}delete QzTimerMgr.itemMap[b+""];if(c.uniqueKey){delete QzTimerMgr.keyTimeoutMap[c.uniqueKey];
}}};QzTimerMgr.createInfoItem=function(f,b,d,a,e){var c=new QzTimeInfoItem(f,b,d,a,e);c.handleId=QzTimerMgr.nextId();QzTimerMgr.putInfoItem(c.handleId+"",c);return c;};QzTimerMgr.clearTimeoutByKey=function(a){var b=QzTimerMgr.keyTimeoutMap[a];if(b){QzTimerMgr.clearTimeout(b);}};QzTimerMgr.setTimeoutByKey=function(b,c,a){QzTimerMgr.clearTimeoutByKey(b);
var d=QzTimerMgr.setTimeout(c,a,b);d.uniqueKey=b;QzTimerMgr.keyTimeoutMap[b]=d;return d;};QzTimerMgr.setTimeout=function(b,a,e){if(!!!e){throw new Error("QzTimerMgr.setTimeout error of remark is NULL.");}var c=null;var d=setTimeout(function(){QzTimerMgr.doJobTrigger(c);},a);if(!!!d){throw new Error("QzTimerMgr.setTimeout error of setTimeout error, handle is NULL.");
}c=QzTimerMgr.createInfoItem(d,b,QzTimerMgr.CATEGORY_TIMEOUT,a,e);return c;};QzTimerMgr.doJobTrigger=function(a){if(!!!a){throw new Error("QzTimerMgr.doJobTrigger runtime error of infoItem is NULL.");}a.lastRunStartTime=null;a.lastRunStartTime=new Date();try{a.jobFunction();a.triggerSuccessCount++;}catch(b){log.error("QzTimerMgr.doJobTrigger runtime error."+"category:"+a.category+", remark is:"+a.remark+", exception:"+b);
}finally{QzTimerMgr.reportRunStop(a);}};QzTimerMgr.reportRunStop=function(b){if(b.category==QzTimerMgr.CATEGORY_INTERVAL){b.triggerCount++;b.lastRunStopTime=null;b.lastRunStopTime=new Date();}else{var a=true;QzTimerMgr.removeInfoItem(b.handleId,a);}};QzTimerMgr.clearTimeout=function(a){if(!!a){QzTimerMgr.removeInfoItem(a.handleId);
}else{log.error("QzTimerMgr.clearTimeout error of handleObject is NULL.");}};QzTimerMgr.setInterval=function(b,a,e){if(!!!e){throw new Error("QzTimerMgr.setInterval error of remark is NULL.");}var c=null;var d=setInterval(function(){QzTimerMgr.doJobTrigger(c);},a);if(!!!d){throw new Error("QzTimerMgr.setInterval error of setInterval error, handle is NULL.");
}c=QzTimerMgr.createInfoItem(d,b,QzTimerMgr.CATEGORY_INTERVAL,a,e);return c;};QzTimerMgr.clearInterval=function(a){if(!!a){QzTimerMgr.removeInfoItem(a.handleId);}else{log.error("QzTimerMgr.clearInterval handleObject is NULL.");}};function CommonReqMgr(){}CommonReqMgr.CALL_TIMEOUT_MILI_SECONDS=15000;CommonReqMgr._requestMap=new Object();
CommonReqMgr.getNextReqId=function(){return new UUID().id;};CommonReqMgr.putRequest=function(a,d,c,b){if(!d){throw new Error("Unexpected CommonReqMgr.putRequest @callback is NULL.");}CommonReqMgr._requestMap[a]={"requestId":a,"callback":d,"date":new Date()};CommonReqMgr._requestMap[a].timerInfoItem=QzTimerMgr.setTimeout(function(){var e=CommonReqMgr._requestMap[a];
if(e){try{if(c){c(a);}}finally{delete CommonReqMgr._requestMap[a];}}},b,"CommonReqMgr.putRequest for timeout");};CommonReqMgr.hasRequest=function(a){return(CommonReqMgr._requestMap[a]!=null);};CommonReqMgr.triggerCallback=function(c,a){log.debug("CommonReqMgr.triggerCallback start");var b=CommonReqMgr._requestMap[c];
if(b){try{if(b.callback){b.callback(a);}else{log.debug("CommonReqMgr.triggerCallback request has no callback function related. reqId:"+c);}}finally{delete CommonReqMgr._requestMap[c];}if(b.timerInfoItem){QzTimerMgr.removeInfoItem(b.timerInfoItem.handleId,false);}}log.debug("CommonReqMgr.triggerCallback stop");
};function SimpleApiTool(){}SimpleApiTool.getUcmBackGroundBaseUrl=function(){var a=getCookie("ucm_root");if(a==null||a==""){var a=window.location.href;var b=a.split("/");if(b.length>=3){return b[0]+"//"+b[2]+"/";}else{return a+"/";}}else{return a.replace(/\"/g,"");}};SimpleApiTool.sendCall=function(e,b,d,c){var a=SimpleApiTool.getUcmBackGroundBaseUrl()+e;
b.gt=getCookie("gt");b.r=getCookie("r");b.un=getCookie("un");$.ajax({type:"POST",url:a,data:b,contentType:"application/x-www-form-urlencoded; charset=utf-8",success:function(f){try{d(f);}catch(g){throw new Error("UCM call service finished, method is: "+a+", error when call back with msg:"+g);}},error:function(g,j,i){var f={};
try{f=JSON.parse(g.responseText);}catch(h){}if(c){c(g,f);}if(f.error_code==40006){log.error("身份验证过期，需要重新登录。");}else{if(!c){throw new Error("UCM call service error method: "+a+", with error msg:"+JSON.stringify(g));}}}});};function QzXmlTool(){}QzXmlTool.replaceXmlErrorChar=function(a,e){if(!e){e="?";
}a=a.replace(/&#00|&#01|&#02|&#03|&#04|&#05|&#06|&#07|&#08|&#11|&#12|&#14|&#15|&#16|&#17|&#18|&#19|&#20|&#21|&#22|&#23|&#24|&#25|&#26|&#27|&#28|&#29|&#30|&#31/g,e);var d="";for(var c=0;c<a.length;c++){var b=a.charCodeAt(c);if((b<32)&&(b>0)&&(b!=9)&&(b!=10)&&(b!=13)){d+=e;}else{d+=a.charAt(c);}}return d;
};QzXmlTool.rebuildXmlDocument=function(b){var b=QzXmlTool.replaceXmlErrorChar(b);var a=XmlDocument.create("doc");a.loadXML(b);var d=(new XMLSerializer()).serializeToString(a);var c=(d.length==b.length);if(c){return a;}else{return null;}};QzXmlTool.getChildTextContentByName=function(a,b){var c=a.getElementsByTagName(b);
if(c.length>0){var d=c[0];var e=d.firstChild;if(e&&e.data){return e.data;}else{return"";}}else{if(b.toLowerCase()==b){return"";}else{return QzXmlTool.getChildTextContentByName(a,b.toLowerCase());}}};QzXmlTool.getChildByNameAndNameSpace=function(b,c,a){var e=b.getElementsByTagName(c);if(e.length>0){for(var d=0;
d<e.length;d++){var f=e[d];if(a){if(f.namespaceURI==a||f.getAttribute("xmlns")==a){return f;}}else{return f;}}}};QzXmlTool.getChildByNameAndNameSpaceWithFilter=function(a,b,f){var d=a.getElementsByTagName(b);if(d.length>0){for(var c=0;c<d.length;c++){var e=d[c];if(f&&f(e)){return e;}}}return null;};QzXmlTool.getChildAttributeByName=function(a,c,b){var d=a.getElementsByTagName(c);
if(d.length>0){var e=d[0];return e.getAttribute(b);}else{if(c.toLowerCase()==c){return"";}else{return QzXmlTool.getChildAttributeByName(a,c.toLowerCase(),b);}}};function SimpleXCrossBrowser(){}SimpleXCrossBrowser.OPERA="OPERA";SimpleXCrossBrowser.CHROME="CHROME";SimpleXCrossBrowser.MSIE="MSIE";SimpleXCrossBrowser.FF="FIREFOX";
SimpleXCrossBrowser.SAFARI="SAFARI";SimpleXCrossBrowser.getBroswerType=function(){if((navigator.userAgent.indexOf("MSIE")>=0)&&(navigator.userAgent.indexOf("Opera")<0)){return SimpleXCrossBrowser.MSIE;}else{if(navigator.userAgent.indexOf("Firefox")>=0){return SimpleXCrossBrowser.FF;}else{if(navigator.userAgent.indexOf("Opera")>=0){return SimpleXCrossBrowser.OPERA;
}else{if(navigator.userAgent.indexOf("Chrome")>=0){return SimpleXCrossBrowser.CHROME;}else{if(navigator.userAgent.indexOf("Safari")>=0){if(window.webkitRTCPeerConnection){return SimpleXCrossBrowser.CHROME;}return SimpleXCrossBrowser.SAFARI;}else{return SimpleXCrossBrowser.MSIE;}}}}}};if(SimpleXCrossBrowser.getBroswerType()==SimpleXCrossBrowser.CHROME){SimpleXCrossBrowser.isChrome=true;
}else{if(SimpleXCrossBrowser.getBroswerType()==SimpleXCrossBrowser.FF){SimpleXCrossBrowser.isFirefox=true;}else{if(SimpleXCrossBrowser.getBroswerType()==SimpleXCrossBrowser.MSIE){SimpleXCrossBrowser.isMSIE=true;}}}function DateTimeUtils(){}DateTimeUtils.parseNumTocaPitalLetter=function(a){switch(a){case 1:return"一";
break;case 2:return"二";break;case 3:return"三";break;case 4:return"四";break;case 5:return"五";break;case 6:return"六";break;case 0:return"日";break;}};DateTimeUtils.addZeroPrefixToNumber=function(a){if(!a&&a!=0){return"";}else{if(a<10){return"0"+a;}else{return a+"";}}};DateTimeUtils.getUtcDateTime=function(j,i){var c=j.split("T");
if(c.length<2){c=j.split(" ");}var l=c[0].split("-")[0];var k=c[0].split("-")[1];var n=c[0].split("-")[2];var g=strToInt(c[1].split(":")[0]);var d=c[1].split(":")[1];var r=c[1].split(":")[2].substring(0,2);var e=i.substring(0,1);var b=parseInt(i.substring(1,3));var o=parseInt(i.substring(4,6));var q=(b*3600+o*60)*1000;
var f=new Date(l,k-1,n,g,d,r);var a=f.getTime();var p=0;if(e="+"){p=a-q;}else{p=a+q;}return p;};DateTimeUtils.getCurrUtcDateTime=function(){var a=new Date();localTime=a.getTime();localOffset=a.getTimezoneOffset()*60000;utc=localTime+localOffset;return utc;};DateTimeUtils.getDayOfWeek=function(a){return"星期"+DateTimeUtils.parseNumTocaPitalLetter(a.getDay());
};DateTimeUtils.getBeautifulDayOfWeekByNow=function(a,e){a.setHours(0,0,0,0);e.setHours(0,0,0,0);var c=e-a;var g=parseInt(c/(24*3600*1000));var h=DateTimeUtils.diffWeek(a,e);var f=DateTimeUtils.parseNumTocaPitalLetter(e.getDay());var b="";var d="";if(g==0){b="今天";}else{if(g==1){b="明天";}else{if(g==2){b="后天";
}else{if(g==-1){b="昨天";}else{if(g==-2){b="前天";}}}}}if(b){d="周";}else{if(h==-1){d="上周";}else{if(h==0){d="本周";}else{if(h==1){d="下周";}else{d="周";}}}}var i="";if(g==0){i=b+"(周"+f+")";}else{if(!!b){i=b+"("+d+f+")";}else{i=d+f;}}return i;};DateTimeUtils.diffWeek=function(e,d){var a=1000*3600*24;var b=parseInt(e.getTime()/a);
var c=parseInt(d.getTime()/a);return parseInt((c+4)/7)-parseInt((b+4)/7);};DateTimeUtils.beautifulTimeAtMinute=function(d){var c="";var b=parseInt(d/3600);var a=parseInt(d%3600/60);if(b>0){c=b+"小时"+parseInt(d%3600/60)+"分";}else{if(a>0){c=a+"分钟";}else{c="小于1分钟";}}return c;};DateTimeUtils.beautifulTimeAtSecond=function(e,f){e=!!e?e:0;
var d="";var c=Math.floor(e/3600);var a=Math.floor(e%3600/60);var b=Math.round(e%60);if(f==null){f="";}if(c>0){d=c+f+"小时"+f+DateTimeUtils.addZeroPrefixToNumber(a)+f+"分"+f+DateTimeUtils.addZeroPrefixToNumber(b)+f+"秒";}else{if(a>0){d=a+f+"分"+f+DateTimeUtils.addZeroPrefixToNumber(b)+f+"秒";}else{d=b+f+"秒";
}}return d;};function dateFormat(b,c){var d={"M+":b.getMonth()+1,"d+":b.getDate(),"h+":b.getHours(),"m+":b.getMinutes(),"s+":b.getSeconds(),"q+":Math.floor((b.getMonth()+3)/3),"S":b.getMilliseconds()};if(/(Y+)/.test(c)){c=c.replace(RegExp.$1,(b.getFullYear()+"").substr(4-RegExp.$1.length));}for(var a in d){if(new RegExp("("+a+")").test(c)){c=c.replace(RegExp.$1,RegExp.$1.length==1?d[a]:("00"+d[a]).substr((""+d[a]).length));
}}return c;}window.dateFormat2=dateFormat;function html2text(a){return html2Text(a);}function html2Text(a){a=!!!a?"":a;a=html2TextWithoutCRLN(a);a=html2TextOnlyCRLN(a);return a;}function html2TextWithoutCRLN(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/ /g,"&nbsp;");
a=a.replace(/'/g,"&apos;");a=a.replace(/"/g,"&quot;");return a;}function html2TextOnlyCRLN(a){a=a.replace(/\n/g,"<br>");return a;}function UUID(){this.id=this.createUUID();}UUID.prototype.valueOf=function(){return this.id;};UUID.prototype.toString=function(){return this.id;};UUID.prototype.createUUID=function(){var c=new Date(1582,10,15,0,0,0,0);
var f=new Date();var h=f.getTime()-c.getTime();var i=UUID.getIntegerBits(h,0,31);var g=UUID.getIntegerBits(h,32,47);var e=UUID.getIntegerBits(h,48,59)+"1";var b=UUID.getIntegerBits(UUID.rand(4095),0,7);var d=UUID.getIntegerBits(UUID.rand(4095),0,7);var a=UUID.getIntegerBits(UUID.rand(8191),0,7)+UUID.getIntegerBits(UUID.rand(8191),8,15)+UUID.getIntegerBits(UUID.rand(8191),0,7)+UUID.getIntegerBits(UUID.rand(8191),8,15)+UUID.getIntegerBits(UUID.rand(8191),0,15);
return i+g+e+b+d+a;};UUID.getIntegerBits=function(f,g,b){var a=UUID.returnBase(f,16);var d=new Array();var e="";var c=0;for(c=0;c<a.length;c++){d.push(a.substring(c,c+1));}for(c=Math.floor(g/4);c<=Math.floor(b/4);c++){if(!d[c]||d[c]==""){e+="0";}else{e+=d[c];}}return e;};UUID.returnBase=function(a,b){return(a).toString(b).toUpperCase();
};UUID.rand=function(a){return Math.floor(Math.random()*(a+1));};function uuid(a,d){var f="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");var c=[],b;d=d||f.length;if(a){for(b=0;b<a;b++){c[b]=f[0|Math.random()*d];}}else{var e;c[8]=c[13]=c[18]=c[23]="-";c[14]="4";for(b=0;b<36;
b++){if(!c[b]){e=0|Math.random()*16;c[b]=f[(b==19)?(e&3)|8:e];}}}return c.join("");}function MediaPlayer(){this.dom=null;}MediaPlayer.uiMode={Full:"full",Mini:"mini",None:"none",Invisible:"invisible"};MediaPlayer.prototype={CreateAt:function(b){this.dom=document.createElement("object");this.dom.classid="CLSID:6BF52A52-394A-11d3-B153-00C04F79FAA6";
this.dom.style.width="100%";this.dom.style.height="100%";var a=document.getElementById(b);a.innerHTML="";a.appendChild(this.dom);this._Init();},BindID:function(a){this.dom=document.getElementById(a);this._Init();},_Init:function(){var a=this;$(this.dom).bind("PlayStateChange",function(b){a.onPlayStateChange(b);
});$(this.dom).bind("Buffering",function(b){a.onBuffering(b);});$(this.dom).bind("Error",function(){a.onError();});$(this.dom).bind("PositionChange",function(b,c){a.onPositionChange(b,c);});$(this.dom).bind("StatusChange",function(){a.onStatusChange();});},onPlayStateChange:function(a){switch(a){case 1:this.onStop();
break;case 2:this.onPaused();break;case 3:this.onPlay();break;case 4:break;case 5:break;case 6:this.onBuffering_SC();break;case 7:break;case 8:this.onMediaEnded();break;case 9:this.onTransitioning();break;case 10:break;case 11:break;case 12:break;case 0:break;default:break;}},onStop:function(){},onPaused:function(){},onPlay:function(){},onBuffering_SC:function(){},onTransitioning:function(){},onMediaEnded:function(){},onError:function(){},onPositionChange:function(a,b){},onStatusChange:function(){},onBuffering:function(a){},setMode:function(a){this.dom.uiMode=a;
},setVolume:function(a){this.dom.settings.volume=a;},getMediaName:function(){var a=this.dom.currentMedia;if(a){return a.name;}return"";},getMediaDuration:function(){var a=this.dom.currentMedia;if(a){return a.duration;}return"";},getMediaDurationString:function(){var a=this.dom.currentMedia;if(a){return a.durationString;
}return"";},getStatus:function(){return this.dom.status;},getPosition:function(){return this.dom.controls.currentPosition;},getPositionString:function(){return this.dom.controls.currentPositionString;},getPlayState:function(){return this.dom.playState;},OpenUrl:function(a){this.dom.playCount=999;this.dom.URL=a;
},Play:function(){this.dom.controls.play();},Pause:function(){this.dom.controls.pause();},Stop:function(){this.dom.controls.stop();}};JSJAC_HAVEKEYS=true;JSJAC_NKEYS=16;JSJAC_INACTIVITY=300;JSJAC_ERR_COUNT=10;JSJAC_ALLOW_PLAIN=true;JSJAC_CHECKQUEUEINTERVAL=200;JSJAC_CHECKINQUEUEINTERVAL=200;JSJAC_TIMERVAL=2000;
JSJACHBC_MAX_HOLD=1;JSJACHBC_MAX_WAIT=300;JSJACHBC_BOSH_VERSION="1.6";JSJACHBC_USE_BOSH_VER=true;JSJACHBC_MAXPAUSE=120;String.prototype.htmlEnc=function(){var a=this.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/\"/g,"&quot;");a=a.replace(/\n/g,"<br />");return a;
};Date.jab2date=function(b){var a=new Date(Date.UTC(b.substr(0,4),b.substr(5,2)-1,b.substr(8,2),b.substr(11,2),b.substr(14,2),b.substr(17,2)));if(b.substr(b.length-6,1)!="Z"){var c=new Date();c.setTime(0);c.setUTCHours(b.substr(b.length-5,2));c.setUTCMinutes(b.substr(b.length-2,2));if(b.substr(b.length-6,1)=="+"){a.setTime(a.getTime()-c.getTime());
}else{if(b.substr(b.length-6,1)=="-"){a.setTime(a.getTime()+c.getTime());}}}return a;};Date.hrTime=function(a){return Date.jab2date(a).toLocaleString();};Date.prototype.jabberDate=function(){var b=function(c){if(c<10){return"0"+c;}return c;};var a=this.getUTCFullYear()+"-";a+=b(this.getUTCMonth()+1)+"-";
a+=b(this.getUTCDate())+"T";a+=b(this.getUTCHours())+":";a+=b(this.getUTCMinutes())+":";a+=b(this.getUTCSeconds())+"Z";return a;};Number.max=function(a,b){return(a>b)?a:b;};Number.min=function(a,b){return(a<b)?a:b;};var hexcase=0;var b64pad="=";var chrsz=8;function hex_sha1(a){return binb2hex(core_sha1(str2binb(a),a.length*chrsz));
}function b64_sha1(a){return binb2b64(core_sha1(str2binb(a),a.length*chrsz));}function str_sha1(a){return binb2str(core_sha1(str2binb(a),a.length*chrsz));}function hex_hmac_sha1(a,b){return binb2hex(core_hmac_sha1(a,b));}function b64_hmac_sha1(a,b){return binb2b64(core_hmac_sha1(a,b));}function str_hmac_sha1(a,b){return binb2str(core_hmac_sha1(a,b));
}function sha1_vm_test(){return hex_sha1("abc")=="a9993e364706816aba3e25717850c26c9cd0d89d";}function core_sha1(v,o){v[o>>5]|=128<<(24-o%32);v[((o+64>>9)<<4)+15]=o;var y=Array(80);var u=1732584193;var s=-271733879;var r=-1732584194;var q=271733878;var p=-1009589776;for(var l=0;l<v.length;l+=16){var n=u;
var m=s;var k=r;var h=q;var f=p;for(var g=0;g<80;g++){if(g<16){y[g]=v[l+g];}else{y[g]=rol(y[g-3]^y[g-8]^y[g-14]^y[g-16],1);}var z=safe_add(safe_add(rol(u,5),sha1_ft(g,s,r,q)),safe_add(safe_add(p,y[g]),sha1_kt(g)));p=q;q=r;r=rol(s,30);s=u;u=z;}u=safe_add(u,n);s=safe_add(s,m);r=safe_add(r,k);q=safe_add(q,h);
p=safe_add(p,f);}return Array(u,s,r,q,p);}function sha1_ft(e,a,g,f){if(e<20){return(a&g)|((~a)&f);}if(e<40){return a^g^f;}if(e<60){return(a&g)|(a&f)|(g&f);}return a^g^f;}function sha1_kt(a){return(a<20)?1518500249:(a<40)?1859775393:(a<60)?-1894007588:-899497514;}function core_hmac_sha1(c,f){var e=str2binb(c);
if(e.length>16){e=core_sha1(e,c.length*chrsz);}var a=Array(16),d=Array(16);for(var b=0;b<16;b++){a[b]=e[b]^909522486;d[b]=e[b]^1549556828;}var g=core_sha1(a.concat(str2binb(f)),512+f.length*chrsz);return core_sha1(d.concat(g),512+160);}function rol(a,b){return(a<<b)|(a>>>(32-b));}function str2binb(d){var c=Array();
var a=(1<<chrsz)-1;for(var b=0;b<d.length*chrsz;b+=chrsz){c[b>>5]|=(d.charCodeAt(b/chrsz)&a)<<(32-chrsz-b%32);}return c;}function binb2str(c){var d="";var a=(1<<chrsz)-1;for(var b=0;b<c.length*32;b+=chrsz){d+=String.fromCharCode((c[b>>5]>>>(32-chrsz-b%32))&a);}return d;}function binb2hex(c){var b=hexcase?"0123456789ABCDEF":"0123456789abcdef";
var d="";for(var a=0;a<c.length*4;a++){d+=b.charAt((c[a>>2]>>((3-a%4)*8+4))&15)+b.charAt((c[a>>2]>>((3-a%4)*8))&15);}return d;}function binb2b64(d){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var f="";for(var b=0;b<d.length*4;b+=3){var e=(((d[b>>2]>>8*(3-b%4))&255)<<16)|(((d[b+1>>2]>>8*(3-(b+1)%4))&255)<<8)|((d[b+2>>2]>>8*(3-(b+2)%4))&255);
for(var a=0;a<4;a++){if(b*8+a*6>d.length*32){f+=b64pad;}else{f+=c.charAt((e>>6*(3-a))&63);}}}return f.replace(/AAA\=(\=*?)$/,"$1");}function hex_md5(a){return binl2hex(core_md5(str2binl(a),a.length*chrsz));}function b64_md5(a){return binl2b64(core_md5(str2binl(a),a.length*chrsz));}function str_md5(a){return binl2str(core_md5(str2binl(a),a.length*chrsz));
}function hex_hmac_md5(a,b){return binl2hex(core_hmac_md5(a,b));}function b64_hmac_md5(a,b){return binl2b64(core_hmac_md5(a,b));}function str_hmac_md5(a,b){return binl2str(core_hmac_md5(a,b));}function md5_vm_test(){return hex_md5("abc")=="900150983cd24fb0d6963f7d28e17f72";}function core_md5(p,k){p[k>>5]|=128<<((k)%32);
p[(((k+64)>>>9)<<4)+14]=k;var o=1732584193;var n=-271733879;var m=-1732584194;var l=271733878;for(var g=0;g<p.length;g+=16){var j=o;var h=n;var f=m;var e=l;o=md5_ff(o,n,m,l,p[g+0],7,-680876936);l=md5_ff(l,o,n,m,p[g+1],12,-389564586);m=md5_ff(m,l,o,n,p[g+2],17,606105819);n=md5_ff(n,m,l,o,p[g+3],22,-1044525330);
o=md5_ff(o,n,m,l,p[g+4],7,-176418897);l=md5_ff(l,o,n,m,p[g+5],12,1200080426);m=md5_ff(m,l,o,n,p[g+6],17,-1473231341);n=md5_ff(n,m,l,o,p[g+7],22,-45705983);o=md5_ff(o,n,m,l,p[g+8],7,1770035416);l=md5_ff(l,o,n,m,p[g+9],12,-1958414417);m=md5_ff(m,l,o,n,p[g+10],17,-42063);n=md5_ff(n,m,l,o,p[g+11],22,-1990404162);
o=md5_ff(o,n,m,l,p[g+12],7,1804603682);l=md5_ff(l,o,n,m,p[g+13],12,-40341101);m=md5_ff(m,l,o,n,p[g+14],17,-1502002290);n=md5_ff(n,m,l,o,p[g+15],22,1236535329);o=md5_gg(o,n,m,l,p[g+1],5,-165796510);l=md5_gg(l,o,n,m,p[g+6],9,-1069501632);m=md5_gg(m,l,o,n,p[g+11],14,643717713);n=md5_gg(n,m,l,o,p[g+0],20,-373897302);
o=md5_gg(o,n,m,l,p[g+5],5,-701558691);l=md5_gg(l,o,n,m,p[g+10],9,38016083);m=md5_gg(m,l,o,n,p[g+15],14,-660478335);n=md5_gg(n,m,l,o,p[g+4],20,-405537848);o=md5_gg(o,n,m,l,p[g+9],5,568446438);l=md5_gg(l,o,n,m,p[g+14],9,-1019803690);m=md5_gg(m,l,o,n,p[g+3],14,-187363961);n=md5_gg(n,m,l,o,p[g+8],20,1163531501);
o=md5_gg(o,n,m,l,p[g+13],5,-1444681467);l=md5_gg(l,o,n,m,p[g+2],9,-51403784);m=md5_gg(m,l,o,n,p[g+7],14,1735328473);n=md5_gg(n,m,l,o,p[g+12],20,-1926607734);o=md5_hh(o,n,m,l,p[g+5],4,-378558);l=md5_hh(l,o,n,m,p[g+8],11,-2022574463);m=md5_hh(m,l,o,n,p[g+11],16,1839030562);n=md5_hh(n,m,l,o,p[g+14],23,-35309556);
o=md5_hh(o,n,m,l,p[g+1],4,-1530992060);l=md5_hh(l,o,n,m,p[g+4],11,1272893353);m=md5_hh(m,l,o,n,p[g+7],16,-155497632);n=md5_hh(n,m,l,o,p[g+10],23,-1094730640);o=md5_hh(o,n,m,l,p[g+13],4,681279174);l=md5_hh(l,o,n,m,p[g+0],11,-358537222);m=md5_hh(m,l,o,n,p[g+3],16,-722521979);n=md5_hh(n,m,l,o,p[g+6],23,76029189);
o=md5_hh(o,n,m,l,p[g+9],4,-640364487);l=md5_hh(l,o,n,m,p[g+12],11,-421815835);m=md5_hh(m,l,o,n,p[g+15],16,530742520);n=md5_hh(n,m,l,o,p[g+2],23,-995338651);o=md5_ii(o,n,m,l,p[g+0],6,-198630844);l=md5_ii(l,o,n,m,p[g+7],10,1126891415);m=md5_ii(m,l,o,n,p[g+14],15,-1416354905);n=md5_ii(n,m,l,o,p[g+5],21,-57434055);
o=md5_ii(o,n,m,l,p[g+12],6,1700485571);l=md5_ii(l,o,n,m,p[g+3],10,-1894986606);m=md5_ii(m,l,o,n,p[g+10],15,-1051523);n=md5_ii(n,m,l,o,p[g+1],21,-2054922799);o=md5_ii(o,n,m,l,p[g+8],6,1873313359);l=md5_ii(l,o,n,m,p[g+15],10,-30611744);m=md5_ii(m,l,o,n,p[g+6],15,-1560198380);n=md5_ii(n,m,l,o,p[g+13],21,1309151649);
o=md5_ii(o,n,m,l,p[g+4],6,-145523070);l=md5_ii(l,o,n,m,p[g+11],10,-1120210379);m=md5_ii(m,l,o,n,p[g+2],15,718787259);n=md5_ii(n,m,l,o,p[g+9],21,-343485551);o=safe_add(o,j);n=safe_add(n,h);m=safe_add(m,f);l=safe_add(l,e);}return Array(o,n,m,l);}function md5_cmn(h,e,d,c,g,f){return safe_add(bit_rol(safe_add(safe_add(e,h),safe_add(c,f)),g),d);
}function md5_ff(g,f,k,j,e,i,h){return md5_cmn((f&k)|((~f)&j),g,f,e,i,h);}function md5_gg(g,f,k,j,e,i,h){return md5_cmn((f&j)|(k&(~j)),g,f,e,i,h);}function md5_hh(g,f,k,j,e,i,h){return md5_cmn(f^k^j,g,f,e,i,h);}function md5_ii(g,f,k,j,e,i,h){return md5_cmn(k^(f|(~j)),g,f,e,i,h);}function core_hmac_md5(c,f){var e=str2binl(c);
if(e.length>16){e=core_md5(e,c.length*chrsz);}var a=Array(16),d=Array(16);for(var b=0;b<16;b++){a[b]=e[b]^909522486;d[b]=e[b]^1549556828;}var g=core_md5(a.concat(str2binl(f)),512+f.length*chrsz);return core_md5(d.concat(g),512+128);}function safe_add(a,d){var c=(a&65535)+(d&65535);var b=(a>>16)+(d>>16)+(c>>16);
return(b<<16)|(c&65535);}function bit_rol(a,b){return(a<<b)|(a>>>(32-b));}function str2binl(d){var c=Array();var a=(1<<chrsz)-1;for(var b=0;b<d.length*chrsz;b+=chrsz){c[b>>5]|=(d.charCodeAt(b/chrsz)&a)<<(b%32);}return c;}function binl2str(c){var d="";var a=(1<<chrsz)-1;for(var b=0;b<c.length*32;b+=chrsz){d+=String.fromCharCode((c[b>>5]>>>(b%32))&a);
}return d;}function binl2hex(c){var b=hexcase?"0123456789ABCDEF":"0123456789abcdef";var d="";for(var a=0;a<c.length*4;a++){d+=b.charAt((c[a>>2]>>((a%4)*8+4))&15)+b.charAt((c[a>>2]>>((a%4)*8))&15);}return d;}function binl2b64(d){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
var f="";for(var b=0;b<d.length*4;b+=3){var e=(((d[b>>2]>>8*(b%4))&255)<<16)|(((d[b+1>>2]>>8*((b+1)%4))&255)<<8)|((d[b+2>>2]>>8*((b+2)%4))&255);for(var a=0;a<4;a++){if(b*8+a*6>d.length*32){f+=b64pad;}else{f+=c.charAt((e>>6*(3-a))&63);}}}return f;}function utf8t2d(a){a=a.replace(/\r\n/g,"\n");var b=new Array;
var g=String.fromCharCode(237);if(g.charCodeAt(0)<0){for(var f=0;f<a.length;f++){var e=a.charCodeAt(f);if(e>0){b[b.length]=e;}else{b[b.length]=(((256+e)>>6)|192);b[b.length]=(((256+e)&63)|128);}}}else{for(var f=0;f<a.length;f++){var e=a.charCodeAt(f);if(e<128){b[b.length]=e;}else{if((e>127)&&(e<2048)){b[b.length]=((e>>6)|192);
b[b.length]=((e&63)|128);}else{b[b.length]=((e>>12)|224);b[b.length]=(((e>>6)&63)|128);b[b.length]=((e&63)|128);}}}}return b;}function utf8d2t(c){var b=new Array;var a=0;while(a<c.length){if(c[a]<128){b[b.length]=String.fromCharCode(c[a]);a++;}else{if((c[a]>191)&&(c[a]<224)){b[b.length]=String.fromCharCode(((c[a]&31)<<6)|(c[a+1]&63));
a+=2;}else{b[b.length]=String.fromCharCode(((c[a]&15)<<12)|((c[a+1]&63)<<6)|(c[a+2]&63));a+=3;}}}return b.join("");}function b64arrays(){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b64=new Array();f64=new Array();for(var a=0;a<b.length;a++){b64[a]=b.charAt(a);f64[b.charAt(a)]=a;
}}function b64d2t(f){var e=new Array;var c=0;var a=f.length;if((a%3)==1){f[f.length]=0;f[f.length]=0;}if((a%3)==2){f[f.length]=0;}while(c<f.length){e[e.length]=b64[f[c]>>2];e[e.length]=b64[((f[c]&3)<<4)|(f[c+1]>>4)];e[e.length]=b64[((f[c+1]&15)<<2)|(f[c+2]>>6)];e[e.length]=b64[f[c+2]&63];c+=3;}if((a%3)==1){e[e.length-1]=e[e.length-2]="=";
}if((a%3)==2){e[e.length-1]="=";}var b=e.join("");return b;}function b64t2d(b){var c=new Array;var a=0;b=b.replace(/\n|\r/g,"");b=b.replace(/=/g,"");while(a<b.length){c[c.length]=(f64[b.charAt(a)]<<2)|(f64[b.charAt(a+1)]>>4);c[c.length]=(((f64[b.charAt(a+1)]&15)<<4)|(f64[b.charAt(a+2)]>>2));c[c.length]=(((f64[b.charAt(a+2)]&3)<<6)|(f64[b.charAt(a+3)]));
a+=4;}if(b.length%4==2){c=c.slice(0,c.length-2);}if(b.length%4==3){c=c.slice(0,c.length-1);}return c;}if(typeof(atob)=="undefined"||typeof(btoa)=="undefined"){b64arrays();}if(typeof(atob)=="undefined"){atob=function(a){return utf8d2t(b64t2d(a));};}if(typeof(btoa)=="undefined"){btoa=function(a){return b64d2t(utf8t2d(a));
};}function cnonce(b){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var d="";for(var a=0;a<b;a++){d+=c.charAt(Math.round(Math.random(new Date().getTime())*(c.length-1)));}return d;}function JSJaCJSON(){}JSJaCJSON.toString=function(c){var a={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},b={array:function(g){var j=["["],d,n,m,h=g.length,k;
for(m=0;m<h;m+=1){k=g[m];n=b[typeof k];if(n){try{k=n(k);if(typeof k=="string"){if(d){j[j.length]=",";}j[j.length]=k;d=true;}}catch(o){}}}j[j.length]="]";return j.join("");},"boolean":function(d){return String(d);},"null":function(d){return"null";},number:function(d){return isFinite(d)?String(d):"null";
},object:function(g){if(g){if(g instanceof Array){return b.array(g);}var h=["{"],d,l,k,j;for(k in g){if(g.hasOwnProperty(k)){j=g[k];l=b[typeof j];if(l){try{j=l(j);if(typeof j=="string"){if(d){h[h.length]=",";}h.push(b.string(k),":",j);d=true;}}catch(m){}}}}h[h.length]="}";return h.join("");}return"null";
},string:function(d){if(/["\\\x00-\x1f]/.test(d)){d=d.replace(/([\x00-\x1f\\"])/g,function(f,e){var g=a[e];if(g){return g;}g=e.charCodeAt();return"\\u00"+Math.floor(g/16).toString(16)+(g%16).toString(16);});}return'"'+d+'"';}};switch(typeof(c)){case"object":return b.object(c);case"array":return b.array(c);
}};JSJaCJSON.parse=function(str){try{return !(/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(str.replace(/"(\\.|[^"\\])*"/g,"")))&&eval("("+str+")");}catch(e){return false;}};function XmlHttp(){}XmlHttp.create=function(){try{if(window.XMLHttpRequest){var b=new XMLHttpRequest();if(b.readyState==null){b.readyState=1;
b.addEventListener("load",function(){b.readyState=4;if(typeof b.onreadystatechange=="function"){b.onreadystatechange();}},false);}return b;}if(window.ActiveXObject){return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp");}}catch(a){}throw new Error("Your browser does not support XmlHttp objects");};
XmlHttp.getPrefix=function(){if(XmlHttp.prefix){return XmlHttp.prefix;}var c=["MSXML2","Microsoft","MSXML","MSXML3"];var d;for(var b=0;b<c.length;b++){try{d=new ActiveXObject(c[b]+".XmlHttp");return XmlHttp.prefix=c[b];}catch(a){}}throw new Error("Could not find an installed XML parser");};function XmlDocument(){}XmlDocument.create=function(b,d){b=b||"foo";
d=d||"";try{var e;if(document.implementation&&document.implementation.createDocument){e=document.implementation.createDocument(d,b,null);if(e.readyState==null){e.readyState=1;e.addEventListener("load",function(){e.readyState=4;if(typeof e.onreadystatechange=="function"){e.onreadystatechange();}},false);
}}else{if(window.ActiveXObject){e=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument");}}if(!e.documentElement||e.documentElement.tagName!=b||(e.documentElement.namespaceURI&&e.documentElement.namespaceURI!=d)){try{if(d!=""){e.appendChild(e.createElement(b)).setAttribute("xmlns",d);}else{e.appendChild(e.createElement(b));
}}catch(a){e=document.implementation.createDocument(d,b,null);if(e.documentElement==null){e.appendChild(e.createElement(b));}if(d!=""&&e.documentElement.getAttribute("xmlns")!=d){e.documentElement.setAttribute("xmlns",d);}}}return e;}catch(c){}throw new Error("Your browser does not support XmlDocument objects");
};XmlDocument.getPrefix=function(){if(XmlDocument.prefix){return XmlDocument.prefix;}var c=["MSXML2","Microsoft","MSXML","MSXML3"];var d;for(var b=0;b<c.length;b++){try{d=new ActiveXObject(c[b]+".DomDocument");return XmlDocument.prefix=c[b];}catch(a){}}throw new Error("Could not find an installed XML parser");
};if(typeof(Document)!="undefined"&&window.DOMParser){Document.prototype.loadXML=function(b){var c=(new DOMParser()).parseFromString(b,"text/xml");while(this.hasChildNodes()){this.removeChild(this.lastChild);}for(var a=0;a<c.childNodes.length;a++){this.appendChild(this.importNode(c.childNodes[a],true));
}};}if(window.XMLSerializer&&window.Node&&Node.prototype&&Node.prototype.__defineGetter__){XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer()).serializeToString(this);});Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer()).serializeToString(this);
});Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer()).serializeToString(this);});}var JSJaCBuilder={buildNode:function(d,a){var b,c=arguments[4];if(arguments[2]){if(JSJaCBuilder._isStringOrNumber(arguments[2])||(arguments[2] instanceof Array)){b=this._createElement(d,a,c);JSJaCBuilder._children(d,b,arguments[2]);
}else{c=arguments[2]["xmlns"]||c;b=this._createElement(d,a,c);for(attr in arguments[2]){if(arguments[2].hasOwnProperty(attr)&&attr!="xmlns"){b.setAttribute(attr,arguments[2][attr]);}}}}else{b=this._createElement(d,a,c);}if(arguments[3]){JSJaCBuilder._children(d,b,arguments[3],c);}return b;},_createElement:function(e,a,d){try{if(d){return e.createElementNS(d,a);
}}catch(b){}var c=e.createElement(a);if(d){c.setAttribute("xmlns",d);}return c;},createElement:function(c,a,b){return JSJaCBuilder._createElement(c,a,b);},_text:function(a,b){return a.createTextNode(b);},_children:function(h,c,b,d){if(typeof b=="object"){for(var a in b){if(b.hasOwnProperty(a)){var g=b[a];
if(typeof g=="object"){if(g instanceof Array){var f=JSJaCBuilder.buildNode(h,g[0],g[1],g[2],d);c.appendChild(f);}else{c.appendChild(g);}}else{if(JSJaCBuilder._isStringOrNumber(g)){c.appendChild(JSJaCBuilder._text(h,g));}}}}}else{if(JSJaCBuilder._isStringOrNumber(b)){c.appendChild(JSJaCBuilder._text(h,b));
}}},_attributes:function(a){var b=[];for(attribute in a){if(a.hasOwnProperty(attribute)){b.push(attribute+'="'+a[attribute].toString().htmlEnc()+'"');}}return b.join(" ");},_isStringOrNumber:function(a){return(typeof a=="string"||typeof a=="number");}};var NS_DISCO_ITEMS="http://jabber.org/protocol/disco#items";
var NS_DISCO_INFO="http://jabber.org/protocol/disco#info";var NS_VCARD="vcard-temp";var NS_AUTH="jabber:iq:auth";var NS_AUTH_ERROR="jabber:iq:auth:error";var NS_REGISTER="jabber:iq:register";var NS_SEARCH="jabber:iq:search";var NS_ROSTER="jabber:iq:roster";var NS_PRIVACY="jabber:iq:privacy";var NS_PRIVATE="jabber:iq:private";
var NS_VERSION="jabber:iq:version";var NS_TIME="jabber:iq:time";var NS_LAST="jabber:iq:last";var NS_XDATA="jabber:x:data";var NS_IQDATA="jabber:iq:data";var NS_DELAY="jabber:x:delay";var NS_EXPIRE="jabber:x:expire";var NS_EVENT="jabber:x:event";var NS_XCONFERENCE="jabber:x:conference";var NS_STATS="http://jabber.org/protocol/stats";
var NS_MUC="http://jabber.org/protocol/muc";var NS_MUC_USER="http://jabber.org/protocol/muc#user";var NS_MUC_ADMIN="http://jabber.org/protocol/muc#admin";var NS_MUC_OWNER="http://jabber.org/protocol/muc#owner";var NS_PUBSUB="http://jabber.org/protocol/pubsub";var NS_PUBSUB_EVENT="http://jabber.org/protocol/pubsub#event";
var NS_PUBSUB_OWNER="http://jabber.org/protocol/pubsub#owner";var NS_PUBSUB_NMI="http://jabber.org/protocol/pubsub#node-meta-info";var NS_COMMANDS="http://jabber.org/protocol/commands";var NS_STREAM="http://etherx.jabber.org/streams";var NS_STANZAS="urn:ietf:params:xml:ns:xmpp-stanzas";var NS_STREAMS="urn:ietf:params:xml:ns:xmpp-streams";
var NS_TLS="urn:ietf:params:xml:ns:xmpp-tls";var NS_SASL="urn:ietf:params:xml:ns:xmpp-sasl";var NS_SESSION="urn:ietf:params:xml:ns:xmpp-session";var NS_BIND="urn:ietf:params:xml:ns:xmpp-bind";var NS_FEATURE_IQAUTH="http://jabber.org/features/iq-auth";var NS_FEATURE_IQREGISTER="http://jabber.org/features/iq-register";
var NS_FEATURE_COMPRESS="http://jabber.org/features/compress";var NS_COMPRESS="http://jabber.org/protocol/compress";function STANZA_ERROR(c,b,a){if(window==this){return new STANZA_ERROR(c,b,a);}this.code=c;this.type=b;this.cond=a;}var ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request");var ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict");
var ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented");var ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden");var ERR_GONE=STANZA_ERROR("302","modify","gone");var ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error");var ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found");
var ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed");var ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable");var ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed");var ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized");var ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required");
var ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable");var ERR_REDIRECT=STANZA_ERROR("302","modify","redirect");var ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required");var ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404","cancel","remote-server-not-found");
var ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout");var ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint");var ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable");var ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required");
var ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request");function JSJaCConsoleLogger(a){this.level=a||4;this.start=function(){};this.log=function(c,d){d=d||0;if(d>this.level){return;}if(typeof(console)=="undefined"){return;}try{switch(d){case 0:console.warn(c);break;case 1:console.error(c);
break;case 2:console.info(c);break;case 4:console.debug(c);break;default:console.log(c);break;}}catch(b){try{console.log(c);}catch(b){}}};this.setLevel=function(b){this.level=b;return this;};this.getLevel=function(){return this.level;};}function JSJaCCookie(a,d,b,c,e){if(window==this){return new JSJaCCookie(a,d,b,c,e);
}this.name=a;this.value=d;this.secs=b;this.domain=c;this.path=e;this.write=function(){if(this.secs){var g=new Date();g.setTime(g.getTime()+(this.secs*1000));var f="; expires="+g.toGMTString();}else{var f="";}var h=this.domain?"; domain="+this.domain:"";var i=this.path?"; path="+this.path:"; path=/";document.cookie=this.getName()+"="+JSJaCCookie._escape(this.getValue())+f+h+i;
};this.erase=function(){var f=new JSJaCCookie(this.getName(),"",-1);f.write();};this.getName=function(){return this.name;};this.setName=function(f){this.name=f;return this;};this.getValue=function(){return this.value;};this.setValue=function(f){this.value=f;return this;};this.setDomain=function(f){this.domain=f;
return this;};this.setPath=function(f){this.path=f;return this;};}JSJaCCookie.read=function(b){var e=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var f=a[d];while(f.charAt(0)==" "){f=f.substring(1,f.length);}if(f.indexOf(e)==0){return new JSJaCCookie(b,JSJaCCookie._unescape(f.substring(e.length,f.length)));
}}throw new JSJaCCookieException("Cookie not found");};JSJaCCookie.get=function(a){return JSJaCCookie.read(a).getValue();};JSJaCCookie.remove=function(a){JSJaCCookie.read(a).erase();};JSJaCCookie._escape=function(a){return a.replace(/;/g,"%3AB");};JSJaCCookie._unescape=function(a){return a.replace(/%3AB/g,";");
};function JSJaCCookieException(a){this.message=a;this.name="CookieException";}function JSJaCError(c,b,d){var a=XmlDocument.create("error","jsjac");a.documentElement.setAttribute("code",c);a.documentElement.setAttribute("type",b);if(d){a.documentElement.appendChild(a.createElement(d)).setAttribute("xmlns","urn:ietf:params:xml:ns:xmpp-stanzas");
}return a.documentElement;}var JSJACJID_FORBIDDEN=['"'," ","&","'","/",":","<",">","@"];function JSJaCJID(a){this._node="";this._domain="";this._resource="";if(typeof(a)=="string"){if(a.indexOf("@")!=-1){this.setNode(a.substring(0,a.indexOf("@")));a=a.substring(a.indexOf("@")+1);}if(a.indexOf("/")!=-1){this.setResource(a.substring(a.indexOf("/")+1));
a=a.substring(0,a.indexOf("/"));}this.setDomain(a);}else{this.setNode(a.node);this.setDomain(a.domain);this.setResource(a.resource);}}JSJaCJID.prototype.getNode=function(){return this._node;};JSJaCJID.prototype.getDomain=function(){return this._domain;};JSJaCJID.prototype.getResource=function(){return this._resource;
};JSJaCJID.prototype.setNode=function(a){JSJaCJID._checkNodeName(a);this._node=a||"";return this;};JSJaCJID.prototype.setDomain=function(a){if(!a||a==""){throw new JSJaCJIDInvalidException("domain name missing");}JSJaCJID._checkNodeName(a);this._domain=a;return this;};JSJaCJID.prototype.setResource=function(a){this._resource=a||"";
return this;};JSJaCJID.prototype.toString=function(){var a="";if(this.getNode()&&this.getNode()!=""){a=this.getNode()+"@";}a+=this.getDomain();if(this.getResource()&&this.getResource()!=""){a+="/"+this.getResource();}return a;};JSJaCJID.prototype.removeResource=function(){return this.setResource();};
JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString());};JSJaCJID.prototype.isEntity=function(a){if(typeof a=="string"){a=(new JSJaCJID(a));}a.removeResource();return(this.clone().removeResource().toString()===a.toString());};JSJaCJID._checkNodeName=function(a){if(!a||a==""){return;
}for(var b=0;b<JSJACJID_FORBIDDEN.length;b++){if(a.indexOf(JSJACJID_FORBIDDEN[b])!=-1){throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[b]);}}};function JSJaCJIDInvalidException(a){this.message=a;this.name="JSJaCJIDInvalidException";}function JSJaCKeys(d,c){var a=Math.random();
this._k=new Array();this._k[0]=a.toString();if(c){this.oDbg=c;}else{this.oDbg={};this.oDbg.log=function(){};}if(d){for(var b=1;b<JSJAC_NKEYS;b++){this._k[b]=d(this._k[b-1]);c.log(b+": "+this._k[b],4);}}this._indexAt=JSJAC_NKEYS-1;this.getKey=function(){return this._k[this._indexAt--];};this.lastKey=function(){return(this._indexAt==0);
};this.size=function(){return this._k.length;};this._getSuspendVars=function(){return("_k,_indexAt").split(",");};}var JSJACPACKET_USE_XMLNS=true;function JSJaCPacket(a){this.name=a;if(typeof(JSJACPACKET_USE_XMLNS)!="undefined"&&JSJACPACKET_USE_XMLNS){this.doc=XmlDocument.create(a,"jabber:client");}else{this.doc=XmlDocument.create(a,"");
}}JSJaCPacket.prototype.pType=function(){return this.name;};JSJaCPacket.prototype.getDoc=function(){return this.doc;};JSJaCPacket.prototype.getNode=function(){if(this.getDoc()&&this.getDoc().documentElement){return this.getDoc().documentElement;}else{return null;}};JSJaCPacket.prototype.setTo=function(a){if(!a||a==""){this.getNode().removeAttribute("to");
}else{if(typeof(a)=="string"){this.getNode().setAttribute("to",a);}else{this.getNode().setAttribute("to",a.toString());}}return this;};JSJaCPacket.prototype.setFrom=function(a){if(!a||a==""){this.getNode().removeAttribute("from");}else{if(typeof(a)=="string"){this.getNode().setAttribute("from",a);}else{this.getNode().setAttribute("from",a.toString());
}}return this;};JSJaCPacket.prototype.setID=function(a){if(!a||a==""){this.getNode().removeAttribute("id");}else{this.getNode().setAttribute("id",a);}return this;};JSJaCPacket.prototype.setType=function(a){if(!a||a==""){this.getNode().removeAttribute("type");}else{this.getNode().setAttribute("type",a);
}return this;};JSJaCPacket.prototype.setXMLLang=function(a){if(!a||a==""){this.getNode().removeAttribute("xml:lang");}else{this.getNode().setAttribute("xml:lang",a);}return this;};JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to");};JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from");
};JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo());};JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom());};JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id");};JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type");
};JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang");};JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns");};JSJaCPacket.prototype.getChild=function(b,d){if(!this.getNode()){return null;}b=b||"*";d=d||"*";
if(this.getNode().getElementsByTagNameNS){return this.getNode().getElementsByTagNameNS(d,b).item(0);}var a=this.getNode().getElementsByTagName(b);if(d!="*"){for(var c=0;c<a.length;c++){if(a.item(c).namespaceURI==d||a.item(c).getAttribute("xmlns")==d){return a.item(c);}}}else{return a.item(0);}return null;
};JSJaCPacket.prototype.getChildVal=function(b,d){var e=this.getChild(b,d);var a="";if(e&&e.hasChildNodes()){for(var c=0;c<e.childNodes.length;c++){if(e.childNodes.item(c).nodeValue){a+=e.childNodes.item(c).nodeValue;}}}return a;};JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode());
};JSJaCPacket.prototype.isError=function(){return(this.getType()=="error");};JSJaCPacket.prototype.errorReply=function(a){var b=this.clone();b.setTo(this.getFrom());b.setFrom();b.setType("error");b.appendNode("error",{code:a.code,type:a.type},[[a.cond]]);return b;};JSJaCPacket.prototype.xml=typeof XMLSerializer!="undefined"?function(){var a=(new XMLSerializer()).serializeToString(this.getNode());
if(typeof(a)=="undefined"){a=(new XMLSerializer()).serializeToString(this.doc);}return a;}:function(){return this.getDoc().xml;};JSJaCPacket.prototype._getAttribute=function(a){return this.getNode().getAttribute(a);};JSJaCPacket.prototype.getAttribute=function(a){return this._getAttribute(a);};if(document.ELEMENT_NODE==null){document.ELEMENT_NODE=1;
document.ATTRIBUTE_NODE=2;document.TEXT_NODE=3;document.CDATA_SECTION_NODE=4;document.ENTITY_REFERENCE_NODE=5;document.ENTITY_NODE=6;document.PROCESSING_INSTRUCTION_NODE=7;document.COMMENT_NODE=8;document.DOCUMENT_NODE=9;document.DOCUMENT_TYPE_NODE=10;document.DOCUMENT_FRAGMENT_NODE=11;document.NOTATION_NODE=12;
}JSJaCPacket.prototype._importNode=function(f,b){switch(f.nodeType){case document.ELEMENT_NODE:if(this.getDoc().createElementNS){var e=this.getDoc().createElementNS(f.namespaceURI,f.nodeName);}else{var e=this.getDoc().createElement(f.nodeName);}if(f.attributes&&f.attributes.length>0){for(var d=0,c=f.attributes.length;
d<c;d++){var a=f.attributes.item(d);if(a.nodeName=="xmlns"&&e.getAttribute("xmlns")!=null){continue;}if(e.setAttributeNS&&a.namespaceURI){e.setAttributeNS(a.namespaceURI,a.nodeName,a.nodeValue);}else{e.setAttribute(a.nodeName,a.nodeValue);}}}if(b&&f.childNodes&&f.childNodes.length>0){for(var d=0,c=f.childNodes.length;
d<c;d++){e.appendChild(this._importNode(f.childNodes.item(d),b));}}return e;break;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(f.nodeValue);break;}};JSJaCPacket.prototype._setChildNode=function(g,b){var a=this.getChild(g);var d=this.getDoc().createTextNode(b);
if(a){try{a.replaceChild(d,a.firstChild);}catch(f){}}else{try{a=this.getDoc().createElementNS(this.getNode().namespaceURI,g);}catch(c){a=this.getDoc().createElement(g);}this.getNode().appendChild(a);a.appendChild(d);}return a;};JSJaCPacket.prototype.buildNode=function(a){return JSJaCBuilder.buildNode(this.getDoc(),a,arguments[1],arguments[2]);
};JSJaCPacket.prototype.appendNode=function(a){if(typeof a=="object"){return this.getNode().appendChild(a);}else{return this.getNode().appendChild(this.buildNode(a,arguments[1],arguments[2],null,this.getNode().namespaceURI));}};function JSJaCPresence(){this.base=JSJaCPacket;this.base("presence");}JSJaCPresence.prototype=new JSJaCPacket;
JSJaCPresence.prototype.setStatus=function(a){this._setChildNode("status",a);return this;};JSJaCPresence.prototype.setShow=function(a){if(a=="chat"||a=="away"||a=="xa"||a=="dnd"){this._setChildNode("show",a);}return this;};JSJaCPresence.prototype.setPriority=function(a){this._setChildNode("priority",a);
return this;};JSJaCPresence.prototype.setPresence=function(b,a,c){if(b){this.setShow(b);}if(a){this.setStatus(a);}if(c){this.setPriority(c);}return this;};JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status");};JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show");
};JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority");};function JSJaCIQ(){this.base=JSJaCPacket;this.base("iq");}JSJaCIQ.prototype=new JSJaCPacket;JSJaCIQ.prototype.setIQ=function(c,a,b){if(c){this.setTo(c);}if(a){this.setType(a);}if(b){this.setID(b);}return this;};JSJaCIQ.prototype.setQuery=function(c){var a;
try{a=this.getDoc().createElementNS(c,"query");}catch(b){a=this.getDoc().createElement("query");a.setAttribute("xmlns",c);}this.getNode().appendChild(a);return a;};JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0);};JSJaCIQ.prototype.getQueryXMLNS=function(){if(this.getQuery()){return this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns");
}else{return null;}};JSJaCIQ.prototype.reply=function(d){var b=this.clone();b.setTo(this.getFrom());b.setFrom();b.setType("result");if(d){if(typeof d=="string"){b.getChild().appendChild(b.getDoc().loadXML(d));}else{if(d.constructor==Array){var c=b.getChild();for(var a=0;a<d.length;a++){if(typeof d[a]=="string"){c.appendChild(b.getDoc().loadXML(d[a]));
}else{if(typeof d[a]=="object"){c.appendChild(d[a]);}}}}else{if(typeof d=="object"){b.getChild().appendChild(d);}}}}return b;};function JSJaCMessage(){this.base=JSJaCPacket;this.base("message");}JSJaCMessage.prototype=new JSJaCPacket;JSJaCMessage.prototype.setBody=function(a){this._setChildNode("body",a);
return this;};JSJaCMessage.prototype.setSubject=function(a){this._setChildNode("subject",a);return this;};JSJaCMessage.prototype.setThread=function(a){this._setChildNode("thread",a);return this;};JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread");};JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body");
};JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject");};JSJaCPacket.wrapNode=function(b){var a=null;switch(b.nodeName.toLowerCase()){case"presence":a=new JSJaCPresence();break;case"message":a=new JSJaCMessage();break;case"iq":a=new JSJaCIQ();break;default:a=new JSJaCPacket(b.nodeName.toLowerCase());
break;}if(a){a.getDoc().replaceChild(a._importNode(b,true),a.getNode());}return a;};function JSJaCConnection(a){if(a&&a.oDbg&&a.oDbg.log){this.oDbg=a.oDbg;}else{this.oDbg=new Object();this.oDbg.log=function(){};}if(a&&a.timerval){this.setPollInterval(a.timerval);}else{this.setPollInterval(JSJAC_TIMERVAL);
}if(a&&a.useDirectAuth){this._userDirectAuth=a.useDirectAuth;}if(a&&a.httpbase){this._httpbase=a.httpbase;}if(a&&a.allow_plain){this.allow_plain=a.allow_plain;}else{this.allow_plain=JSJAC_ALLOW_PLAIN;}if(a&&a.cookie_prefix){this._cookie_prefix=a.cookie_prefix;}else{this._cookie_prefix="";}this._connected=false;
this._lastAck=null;this._events=new Array();this._keys=null;this._ID=0;this._inQ=new Array();this._pQueue=new Array();this._regIDs=new Array();this._req=new Array();this._status="intialized";this._errcnt=0;this._inactivity=JSJAC_INACTIVITY;this._sendRawCallbacks=new Array();}JSJaCConnection.prototype.connect=function(a){this._setStatus("connecting");
this.domain=a.domain||"localhost";this.username=a.username;this.resource=a.resource;this.pass=a.pass;this.register=a.register;this.authhost=a.authhost||this.domain;this.authtype=a.authtype||"sasl";if(a.xmllang&&a.xmllang!=""){this._xmllang=a.xmllang;}this.host=a.host||this.domain;this.port=a.port||5222;
if(a.secure){this.secure="true";}else{this.secure="false";}if(a.wait){this._wait=a.wait;}this.jid=this.username+"@"+this.domain;this.fulljid=this.jid+"/"+this.resource;this._rid=Math.round(100000.5+(((900000.49999)-(100000.5))*Math.random()));var c=this._getFreeSlot();this._req[c]=this._setupRequest(true);
var b=this._getInitialRequestString();this.oDbg.log(b,4);this._req[c].r.onreadystatechange=JSJaC.bind(function(){if(this._req[c].r.readyState==4){this.oDbg.log("async recv: "+this._req[c].r.responseText,4);this._handleInitialResponse(c);}},this);if(typeof(this._req[c].r.onerror)!="undefined"){this._req[c].r.onerror=JSJaC.bind(function(d){this.oDbg.log("XmlHttpRequest error",1);
return false;},this);}this._req[c].r.send(b);};JSJaCConnection.prototype.connected=function(){return this._connected;};JSJaCConnection.prototype.disconnect=function(){this._setStatus("disconnecting");if(!this.connected()){return;}this._connected=false;this._lastAck=null;QzTimerMgr.clearInterval(this._interval);
QzTimerMgr.clearInterval(this._inQto);if(this._timeout){QzTimerMgr.clearTimeout(this._timeout);}var b=this._getFreeSlot();this._req[b]=this._setupRequest(false);request=this._getRequestString(false,true);this.oDbg.log("Disconnecting: "+request,4);try{this._req[b].r.send(request);JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase();
this.oDbg.log("Disconnected: "+this._req[b].r.responseText,2);}catch(a){}finally{this._handleEvent("ondisconnect");}};JSJaCConnection.prototype.getPollInterval=function(){return this._timerval;};JSJaCConnection.prototype.registerHandler=function(event){event=event.toLowerCase();var eArg={handler:arguments[arguments.length-1],childName:"*",childNS:"*",type:"*"};
if(arguments.length>2){eArg.childName=arguments[1];}if(arguments.length>3){eArg.childNS=arguments[2];}if(arguments.length>4){eArg.type=arguments[3];}if(!this._events[event]){this._events[event]=new Array(eArg);}else{this._events[event]=this._events[event].concat(eArg);}this._events[event]=this._events[event].sort(function(a,b){var aRank=0;
var bRank=0;with(a){if(type=="*"){aRank++;}if(childNS=="*"){aRank++;}if(childName=="*"){aRank++;}}with(b){if(type=="*"){bRank++;}if(childNS=="*"){bRank++;}if(childName=="*"){bRank++;}}if(aRank>bRank){return 1;}if(aRank<bRank){return -1;}return 0;});this.oDbg.log("registered handler for event '"+event+"'",2);
};JSJaCConnection.prototype.unregisterHandler=function(e,d){e=e.toLowerCase();if(!this._events[e]){return;}var a=this._events[e],c=new Array();for(var b=0;b<a.length;b++){if(a[b].handler!=d){c.push(a[b]);}}if(a.length!=c.length){this._events[e]=c;this.oDbg.log("unregistered handler for event '"+e+"'",2);
}};JSJaCConnection.prototype.registerIQGet=function(a,b,c){this.registerHandler("iq",a,b,"get",c);};JSJaCConnection.prototype.registerIQSet=function(a,b,c){this.registerHandler("iq",a,b,"set",c);};JSJaCConnection.prototype.resume=function(){try{var a=JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").getValue();
this.oDbg.log("read cookie: "+a,2);JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase();return this.resumeFromData(JSJaCJSON.parse(a));}catch(b){}return false;};JSJaCConnection.prototype.resumeFromData=function(c){try{this._setStatus("resuming");for(var b in c){if(c.hasOwnProperty(b)){this[b]=c[b];
}}if(this._keys){this._keys2=new JSJaCKeys();var a=this._keys2._getSuspendVars();for(var b=0;b<a.length;b++){this._keys2[a[b]]=this._keys[a[b]];}this._keys=this._keys2;}if(this._connected){this._handleEvent("onresume");QzTimerMgr.setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval(),"resumeFromData Timeout");
this._interval=QzTimerMgr.setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL,"JSJaC.resumeFromData interval for _interval");this._inQto=QzTimerMgr.setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL,"JSJaC.resumeFromData interval for _inQto");}return(this._connected===true);
}catch(d){if(d.message){this.oDbg.log("Resume failed: "+d.message,1);}else{this.oDbg.log("Resume failed: "+d,1);}return false;}};JSJaCConnection.prototype.sendEmpty=function(){if(!this.connected()){return false;}this._pQueue=this._pQueue.concat("  ");return true;};JSJaCConnection.prototype.send=function(b,d,j){if(!b||!b.pType){this.oDbg.log("no packet: "+b,1);
return false;}if(!this.connected()){return false;}if(d){if(!b.getID()){b.setID("JSJaCID_"+this._ID++);}this._registerPID(b.getID(),d,j);}try{this._handleEvent(b.pType()+"_out",b);this._handleEvent("packet_out",b);var c=false;var a=b.xml();var f=true;if(c){f=false;try{var g=XmlDocument.create("doc");g.loadXML(a);
var i=(new XMLSerializer()).serializeToString(g);f=(i==a);}catch(h){}}if(f){this._pQueue=this._pQueue.concat(a);}else{return false;}}catch(h){this.oDbg.log(h.toString(),1);return false;}return true;};JSJaCConnection.prototype.sendIQ=function(e,c,a){if(!e||e.pType()!="iq"){return false;}c=c||{};var b=c.error_handler||JSJaC.bind(function(g){this.oDbg.log(g.xml(),1);
},this);var d=c.result_handler||JSJaC.bind(function(g){this.oDbg.log(g.xml(),2);},this);var f=function(h,g){switch(h.getType()){case"error":b(h);break;case"result":d(h,g);break;}};return this.send(e,f,a);};JSJaCConnection.prototype.setPollInterval=function(a){if(a&&!isNaN(a)){this._timerval=a;}return this._timerval;
};JSJaCConnection.prototype.status=function(){return this._status;};JSJaCConnection.prototype.suspend=function(){var b=this.suspendToData();try{var f=new JSJaCCookie(this._cookie_prefix+"JSJaC_State",JSJaCJSON.toString(b));this.oDbg.log("writing cookie: "+f.getValue()+"\n"+"(length:"+f.getValue().length+")",2);
f.write();var a=JSJaCCookie.get(this._cookie_prefix+"JSJaC_State");if(f.getValue()!=a){this.oDbg.log("Suspend failed writing cookie.\nread: "+a,1);f.erase();return false;}return true;}catch(d){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+d.message,1);}return false;};JSJaCConnection.prototype.suspendToData=function(){QzTimerMgr.clearTimeout(this._timeout);
QzTimerMgr.clearInterval(this._interval);QzTimerMgr.clearInterval(this._inQto);this._suspend();var c=("_connected,_keys,_ID,_inQ,_pQueue,_regIDs,_errcnt,_inactivity,domain,username,resource,jid,fulljid,_sid,_httpbase,_timerval,_is_polling").split(",");c=c.concat(this._getSuspendVars());var e=new Object();
for(var d=0;d<c.length;d++){if(!this[c[d]]){continue;}if(this[c[d]]._getSuspendVars){var a=this[c[d]]._getSuspendVars();var f=new Object();for(var b=0;b<a.length;b++){f[a[b]]=this[c[d]][a[b]];}}else{var f=this[c[d]];}e[c[d]]=f;}this._connected=false;this._lastAck=null;this._setStatus("suspending");return e;
};JSJaCConnection.prototype._abort=function(){QzTimerMgr.clearTimeout(this._timeout);QzTimerMgr.clearInterval(this._inQto);QzTimerMgr.clearInterval(this._interval);this._connected=false;this._lastAck=null;this._setStatus("aborted");this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"));
};JSJaCConnection.prototype._checkInQ=function(){for(var a=0;a<this._inQ.length&&a<10;a++){var b=this._inQ[0];this._inQ=this._inQ.slice(1,this._inQ.length);var d=null;try{d=JSJaCPacket.wrapNode(b);}catch(c){this.oDbg.log("_checkInQ failed for packet item format error."+c);}if(!d){continue;}this._handleEvent("packet_in",d);
if(d.pType&&!this._handlePID(d)){this._handleEvent(d.pType()+"_in",d);this._handleEvent(d.pType(),d);}}};JSJaCConnection.prototype._checkQueue=function(){if(this._pQueue.length!=0){this._process();}return true;};JSJaCConnection.prototype._doAuth=function(){if(this.has_sasl&&this.authtype=="nonsasl"){this.oDbg.log("Warning: SASL present but not used",1);
}if(!this._doSASLAuth()&&!this._doLegacyAuth()){this.oDbg.log("Auth failed for authtype "+this.authtype,1);this.disconnect();return false;}return true;};JSJaCConnection.prototype._doInBandReg=function(){if(this.authtype=="saslanon"||this.authtype=="anonymous"){return;}var a=new JSJaCIQ();a.setType("set");
a.setID("reg1");a.appendNode("query",{xmlns:"jabber:iq:register"},[["username",this.username],["password",this.pass]]);this.send(a,this._doInBandRegDone);};JSJaCConnection.prototype._doInBandRegDone=function(a){if(a&&a.getType()=="error"){this.oDbg.log("registration failed for "+this.username,0);this._handleEvent("onerror",a.getChild("error"));
return;}this.oDbg.log(this.username+" registered succesfully",0);this._doAuth();};JSJaCConnection.prototype._doLegacyAuth=function(){if(this.authtype!="nonsasl"&&this.authtype!="anonymous"){return false;}var a=new JSJaCIQ();a.setIQ(this.server,"get","auth1");a.appendNode("query",{xmlns:"jabber:iq:auth"},[["username",this.username]]);
this.send(a,this._doLegacyAuth2);return true;};JSJaCConnection.prototype._doLegacyAuth2=function(b){if(!b||b.getType()!="result"){if(b&&b.getType()=="error"){this._handleEvent("onerror",b.getChild("error"));}this.disconnect();return;}var a=(b.getChild("digest")!=null);var b=new JSJaCIQ();b.setIQ(this.server,"set","auth2");
query=b.appendNode("query",{xmlns:"jabber:iq:auth"},[["username",this.username],["resource",this.resource]]);if(a){query.appendChild(b.buildNode("digest",{xmlns:"jabber:iq:auth"},hex_sha1(this.streamid+this.pass)));}else{if(this.allow_plain){query.appendChild(b.buildNode("password",{xmlns:"jabber:iq:auth"},this.pass));
}else{this.oDbg.log("no valid login mechanism found",1);this.disconnect();return false;}}this.send(b,this._doLegacyAuthDone);};JSJaCConnection.prototype._doLegacyAuthDone=function(a){if(a.getType()!="result"){if(a.getType()=="error"){this._handleEvent("onerror",a.getChild("error"));}this.disconnect();
}else{this._connected=true;}this._handleEvent("onconnect");};JSJaCConnection.prototype._doSASLAuth=function(){if(this.authtype=="nonsasl"||this.authtype=="anonymous"){return false;}if(this.authtype=="saslanon"){if(this.mechs["ANONYMOUS"]){this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2);return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);
}this.oDbg.log("SASL ANONYMOUS requested but not supported",1);}else{if(this.mechs["DIGEST-MD5"]){this.oDbg.log("SASL using mechanism 'DIGEST-MD5'",2);return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='DIGEST-MD5'/>",this._doSASLAuthDigestMd5S1);}else{if(this.allow_plain&&this.mechs["PLAIN"]){this.oDbg.log("SASL using mechanism 'PLAIN'",2);
var a=this.username+"@"+this.domain+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass;this.oDbg.log("authenticating with '"+a+"'",2);a=btoa(a);return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+a+"</auth>",this._doSASLAuthDone);}}this.oDbg.log("No SASL mechanism applied",1);
this.authtype="nonsasl";}return false;};JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(e){if(e.nodeName!="challenge"){this.oDbg.log("challenge missing",1);this._handleEvent("onerror",JSJaCError("401","auth","not-authorized"));this.disconnect();}else{var d=atob(e.firstChild.nodeValue);this.oDbg.log("got challenge: "+d,2);
this._nonce=d.substring(d.indexOf("nonce=")+7);this._nonce=this._nonce.substring(0,this._nonce.indexOf('"'));this.oDbg.log("nonce: "+this._nonce,2);if(this._nonce==""||this._nonce.indexOf('"')!=-1){this.oDbg.log("nonce not valid, aborting",1);this.disconnect();return;}this._digest_uri="xmpp/";this._digest_uri+=this.domain;
this._cnonce=cnonce(14);this._nc="00000001";var c=str_md5(this.username+":"+this.domain+":"+this.pass)+":"+this._nonce+":"+this._cnonce;var b="AUTHENTICATE:"+this._digest_uri;var a=hex_md5(hex_md5(c)+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+hex_md5(b));var f='username="'+this.username+'",realm="'+this.domain+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc="'+this._nc+'",qop=auth,digest-uri="'+this._digest_uri+'",response="'+a+'",charset="utf-8"';
this.oDbg.log("response: "+f,2);this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+binb2b64(str2binb(f))+"</response>",this._doSASLAuthDigestMd5S2);}};JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(e){if(e.nodeName=="failure"){if(e.xml){this.oDbg.log("auth error: "+e.xml,1);
}else{this.oDbg.log("auth error",1);}this._handleEvent("onerror",JSJaCError("401","auth","not-authorized"));this.disconnect();return;}var c=atob(e.firstChild.nodeValue);this.oDbg.log("response: "+c,2);var f=c.substring(c.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+f,2);var d=str_md5(this.username+":"+this.domain+":"+this.pass)+":"+this._nonce+":"+this._cnonce;
var b=":"+this._digest_uri;var a=hex_md5(hex_md5(d)+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+hex_md5(b));this.oDbg.log("rsptest: "+a,2);if(a!=f){this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1);this.disconnect();return;}if(e.nodeName=="success"){this._reInitStream(this.domain,this._doStreamBind);
}else{this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone);}};JSJaCConnection.prototype._doSASLAuthDone=function(a){if(a.nodeName!="success"){this.oDbg.log("auth failed",1);this._handleEvent("onerror",JSJaCError("401","auth","not-authorized"));this.disconnect();}else{this._conference_domain=a.getAttribute("conference_domain");
}this._reInitStream(this.domain,this._doStreamBind);};JSJaCConnection.prototype._doStreamBind=function(){var a=new JSJaCIQ();a.setIQ(null,"set","bind_1");a.appendNode("bind",{xmlns:"urn:ietf:params:xml:ns:xmpp-bind"},[["resource",this.resource]]);this.oDbg.log(a.xml());this.send(a,this._doXMPPSess);};
JSJaCConnection.prototype._doAfterBind=function(a){this.fulljid=a;this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/"));};JSJaCConnection.prototype._doXMPPSess=function(a){if(a.getType()!="result"||a.getType()=="error"){this.disconnect();if(a.getType()=="error"){this._handleEvent("onerror",a.getChild("error"));
}return;}this._doAfterBind(a.getChildVal("jid"));a=new JSJaCIQ();a.setIQ(this.domain,"set","sess_1");a.appendNode("session",{xmlns:"urn:ietf:params:xml:ns:xmpp-session"},[]);this.oDbg.log(a.xml());this.send(a,this._doXMPPSessDone);};JSJaCConnection.prototype._doXMPPSessDone=function(a){if(a.getType()!="result"||a.getType()=="error"){this.disconnect();
if(a.getType()=="error"){this._handleEvent("onerror",a.getChild("error"));}return;}else{this._connected=true;this._handleEvent("onconnect");}};JSJaCConnection.prototype._handleEvent=function(d,a){d=d.toLowerCase();if(d=="onconnect"){this._connected=true;}this.oDbg.log("incoming event '"+d+"'",3);if(!this._events[d]){return;
}this.oDbg.log("handling event '"+d+"'",4);for(var b=0;b<this._events[d].length;b++){var c=this._events[d][b];if(typeof c.handler=="function"){try{if(a){if(a.pType){if((!a.getNode().hasChildNodes()&&c.childName!="*")||(a.getNode().hasChildNodes()&&!a.getChild(c.childName,c.childNS))){continue;}if(c.type!="*"&&a.getType()!=c.type){continue;
}this.oDbg.log(c.childName+"/"+c.childNS+"/"+c.type+" => match for handler "+c.handler,3);}if(c.handler(a)){break;}}else{if(c.handler()){break;}}}catch(f){if(f.fileName&&f.lineNumber){this.oDbg.log(c.handler+"\n>>>"+f.name+": "+f.message+" in "+f.fileName+" line "+f.lineNumber,1);}else{this.oDbg.log(c.handler+"\n>>>"+f.name+": "+f.message,1);
}}}}};JSJaCConnection.prototype._handlePID=function(d){if(!d.getID()){return false;}for(var b in this._regIDs){if(this._regIDs.hasOwnProperty(b)&&this._regIDs[b]&&b==d.getID()){var a=d.getID();this.oDbg.log("handling "+a,3);try{if(this._regIDs[b].cb.call(this,d,this._regIDs[b].arg)===false){return false;
}else{this._unregisterPID(a);return true;}}catch(c){this.oDbg.log(c.name+": "+c.message,1);this._unregisterPID(a);return true;}}}return false;};JSJaCConnection.prototype._lastXmlQueue=new Array();JSJaCConnection.prototype._handleResponse=function(c){this.oDbg.log("_handleResponse: ");var b=this._parseResponse(c);
try{this._handleEvent("bosh_response");}catch(d){}if(!b){this.oDbg.log("_handleResponse finish for no rootE1 ");return;}if(this._lastAck==null){this._lastXmlQueue=new Array();}var a=parseInt(b.getAttribute("ack"));if(this._lastAck==null||a==(this._lastAck+1)){try{this._handleResponseForElement(b);}finally{this._lastAck=a;
}this._tryDealDataInResponseQueue();}else{if(this._lastAck&&(a<=this._lastAck)){this.oDbg.log("_handleResponse error of Too small"+"last ack:"+this._lastAck+", now ack is:"+a);}else{if(this._lastAck&&((a-this._lastAck)>=this.MAX_WAIT_PACKET_COUNT)){try{this._handleResponseForElement(b);}finally{this._lastAck=a;
this._lastXmlQueue=new Array();}}else{this._lastXmlQueue.push(b);while(this._lastXmlQueue.length>=this.MAX_WAIT_PACKET_COUNT){this._lastAck++;this._tryDealDataInResponseQueue();}}}}};JSJaCConnection.prototype.MAX_WAIT_PACKET_COUNT=10;JSJaCConnection.prototype._tryDealDataInResponseQueue=function(){var d=false;
while(this._lastXmlQueue.length>0){for(var c in this._lastXmlQueue){var a=this._lastXmlQueue[c];var b=parseInt(a.getAttribute("ack"));if(b==(this._lastAck+1)){d=true;try{this._handleResponseForElement(a);}finally{this._lastAck=b;this._lastXmlQueue.splice(c,1);}break;}}if(d&&this._lastXmlQueue.length>0){d=false;
continue;}else{break;}}};JSJaCConnection.prototype._handleResponseForElement=function(c){this.oDbg.log("_handleResponseForElement: ");for(var b=0;b<c.childNodes.length;b++){if(this._sendRawCallbacks.length){var a=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length);
this.oDbg.log("_handleResponse try to call fn:");a.fn.call(this,c.childNodes.item(b),a.arg);continue;}this._inQ=this._inQ.concat(c.childNodes.item(b));}};JSJaCConnection.prototype._parseStreamFeatures=function(f){if(!f){this.oDbg.log("nothing to parse ... aborting",1);return false;}var e;if(f.getElementsByTagNameNS){e=f.getElementsByTagNameNS("http://etherx.jabber.org/streams","error").item(0);
}else{var g=f.getElementsByTagName("error");for(var b=0;b<g.length;b++){if(g.item(b).namespaceURI=="http://etherx.jabber.org/streams"){e=g.item(b);break;}}}if(e){this._setStatus("internal_server_error");QzTimerMgr.clearTimeout(this._timeout);QzTimerMgr.clearInterval(this._interval);QzTimerMgr.clearInterval(this._inQto);
this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate"));this._connected=false;this._lastAck=null;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");return false;}this.mechs=new Object();var d=f.getElementsByTagName("mechanisms");this.has_sasl=false;for(var b=0;b<d.length;
b++){if(d.item(b).getAttribute("xmlns")=="urn:ietf:params:xml:ns:xmpp-sasl"){this.has_sasl=true;var c=d.item(b).getElementsByTagName("mechanism");for(var a=0;a<c.length;a++){this.mechs[c.item(a).firstChild.nodeValue]=true;}break;}}if(this.has_sasl){this.oDbg.log("SASL detected",2);}else{this.oDbg.log("No support for SASL detected",2);
return false;}return true;};JSJaCConnection.prototype._process=function(a){if(!this.connected()){this.oDbg.log("Connection lost ...",1);if(this._interval){QzTimerMgr.clearInterval(this._interval);}return;}this.setPollInterval(a);if(this._timeout){QzTimerMgr.clearTimeout(this._timeout);}var d=this._getFreeSlot();
if(d<0){return;}if(typeof(this._req[d])!="undefined"&&typeof(this._req[d].r)!="undefined"&&this._req[d].r.readyState!=4){this.oDbg.log("Slot "+d+" is not ready");return;}if(!this.isPolling()&&this._pQueue.length==0&&this._req[(d+1)%2]&&this._req[(d+1)%2].r.readyState!=4){this.oDbg.log("all slots busy, standby ...",2);
return;}if(!this.isPolling()){this.oDbg.log("Found working slot at "+d,4);}this._req[d]=this._setupRequest(true);this._req[d].r.onreadystatechange=JSJaC.bind(function(){if(!this.connected()){return;}if(this._req[d].r.readyState==4){this._setStatus("processing");this.oDbg.log("async recv: "+this._req[d].r.responseText,4);
this._handleResponse(this._req[d]);if(this._pQueue.length){this._timeout=QzTimerMgr.setTimeout(JSJaC.bind(this._process,this),100,"JSJaC.bind schedule next tick");}else{this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",4);this._timeout=QzTimerMgr.setTimeout(JSJaC.bind(this._process,this),this.getPollInterval(),"JSJaC.bind schedule next tic, length is 0");
}}},this);try{this._req[d].r.onerror=JSJaC.bind(function(){if(!this.connected()){return;}this._errcnt++;this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1);if(this._errcnt>JSJAC_ERR_COUNT){this._abort();return false;}this._setStatus("onerror_fallback");QzTimerMgr.setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval(),"JSJaCConnection.prototype._process for onerror");
return false;},this);}catch(b){}var c=this._getRequestString();if(typeof(this._rid)!="undefined"){this._req[d].rid=this._rid;}this.oDbg.log("sending: "+c,4);this._req[d].r.send(c);};JSJaCConnection.prototype._registerPID=function(c,b,a){if(!c||!b){return false;}this._regIDs[c]=new Object();this._regIDs[c].cb=b;
if(a){this._regIDs[c].arg=a;}this.oDbg.log("registered "+c,3);return true;};JSJaCConnection.prototype._sendEmpty=function JSJaCSendEmpty(){var b=this._getFreeSlot();this._req[b]=this._setupRequest(true);this._req[b].r.onreadystatechange=JSJaC.bind(function(){if(this._req[b].r.readyState==4){this.oDbg.log("async recv: "+this._req[b].r.responseText,4);
this._getStreamID(b);}},this);if(typeof(this._req[b].r.onerror)!="undefined"){this._req[b].r.onerror=JSJaC.bind(function(c){this.oDbg.log("XmlHttpRequest error",1);return false;},this);}var a=this._getRequestString();this.oDbg.log("sending: "+a,4);this._req[b].r.send(a);};JSJaCConnection.prototype._sendRaw=function(c,b,a){if(b){this._sendRawCallbacks.push({fn:b,arg:a});
}this._pQueue.push(c);this._process();return true;};JSJaCConnection.prototype._setStatus=function(a){if(!a||a==""){return;}if(a!=this._status){this._status=a;this._handleEvent("onstatuschanged",a);this._handleEvent("status_changed",a);}};JSJaCConnection.prototype._unregisterPID=function(a){if(!this._regIDs[a]){return false;
}this._regIDs[a]=null;this.oDbg.log("unregistered "+a,3);return true;};function JSJaCHttpBindingConnection(a){this.base=JSJaCConnection;this.base(a);this._hold=JSJACHBC_MAX_HOLD;this._inactivity=0;this._last_requests=new Object();this._last_rid=0;this._min_polling=0;this._pause=0;this._wait=JSJACHBC_MAX_WAIT;
}JSJaCHttpBindingConnection.prototype=new JSJaCConnection();JSJaCHttpBindingConnection.prototype.inherit=function(a){if(a.jid){var b=new JSJaCJID(a.jid);this.domain=b.getDomain();this.username=b.getNode();this.resource=b.getResource();}else{this.domain=a.domain||"localhost";this.username=a.username;this.resource=a.resource;
}this._sid=a.sid;this._rid=a.rid;this._min_polling=a.polling;this._inactivity=a.inactivity;this._setHold(a.requests-1);this.setPollInterval(this._timerval);if(a.wait){this._wait=a.wait;}this._connected=true;this._handleEvent("onconnect");this._interval=QzTimerMgr.setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL,"JSJaCHttpBindingConnection.prototype.inherit _interval");
this._inQto=QzTimerMgr.setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL,"JSJaCHttpBindingConnection.prototype.inherit _inQto");this._timeout=QzTimerMgr.setTimeout(JSJaC.bind(this._process,this),this.getPollInterval(),"JSJaCHttpBindingConnection.prototype.inherit timeout");};JSJaCHttpBindingConnection.prototype.setPollInterval=function(a){if(a&&!isNaN(a)){if(!this.isPolling()){this._timerval=100;
}else{if(this._min_polling&&a<this._min_polling*1000){this._timerval=this._min_polling*1000;}else{if(this._inactivity&&a>this._inactivity*1000){this._timerval=this._inactivity*1000;}else{this._timerval=a;}}}}return this._timerval;};JSJaCHttpBindingConnection.prototype.isPolling=function(){return(this._hold==0);
};JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var a=0;a<this._hold+1;a++){if(typeof(this._req[a])=="undefined"||typeof(this._req[a].r)=="undefined"||this._req[a].r.readyState==4){return a;}}return -1;};JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold;};JSJaCHttpBindingConnection.prototype._getRequestString=function(b,e){b=b||"";
var f="";if(this._rid<=this._last_rid&&typeof(this._last_requests[this._rid])!="undefined"){f=this._last_requests[this._rid].xml;}else{var a="";while(this._pQueue.length){var d=this._pQueue[0];a+=d;this._pQueue=this._pQueue.slice(1,this._pQueue.length);}f="<body rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind' ";
if(JSJAC_HAVEKEYS){f+="key='"+this._keys.getKey()+"' ";if(this._keys.lastKey()){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);f+="newkey='"+this._keys.getKey()+"' ";}}if(e){f+="type='terminate'";}else{if(this._reinit){if(JSJACHBC_USE_BOSH_VER){f+="xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh'";}this._reinit=false;
}}if(a!=""||b!=""){f+=">"+b+a+"</body>";}else{f+="/>";}this._last_requests[this._rid]=new Object();this._last_requests[this._rid].xml=f;this._last_rid=this._rid;for(var c in this._last_requests){if(this._last_requests.hasOwnProperty(c)&&c<this._rid-this._hold){delete (this._last_requests[c]);}}}return f;
};JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var c="<body content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";if(this.host||this.port){c+=" route='xmpp:"+this.host+":"+this.port+"'";
}if(this.secure){c+=" secure='"+this.secure+"'";}if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);key=this._keys.getKey();c+=" newkey='"+key+"'";}if(this._xmllang){c+=" xml:lang='"+this._xmllang+"'";}if(JSJACHBC_USE_BOSH_VER){c+=" ver='"+JSJACHBC_BOSH_VERSION+"'";c+=" xmlns:xmpp='urn:xmpp:xbosh'";
if(this.authtype=="sasl"||this.authtype=="saslanon"){c+=" xmpp:version='1.0'";}}c+=">";if(this._userDirectAuth){this.oDbg.log("Using Xmpp Bosh Direct Auth Login",2);var b=this.username+"@"+this.domain+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass;this.oDbg.log("authenticating with '"+b+"'",2);
b=btoa(b);var a="<auth value='"+b+"' resource='"+this.resource+"' /> ";c+=a;}c+="</body>";return c;};JSJaCHttpBindingConnection.prototype._getStreamID=function(b){this.oDbg.log(this._req[b].r.responseText,4);if(!this._req[b].r.responseXML||!this._req[b].r.responseXML.documentElement){this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));
return;}var a=this._req[b].r.responseXML.documentElement;if(a.getAttribute("authid")){this.streamid=a.getAttribute("authid");this.oDbg.log("got streamid: "+this.streamid,4);}if(!this._parseStreamFeatures(a)||!this.streamid){this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));
return;}this._timeout=QzTimerMgr.setTimeout(JSJaC.bind(this._process,this),this.getPollInterval(),"JSJaC._getStreamID timeout for normal");if(this.register){this._doInBandReg();}else{this._doAuth();}};JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return("host,port,secure,_rid,_last_rid,_wait,_min_polling,_inactivity,_hold,_last_requests,_pause").split(",");
};JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(e){try{this.oDbg.log(this._req[e].r.getAllResponseHeaders(),4);this.oDbg.log(this._req[e].r.responseText,4);}catch(b){this.oDbg.log("No response",4);}if(this._req[e].r.status!=200||!this._req[e].r.responseXML){this.oDbg.log("initial response broken (status: "+this._req[e].r.status+")",1);
this._handleEvent("onerror",JSJaCError("503","connect_error","service-unavailable"));return;}var a=this._req[e].r.responseXML.documentElement;if(!a||a.tagName!="body"||a.namespaceURI!="http://jabber.org/protocol/httpbind"){this.oDbg.log("no body element or incorrect body in initial response",1);this._handleEvent("onerror",JSJaCError("500","connect_error","internal-service-error"));
return;}var d=this._req[e].r.responseText.indexOf("not-authorized")>=0;if(a.getAttribute("type")=="terminate"||d){this.oDbg.log("invalid response:\n"+this._req[e].r.responseText,1);QzTimerMgr.clearTimeout(this._timeout);this._connected=false;this._lastAck=null;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");
if(d){this._handleEvent("onerror",JSJaCError("401","auth","not-authorized"));}else{this._handleEvent("onerror",JSJaCError("503","connect_error","service-unavailable"));}return;}this._sid=a.getAttribute("sid");this.oDbg.log("got sid: "+this._sid,4);if(a.getAttribute("polling")){this._min_polling=a.getAttribute("polling");
}if(a.getAttribute("inactivity")){this._inactivity=a.getAttribute("inactivity");}if(a.getAttribute("requests")){this._setHold(a.getAttribute("requests")-1);}this.oDbg.log("set hold to "+this._getHold(),4);if(a.getAttribute("ver")){this._bosh_version=a.getAttribute("ver");}if(a.getAttribute("maxpause")){this._pause=Number.min(a.getAttribute("maxpause"),JSJACHBC_MAXPAUSE);
}this.setPollInterval(this._timerval);this._connected=true;var c=this._parseDirectAuthResponse(a);this._inQto=QzTimerMgr.setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL,"JSJaC._handleInitialResponse - _inQto");this._interval=QzTimerMgr.setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL,"JSJaC._handleInitialResponse - _interval");
if(!c){this._getStreamID(e);}};JSJaCHttpBindingConnection.prototype._parseDirectAuthResponse=function(b){var a=b.getElementsByTagName("success");if(a.length>0){this.mechs=new Object();this.has_sasl=true;this.mechs["PLAIN"]=true;var c=a[0].getAttribute("jid");this._conference_domain=a[0].getAttribute("conference_domain");
this._doAfterBind(c);this._connected=true;this._handleEvent("onconnect");return true;}else{return false;}};JSJaCHttpBindingConnection.prototype.getConferenceDomain=function(){return this._conference_domain;};JSJaCHttpBindingConnection.prototype._parseResponse=function(c){if(!this.connected()||!c){return null;
}var b=c.r;try{if(b.status==404||b.status==403){this._abort();return null;}if((b.status==200)&&(!b.responseXML)){b.responseXML=QzXmlTool.rebuildXmlDocument(b.responseText);}if(b.status!=200||!b.responseXML){this._errcnt++;var g="invalid response ("+b.status+"):\n"+b.getAllResponseHeaders()+"\n"+b.responseText;
if(!b.responseXML){g+="\nResponse failed to parse!";}this.oDbg.log(g,1);if(this._errcnt>JSJAC_ERR_COUNT){this._abort();return null;}if(this.connected()){this.oDbg.log("repeating ("+this._errcnt+")",1);this._setStatus("proto_error_fallback");QzTimerMgr.setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval(),"JSJaC._parseResponse timeout for retry");
}return null;}}catch(d){this.oDbg.log("XMLHttpRequest error: status not available",1);this._errcnt++;if(this._errcnt>JSJAC_ERR_COUNT){this._abort();}else{if(this.connected()){this.oDbg.log("repeating ("+this._errcnt+")",1);this._setStatus("proto_error_fallback");QzTimerMgr.setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval(),"JSJaC._parseResponse timeout for exception");
}}return null;}var a=b.responseXML.documentElement;if(!a||a.tagName!="body"||a.namespaceURI!="http://jabber.org/protocol/httpbind"){this.oDbg.log("invalid response:\n"+b.responseText,1);QzTimerMgr.clearTimeout(this._timeout);QzTimerMgr.clearInterval(this._interval);QzTimerMgr.clearInterval(this._inQto);
this._connected=false;this._lastAck=null;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");this._setStatus("internal_server_error");this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error"));return null;}if(typeof(c.rid)!="undefined"&&this._last_requests[c.rid]){if(this._last_requests[c.rid].handled){this.oDbg.log("already handled "+c.rid,4);
return null;}else{this._last_requests[c.rid].handled=true;}}if(a.getAttribute("type")=="terminate"){this.oDbg.log("session terminated:\n"+b.responseText,1);QzTimerMgr.clearTimeout(this._timeout);QzTimerMgr.clearInterval(this._interval);QzTimerMgr.clearInterval(this._inQto);var f=a.getAttribute("condition");
if(f=="remote-stream-error"){if(a.getElementsByTagName("conflict").length>0){this._setStatus("session-terminate-conflict");}}if(f==null){f="session-terminate";}this._handleEvent("onerror",JSJaCError("503","cancel",f));this._connected=false;this._lastAck=null;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");
return null;}this._errcnt=0;return b.responseXML.documentElement;};JSJaCHttpBindingConnection.prototype._reInitStream=function(c,b,a){this._reinit=true;b.call(this,a);};JSJaCHttpBindingConnection.prototype._resume=function(){if(this._pause==0&&this._rid>=this._last_rid){this._rid=this._last_rid-1;}this._process();
};JSJaCHttpBindingConnection.prototype._setHold=function(a){if(!a||isNaN(a)||a<0){a=0;}else{if(a>JSJACHBC_MAX_HOLD){a=JSJACHBC_MAX_HOLD;}}this._hold=a;return this._hold;};JSJaCHttpBindingConnection.prototype._setupRequest=function(a){var c=new Object();var b=XmlHttp.create();try{b.open("POST",this._httpbase,a);
b.setRequestHeader("Content-Type","text/xml; charset=utf-8");}catch(d){this.oDbg.log(d,1);}c.r=b;this._rid++;c.rid=this._rid;return c;};JSJaCHttpBindingConnection.prototype._suspend=function(){if(this._pause==0){return;}var c=this._getFreeSlot();this._req[c]=this._setupRequest(false);var b="<body pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";
if(JSJAC_HAVEKEYS){b+=" key='"+this._keys.getKey()+"'";if(this._keys.lastKey()){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);b+=" newkey='"+this._keys.getKey()+"'";}}b+=">";while(this._pQueue.length){var a=this._pQueue[0];b+=a;this._pQueue=this._pQueue.slice(1,this._pQueue.length);}b+="</body>";this.oDbg.log("Disconnecting: "+b,4);
this._req[c].r.send(b);};function JSJaCHttpPollingConnection(a){this.base=JSJaCConnection;this.base(a);JSJACPACKET_USE_XMLNS=false;}JSJaCHttpPollingConnection.prototype=new JSJaCConnection();JSJaCHttpPollingConnection.prototype.isPolling=function(){return true;};JSJaCHttpPollingConnection.prototype._getFreeSlot=function(){if(typeof(this._req[0])=="undefined"||typeof(this._req[0].r)=="undefined"||this._req[0].r.readyState==4){return 0;
}else{return -1;}};JSJaCHttpPollingConnection.prototype._getInitialRequestString=function(){var b="0";if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(b64_sha1,this.oDbg);key=this._keys.getKey();b+=";"+key;}var a=this.domain;if(this.authhost){a=this.authhost;}b+=",<stream:stream to='"+a+"' xmlns='jabber:client' xmlns:stream='http://etherx.jabber.org/streams'";
if(this.authtype=="sasl"||this.authtype=="saslanon"){b+=" version='1.0'";}b+=">";return b;};JSJaCHttpPollingConnection.prototype._getRequestString=function(a,b){var c=this._sid;if(JSJAC_HAVEKEYS){c+=";"+this._keys.getKey();if(this._keys.lastKey()){this._keys=new JSJaCKeys(b64_sha1,this.oDbg);c+=";"+this._keys.getKey();
}}c+=",";if(a){c+=a;}while(this._pQueue.length){c+=this._pQueue[0];this._pQueue=this._pQueue.slice(1,this._pQueue.length);}if(b){c+="</stream:stream>";}return c;};JSJaCHttpPollingConnection.prototype._getStreamID=function(){if(this._req[0].r.responseText==""){this.oDbg.log("waiting for stream id",4);
this._timeout=QzTimerMgr.setTimeout(JSJaC.bind(this._sendEmpty,this),1000,"JSJaC._getStreamID timeout for response text is blank.");return;}this.oDbg.log(this._req[0].r.responseText,4);if(this._req[0].r.responseText.match(/id=[\'\"]([^\'\"]+)[\'\"]/)){this.streamid=RegExp.$1;}this.oDbg.log("got streamid: "+this.streamid,4);
var c;try{var a=this._req[0].r.responseText;if(!a.match(/<\/stream:stream>\s*$/)){a+="</stream:stream>";}c=XmlDocument.create("doc");c.loadXML(a);if(!this._parseStreamFeatures(c)){this.authtype="nonsasl";return;}}catch(b){this.oDbg.log("loadXML: "+b.toString(),1);}this._connected=true;if(this.register){this._doInBandReg();
}else{this._doAuth();}this._process(this._timerval);};JSJaCHttpPollingConnection.prototype._getSuspendVars=function(){return new Array();};JSJaCHttpPollingConnection.prototype._handleInitialResponse=function(){this.oDbg.log(this._req[0].r.getAllResponseHeaders(),4);var b=this._req[0].r.getResponseHeader("Set-Cookie");
b=b.split(";");for(var a=0;a<b.length;a++){aArg=b[a].split("=");if(aArg[0]=="ID"){this._sid=aArg[1];}}this.oDbg.log("got sid: "+this._sid,4);this._connected=true;this._interval=QzTimerMgr.setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL,"JSJaCHttpPollingConnection.prototype._handleInitialResponse _interval");
this._inQto=QzTimerMgr.setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL,"JSJaCHttpPollingConnection.prototype._handleInitialResponse inQto");this._getStreamID();};JSJaCHttpPollingConnection.prototype._parseResponse=function(a){var h=a.r;if(!this.connected()){return null;}if(h.status!=200){this.oDbg.log("invalid response ("+h.status+"):"+h.responseText+"\n"+h.getAllResponseHeaders(),1);
this._setStatus("internal_server_error");QzTimerMgr.clearTimeout(this._timeout);QzTimerMgr.clearInterval(this._interval);QzTimerMgr.clearInterval(this._inQto);this._connected=false;this._lastAck=null;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));
return null;}this.oDbg.log(h.getAllResponseHeaders(),4);var b,j=h.getResponseHeader("Set-Cookie");if(j==null){b="-1:0";}else{j=j.split(";");var b;for(var d=0;d<j.length;d++){var g=j[d].split("=");if(g[0]=="ID"){b=g[1];}}}if(typeof(b)!="undefined"&&b.indexOf(":0")!=-1){switch(b.substring(0,b.indexOf(":0"))){case"0":this.oDbg.log("invalid response:"+h.responseText,1);
break;case"-1":this.oDbg.log("Internal Server Error",1);break;case"-2":this.oDbg.log("Bad Request",1);break;case"-3":this.oDbg.log("Key Sequence Error",1);break;}this._setStatus("internal_server_error");QzTimerMgr.clearTimeout(this._timeout);QzTimerMgr.clearInterval(this._interval);QzTimerMgr.clearInterval(this._inQto);
this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error"));this._connected=false;this._lastAck=null;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");return null;}if(!h.responseText||h.responseText==""){return null;}try{var c=h.responseText.replace(/\<\?xml.+\?\>/,"");
if(c.match(/<stream:stream/)){c+="</stream:stream>";}var k=JSJaCHttpPollingConnection._parseTree("<body>"+c+"</body>");if(!k||k.tagName=="parsererror"){this.oDbg.log("parsererror",1);k=JSJaCHttpPollingConnection._parseTree("<stream:stream xmlns:stream='http://etherx.jabber.org/streams'>"+h.responseText);
if(k&&k.tagName!="parsererror"){this.oDbg.log("stream closed",1);if(k.getElementsByTagName("conflict").length>0){this._setStatus("session-terminate-conflict");}QzTimerMgr.clearTimeout(this._timeout);QzTimerMgr.clearInterval(this._interval);QzTimerMgr.clearInterval(this._inQto);this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate"));
this._connected=false;this._lastAck=null;this.oDbg.log("Disconnected.",1);this._handleEvent("ondisconnect");}else{this.oDbg.log("parsererror:"+k,1);}return k;}return k;}catch(f){this.oDbg.log("parse error:"+f.message,1);}return null;};JSJaCHttpPollingConnection.prototype._reInitStream=function(c,b,a){this._sendRaw("<stream:stream xmlns:stream='http://etherx.jabber.org/streams' xmlns='jabber:client' to='"+c+"' version='1.0'>",b,a);
};JSJaCHttpPollingConnection.prototype._resume=function(){this._process(this._timerval);};JSJaCHttpPollingConnection.prototype._setupRequest=function(a){var c=XmlHttp.create();try{c.open("POST",this._httpbase,a);if(c.overrideMimeType){c.overrideMimeType("text/plain; charset=utf-8");}c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
}catch(d){this.oDbg.log(d,1);}var b=new Object();b.r=c;return b;};JSJaCHttpPollingConnection.prototype._suspend=function(){};JSJaCHttpPollingConnection._parseTree=function(a){try{var b=XmlDocument.create("body","foo");if(typeof(b.loadXML)!="undefined"){b.loadXML(a);return b.documentElement;}else{if(window.DOMParser){return(new DOMParser()).parseFromString(a,"text/xml").documentElement;
}}}catch(c){}return null;};var JSJaC={Version:"$Rev$",require:function(a){document.write('<script type="text/javascript" src="'+a+'"><\/script>');},load:function(){var c=["xmlextras","jsextras","crypt","JSJaCConfig","JSJaCConstants","JSJaCCookie","JSJaCJSON","JSJaCJID","JSJaCBuilder","JSJaCPacket","JSJaCError","JSJaCKeys","JSJaCConnection","JSJaCHttpPollingConnection","JSJaCHttpBindingConnection","JSJaCConsoleLogger"];
var a=document.getElementsByTagName("script");var d="./";for(var b=0;b<a.length;b++){if(a.item(b).src&&a.item(b).src.match(/JSJaC\.js$/)){d=a.item(b).src.replace(/JSJaC.js$/,"");break;}}for(var b=0;b<c.length;b++){this.require(d+c[b]+".js");}},bind:function(b,c,a){return function(d){return b.apply(c,[d,a]);
};}};if(typeof JSJaCConnection=="undefined"){JSJaC.load();}var SXC={_lastAccountInfo:null,_serviceBaseUrl:null,getAnonymousNodeId:function(){return"_"+uuid(8,62);},verify:function(h,g,e){if(h==null){throw new Error("access_info could not be NULL.");}if(g==null){throw new Error("callback could not be NULL.");
}if(h.service_base_url==null){throw new Error("access_info.service_base_url could not be NULL.");}SXC._serviceBaseUrl=h.service_base_url;var f="chat";var a=h.service_base_url.lastIndexOf(f);if(a==h.service_base_url.length-f.length){var b={"number_prefix":"","service":{"chat_url":h.service_base_url,"acd_node_id":h.acd_node_id==null?"acd":h.acd_node_id},"q":SXC.getAnonymousNodeId(),"c":h.agent_id,"agent":{"agent_id":h.agent_id,"agent_password":h.agent_password},"p":{"n":h.nick_name==null?h.agent_id:h.nick_name}};
g(b);}else{var c=(h.service_base_url=="/"?"":h.service_base_url)+"/ucm/api/agent/verify";var d={};if(h.gt==null||h.gt==""){d.realm=h.realm;d.agent_id=h.agent_id;d.nounce=new UUID().id;d.third_validate_url=h.third_validate_url;d.signature=hex_md5("verify:"+d.agent_id+":"+d.nounce+":"+d.realm+":"+h.agent_password);
}else{d.gt=h.gt;}if(!SXC.notUseCrossVerify){$.ajax({url:c,type:"POST",dataType:"jsonp",data:d,timeout:6000,jsonp:"callback",success:function(i){if(d.third_validate_url){i.agent={"agent_id":h.agent_id,"agent_password":h.agent_password};}g(i);},error:function(i,k,j){if(e){e("crossVerify error. errorThrown:"+j);
}}});}else{$.ajax({type:"POST",url:c,data:d,contentType:"application/x-www-form-urlencoded; charset=utf-8",success:function(i){if(d.third_validate_url){i.agent={"agent_id":h.agent_id,"agent_password":h.agent_password};}g(i);},error:function(j,m,l){var i={};try{i=JSON.parse(j.responseText);}catch(k){}if(e){e(j,m);
}}});}}},getAccountInfo:function(){return SXC._lastAccountInfo;},getServiceBaseUrl:function(){return SXC._serviceBaseUrl;},getWebChatUrl:function(a){if(window.WeiboConfig&&window.WeiboConfig.DEFAULT_CHAT_SERVER_BASE_URL){return window.WeiboConfig.DEFAULT_CHAT_SERVER_BASE_URL;}if(a.chat_url_web_https&&a.chat_url_web_https.toLowerCase().indexOf(window.location.protocol)>=0){return a.chat_url_web_https;
}var b=a.chat_url_web;if(b==null||b==""){b=a.chat_url;}return b;},connect:function(b){var a=true;if(SXC._useExistsXmppDirectMessageMgr){a=false;}if(a&&SXD.isConnected()){SXD.disconnect();}if(SXC._lastAccountInfo){SXC._connect(SXC.getWebChatUrl(SXC._lastAccountInfo.service),SXC._lastAccountInfo.q,SXC._lastAccountInfo.c);
}else{SXC.verify(b,function(e){SXC._lastAccountInfo=e;if(!e.agent||e.agent.agent_id==null||e.agent.agent_id==""){alert("用户的座席属性未正确配置。请检查是否启用了外部座席。");return;}function f(){var h=false;if(!e.service_backup){return false;}if(e.service_backup.chat_url&&(e.service_backup.chat_url.indexOf(window.location.host)>=0)){e.service.chat_url=e.service_backup.chat_url;
h=true;}if(e.service_backup.cm_host&&e.service_backup.cm_host==window.location.host){e.service.cm_host=e.service_backup.cm_host;if(e.service_backup.cm_sip_port){e.service.cm_sip_port=e.service_backup.cm_sip_port;}h=true;}if(!h&&b.service_base_url.split("//")>1){var g=b.service_base_url.split("//")[1];
if(e.service_backup.chat_url&&(e.service_backup.chat_url.indexOf(g)>=0)){e.service.chat_url=e.service_backup.chat_url;h=true;}if(e.service_backup.cm_host&&e.service_backup.cm_host==g){e.service.cm_host=e.service_backup.cm_host;if(e.service_backup.cm_sip_port){e.service.cm_sip_port=e.service_backup.cm_sip_port;
}h=true;}}return h;}var d=f();if(!d){var c=SXC._dispatchEvent("onServerConfig",e);SAM._dispatcher.dispatchEvent(c);}SAM._initialize(e.service.acd_node_id);SXC._dispatchEvent("onVerifySuccess",e);SXC._connect(SXC.getWebChatUrl(SXC._lastAccountInfo.service),SXC._lastAccountInfo.q,SXC._lastAccountInfo.c);
},function(c,d){SAM._initialize(null);SXC._dispatchEvent("onVerifyFailed",c.responseText?c.responseText:c);});}},_connect:function(c,f,a){SXC._init(f);var b=function(){if(SXC._useExistsXmppDirectMessageMgr&&SXC.isConnected()){log.debug("SXC.isConnected() is:"+SXC.isConnected());setTimeout(function(){log.debug("again:SXC.isConnected() is:"+SXC.isConnected());
if(SXC.isConnected()){SXC._onConnect();}},100);}};try{if(SXD.isConnected()){b();}else{SXD.connect(c,f,a,SXC._buildResource());}}catch(d){log.error("connect error of:"+d);b();}},addEventListener:function(a,b){this._dispatcher.addEventListener(a,null,b);},removeEventListener:function(a){this._dispatcher.removeEventListener(a);
},disconnect:function(){SXC._lastAccountInfo=null;SXD.disconnect();},isConnected:function(){return SXD.isConnected();},_clientHeartBeatInterval:null,_lastBoshResponse:0,_slientSeconds:0,_onBoshResponse:function(){_lastBoshResponse=new Date().getTime();},startClientHeartBeat:function(a){if(a>60||a<10){throw new Error("slientSeconds must be [10,60]");
}this._slientSeconds=a;this.stopClientHeartBeat();this._clientHeartBeatInterval=setInterval(function(){if(!SXC.isConnected()){return;}var b=new Date().getTime();if((b-this._lastBoshResponse)>(this._slientSeconds*1000)){SXD.sendEmpty();}},1*1000);},stopClientHeartBeat:function(){if(this._clientHeartBeatInterval){clearInterval(this._clientHeartBeatInterval);
this._clientHeartBeatInterval=null;}},isEnableClientHeartBeat:function(){return this._clientHeartBeatInterval!=null;},getRecvMsgCount:function(){return SXC._recvMsgCount;},getChtsvrDomain:function(){var a=SXD.chtsvrDomain;log.debug("[ChatMgr.getChtsvrDomain]domain:"+a);return a;},getFullJid:function(){var a="";
if(!!SXD.connection){a=SXD.connection.fulljid;}return a;},getResource:function(){var a="";if(!!SXD.connection){a=SXD.connection.resource;}return a;},send:function(a){SXD.send(a);},sendIq:function(d,e,b,a){d.setID(CommonReqMgr.getNextReqId());if(e){var c=CommonReqMgr.CALL_TIMEOUT_MILI_SECONDS;if(a!=null){c=a*1000;
}CommonReqMgr.putRequest(d.getID(),e,b,c);}SXD.send(d);},_userNode:null,_recvMsgCount:0,_useExistsXmppDirectMessageMgr:false,_dispatcher:new EventDispatcher("SXC"),_dispatchEvent:function(b,c){var a={"eventType":b,"data":c};this._dispatcher.dispatchEvent(a);return a;},initWithDirectMessageMgr:function(a){window._oldSXD=window.SXD;
window.SXD=a;window.SXD.feature="co-used.";SXC._useExistsXmppDirectMessageMgr=true;SXC._init();},unInit:function(){SXD.onNewMessage2=null;SXD.onConnect2=null;SXD.onDisconnect2=null;SXD.onAuthError2=null;SXD.onNewIq2=null;SXD.onNewPresence2=null;window.SXD=window._oldSXD;SXC._useExistsXmppDirectMessageMgr=false;
},_init:function(a){SXC._userNode=a;SXD.onNewMessage2=SXC._dealWithXmppMessage;SXD.onConnect2=SXC._onConnect;SXD.onDisconnect2=SXC._onDisconnect;SXD.onAuthError2=SXC._onAuthError;SXD.onNewIq2=SXC._onNewIq;SXD.onNewPresence2=SXC._onNewPresence;SXD.onBoshResponse=SXC._onBoshResponse;},_onNewPresence:function(a){SXC._dispatchEvent("onPresence",a);
},_onNewIq:function(b){log.debug("SXC.onNewIq iq.xml:"+b.xml());if((b.getType()=="error")||(b.getType()=="result")){if(CommonReqMgr.hasRequest(b.getID())){b.errorReason=SXC._getIqErrorReason(b);CommonReqMgr.triggerCallback(b.getID(),b);}}else{var a=ChatMgr._createEventObject();a.eventType=ChatMgr.EVENT_NEW_IQ_REQUEST;
a.eventInfo=b;SXC._dispatchEvent(a);}},_getIqErrorReason:function(a){var c="";if(a&&a.doc){var d=a.doc;var b=d.getElementsByTagName("error");if(b.length>0){c=QzXmlTool.getChildTextContentByName(b[0],"appError");if(c==""){c=QzXmlTool.getChildAttributeByName(b[0],"appError","code");}a.errorCode=QzXmlTool.getChildAttributeByName(b[0],"appError","code");
}}else{if(a&&a.reason){c=a.reason;}}return c==null?"":c;},_getChildByNameAndNameSpace:function(b,c,a){var e=b.getElementsByTagName(c);if(e.length>0){for(var d=0;d<e.length;d++){var f=e[d];if(a){if(f.namespaceURI==a||f.getAttribute("xmlns")==a){return f;}}else{return f;}}}},_lastResourceId:null,_buildResource:function(){if(SXC._lastResourceId){return SXC._lastResourceId;
}if(window.XStorage){SXC._lastResourceId=XStorage._get("_last_resource_id");}if(SXC._lastResourceId!=null&&SXC._lastResourceId!=""){return SXC._lastResourceId;}SXC._lastResourceId="pc.";SXC._lastResourceId+=navigator.platform+".";SXC._lastResourceId+=SimpleXCrossBrowser.getBroswerType()+".";SXC._lastResourceId+=Math.floor(Math.random()*9999);
SXC._lastResourceId=SXC._lastResourceId.replace(/ /ig,"_");if(window.XStorage){XStorage._set("_last_resource_id",SXC._lastResourceId);}return SXC._lastResourceId;},_dealWithXmppMessage:function(d){log.info("[SXC]dealWithXmppMessage start xmppMessage.xml:"+d.jMessage.xml());try{var b=d.from;var a=d.type;
if(WeiboConfig.webServerNodeNameOnChatServer==b){SXC._dealBusinessMsg(d);}else{if("normal"==a){SXC._dealNormalMsg(d);}else{SXC._dealChatMsg(d);}}}catch(c){log.error(c,"SXC.dealWithXmppMessage, error.");throw c;}finally{log.debug("[SXC]dealWithXmppMessage stop");}},_getChildWithXMLNS:function(c,b,d){log.debug("SXC._getChildWithXMLNS try to find:"+b+", xmlns:"+d);
var a=c.firstChild;while(a){if(!a.tagName){a=a.nextSibling;continue;}log.debug("childElement.tagName is:"+a.tagName+", getAttribute.xmln is:"+a.getAttribute("xmlns"));if((a.tagName==b)&&(a.namespaceURI==d||a.getAttribute("xmlns")==d)){log.debug("found this element");return a;}a=a.nextSibling;}return null;
},_tryDealWithRoomInvite:function(d){log.debug("RoomMgr._tryDealWithRoomInvite start");try{if(d.getType()=="groupchat"){log.debug("This messge type is groupchat, so this is not invite.");return false;}var a=SXC._getChildWithXMLNS(d.getNode(),"x","http://jabber.org/protocol/muc#user");if(a){var b=SXC._getChildByNameAndNameSpace("invite");
if(b){var c=d.getFromJID().getNode();log.debug("receive Room Invite, try join room:"+c+", invite from user:"+b.getAttribute("from"));log.info("Ignore Room Invite");}return true;}return false;}finally{log.debug("RoomMgr._tryDealWithRoomInvite stop");}},_tryDealWithRoomChangedMsg:function(d){log.debug("RoomMgr._tryDealWithRoomChangedMsg start");
try{var a=SXC._getChildWithXMLNS(d.getNode(),"x","http://jabber.org/protocol/muc#user");if(a){var b=SXC._getChildByNameAndNameSpace(a,"status");if(b){var c=d.getFromJID().getNode();if(b.getAttribute("code")=="104"){log.debug("room config changed. room id:"+c);log.info("Ignore the room change info.");
}}return true;}var a=SXC._getChildWithXMLNS(d.getNode(),"x","http://jabber.org/protocol/muc#owner");if(a){log.info("Ignore the muc#owner info.");return true;}return false;}finally{log.debug("RoomMgr._tryDealWithRoomChangedMsg stop");}},_dealWithConferenceUpdateEvent:function(d,a){log.debug("[SXC]_dealWithConferenceUpdateEvent start.");
var c=d.jMessage;var b=SXC._getChildWithXMLNS(c.getNode(),"event","http://cm.weibocall.com/conf");if(!b){return false;}return true;},_dealNormalMsg:function(a){SXC._dispatchEvent("onRecvNormalMsg",a);},_dealBusinessMsg:function(a){SXC._dispatchEvent("onRecvBusinessMsg",a);},_dealChatMsg:function(a){if(a.type=="error"){log.error("Ignore error type of message");
return;}if(SXC._tryDealWithRoomInvite(a.jMessage)){return;}if(SXC._tryDealWithRoomChangedMsg(a.jMessage)){return;}if(SXC._dealWithConferenceUpdateEvent(a,true)){return;}if(a.personalAssistant&&a.personalAssistant.type==WeiboConfig.personalAssistantType.fax){return;}log.info("SXC._dealChatMsg will continue to deal with msg:"+a.jMessage.xml());
if(SXC._userNode==a.from){}else{SXC._recvMsgCount++;SXC._dispatchEvent("onRecvChatMsg",a);}},_onConnect:function(){log.debug("SXC._onConnect");SXC._recvMsgCount=0;var a={"current_service":SXD.getCurrentHttpBase()};SXC._dispatchEvent("onConnect",a);},_onDisconnect:function(){SXC._recvMsgCount=0;SXC._dispatchEvent("onDisconnect");
},_onAuthError:function(a){SXC._recvMsgCount=0;SXC._dispatchEvent("onAuthError",a);}};var log={getCurrentTime:function(){var d=new Date();var e=d.getYear();e=(e<1900?(1900+e):e);var f=d.getMonth()+1;var b=d.getDate();var a=d.getHours();var g=d.getMinutes();var c=d.getSeconds();return e+"-"+log.addZeroPrefixToNumber(f)+"-"+log.addZeroPrefixToNumber(b)+" "+log.addZeroPrefixToNumber(a)+":"+log.addZeroPrefixToNumber(g)+":"+log.addZeroPrefixToNumber(c);
},addZeroPrefixToNumber:function(a){if(a<10){return"0"+a;}else{return a;}},debug:function(a){if(window.console&&window.console.log){console.log(log.getCurrentTime()+" [debug] "+a);}},error:function(a){if(window.console&&window.console.log){console.log(log.getCurrentTime()+" [error] "+a);}},info:function(a){if(window.console&&window.console.log){console.log(log.getCurrentTime()+" [info] "+a);
}},fatal:function(a){if(window.console&&window.console.log){console.log(log.getCurrentTime()+" [fatal] "+a);}}};var WeiboConfig=WeiboConfig||{};WeiboConfig.webServerNodeNameOnChatServer="weibocall";WeiboConfig.groupNotifyNodeNameOnChatServer="groupNotify";WeiboConfig.cmNameOnChatServer="cm";WeiboConfig.billAssistantNodeNameOnChatServer="bill_assistant";
WeiboConfig.taskAssistantNodeNameOnChatServer="task_assistant";WeiboConfig.personalAssistantNodeNameOnChatServer="person_assistant";WeiboConfig.personalAssistantType={fax:"fax",voice:"voice"};function XMPPConsoleLogger(a){this.level=a||4;this.start=function(){};this.log=function(c,d){d=d||4;if(d>this.level){return;
}if(typeof(console)=="undefined"){return;}try{switch(d){case 0:log.fatal(c);break;case 1:log.error(c);break;case 2:log.info(c);break;case 3:log.debug(c);break;case 4:log.debug(c);break;default:log.debug(c);break;}}catch(b){try{log.error(c);}catch(b){}}};this.setLevel=function(b){this.level=b;return this;
};this.getLevel=function(){return this.level;};}SimpleXmppClient=SXC;function SXD(){}function XmppConnArgs(a){this.httpbase=a;this.timerval=2000;this.oDbg=new XMPPConsoleLogger();this.useDirectAuth=true;}function XmppUserArgs(c,a,b){this.username=c;this.pass=a;this.resource=b;this.authtype="plain";this.register=false;
}XmppUserArgs.prototype.getJid=function(){return this.username+"@/"+this.resource;};function XmppMesssage(){this.type="";this.from="";this.to="";this.subject="";this.body="";this.htmlbody="";this.server_id="";this.jMessage=null;this.geolocInfo=null;this.billNotify=null;}SXD.connection=null;SXD.connArgs=null;
SXD.userArgs=null;SXD.status="";SXD.chtsvrDomain="";SXD.firstTimeLoad=false;SXD.onConnect2=function(){};SXD.onDisconnect2=function(){};SXD.onNewMessage2=function(a){};SXD.onNewPresence2=function(a){};SXD.onNewIq2=function(a){};SXD.onAuthError2=function(a){};SXD.send=function(a){log.debug("[SXD.send]start.");
SXD.checkConnection();if(a){log.debug("SXD.send xml is:"+a.xml());SXD.connection.send(a);}log.debug("[SXD.send]end.");};SXD.sendEmpty=function(){if(SXD.connection){log.debug("SXD.sendEmpty xml.");return SXD.connection.sendEmpty(xmppPacket);}else{return false;}};SXD.connect=function(a,d,c,f){if(SXD.connection&&SXD.isConnected()){throw log.error("SXD.connect cannot make new connect.");
}var b=new XmppConnArgs(a);var e=new XmppUserArgs(d,c,f);SXD.connArgs=b;SXD.userArgs=e;SXD.doConnect("SimpleClient.SXD.connect");};SXD.getCurrentHttpBase=function(){return SXD.connArgs?SXD.connArgs.httpbase:"";};SXD.changeConnectParams=function(a,d,c,f){var b=new XmppConnArgs(a);var e=new XmppUserArgs(d,c,f);
SXD.connArgs=b;SXD.userArgs=e;};SXD._quit=function(){log.error("simple xmpp:user want to quit xmpp.");if(SXD.connection){var a=new JSJaCPresence();a.setType("unavailable");SXD.connection.send(a);SXD.connection.disconnect();}};SXD._disconnect=function(){if(SXD.connection){SXD._quit();SXD.connection=null;
}};SXD.disconnect=function(){SXD._disconnect();if(SXD.onAfterDisconnect){try{SXD.onAfterDisconnect();}catch(a){setTimeout(function(){log.error("error when onAfterDisconnect:"+a);throw a;},600);}}};SXD.doConnect=function(c){log.info("SXD.doConnect start. reason:"+c);var a=SXD.connArgs;if(SXD.onBeforeConnect){try{var d=SXD.onBeforeConnect(SXD.connArgs);
if(d){SXD.connArgs=d;}}catch(b){setTimeout(function(){log.error("error when onBeforeConnect:"+b);throw b;},600);}}SXD.connection=new JSJaCHttpBindingConnection(SXD.connArgs);SXD.regHandlers();try{SXD.connection.connect(SXD.userArgs);log.info("SXD.doConnect end. reason:"+c);}catch(b){log.error("SXD.doConnect error of:"+b);
SXD._handleError(b);}};SXD.regHandlers=function(){if(!!SXD.connection){SXD.connection.registerHandler("message",SXD._handleMessage);SXD.connection.registerHandler("presence",SXD._handlePresence);SXD.connection.registerHandler("iq",SXD._handleIQ);SXD.connection.registerHandler("packet_in",SXD._handlePacket);
SXD.connection.registerHandler("bosh_response",SXD._handleBoshResponse);SXD.connection.registerHandler("onconnect",SXD._onConnect);SXD.connection.registerHandler("onerror",SXD._handleError);SXD.connection.registerHandler("status_changed",SXD._handleStatusChanged);SXD.connection.registerHandler("ondisconnect",SXD._handleDisconnected);
}};SXD.makeAutoConnect=function(){log.info("SXD.makeAutoConnect trigered.");setTimeout(function(){if(SXD.connection&&!SXD.isConnected()){SXD.doConnect("auto_connect");}else{log.info("SXD.makeAutoConnect there is't need connect.");}},1000*10);};SXD.isConnected=function(){if(!!SXD.connection){return SXD.connection.connected();
}else{return false;}};SXD.checkConnection=function(){if(!SXD.connection){throw log.error("SXD.connection is NULL.");}};SXD._onConnect=function(){log.debug("[SXD]_onConnect start.");SXD.firstTimeLoad=true;SXD.chtsvrDomain=SXD.getDomainFromJid(SXD.connection.fulljid);var a=new JSJaCPresence();SXD.send(a);
SXD.onConnect2();log.debug("[SXD]_onConnect end.");};SXD.getDomainFromJid=function(a){var c="";var b=a?a.split("/")[0]:null;if(b.indexOf("@")<0){c=b;}else{var d=b.split("@");d.splice(0,1);c=d.join("@");}log.debug("[SXD.getDomainFromJid]jid:"+a+", domain:"+c);return c;};SXD._handleIQ=function(a){SXD.onNewIq2(a);
};SXD.convertJsJacMessageToXmppMessage=function(N){var k=N;try{var B=new XmppMesssage();B.jMessage=k;var q,f;B.type=k.getType();B.to=k.getToJID().getNode();if(B.type=="error"){log.error("[SXD]convertJsJacMessageToXmppMessage message type is error, please take a look.");}else{if((B.type=="chat")||(B.type=="")||(!B.type)){k.setType("chat");
B.type="chat";B.from=k.getFromJID().getNode();B.replyTo=B.from;}else{if(B.type=="groupchat"){B.from=k.getFromJID().getResource();B.roomId=k.getFromJID().getNode();if(B.from==WeiboConfig.webServerNodeNameOnChatServer){B.from=WeiboConfig.groupNotifyNodeNameOnChatServer;}B.replyTo=B.roomId;}else{B.from=k.getFromJID().getNode();
B.replyTo=B.from;}}}var h=k.getNode();var r=h.getElementsByTagName("body");if(r){for(var J=0;J<r.length;J++){q=r[J];if(q.parentNode.nodeName=="html"){}else{if(q.parentNode.nodeName=="message"){if(q.childNodes.length>0){B.body=q.childNodes.item(0).nodeValue;B.htmlbody=B.body;}}}}}f=k.getSubject();if(f){B.subject=f;
}var d=h.getAttribute("t");if(d){B.sendTime=d;}else{var n=h.getElementsByTagName("delay");if(n.length>0){var m=n[0].getAttribute("stamp");if(m){B.sendTime=m;}}}B.server_time=B.sendTime;var L=h.getElementsByTagName("read");if(L&&(L.length>0)){B.hasRead=true;}var u=h.getAttribute("server_id");if(!!u){B.server_id=u;
}B.nick_name=QzXmlTool.getChildTextContentByName(h,"n");function b(){var S=h.getElementsByTagName("error");if(S.length>0){B.errors=[];}for(var j=0;j<S.length;j++){var e={"type":S[j].getAttribute("type")};B.errors.push(e);}}b();var z=h.getElementsByTagName("x");for(var J=0;J<z.length;J++){if(z[J].getAttribute("xmlns")=="uc.qingzhi-net.com/message#files"||z[J].namespaceURI=="uc.qingzhi-net.com/message#files"){var K=z[J].getElementsByTagName("file");
if(K&&K.length>0){var A=new Array();var p=false;for(var H=0;H<K.length;H++){var D=K[H];var G=new Object();var g=D.getAttribute("lq_res");if(!g){g=D.getAttribute("fileId");}G.lq_res=g;G.mode=D.getAttribute("mode");G.name=D.getAttribute("name");G.size=D.getAttribute("size");G.type=D.getAttribute("type");
G.url=D.getAttribute("url");G.thumb_url=D.getAttribute("thumb_url");G.efs_relative_url=D.getAttribute("efs_relative_url");G.url_expire=D.getAttribute("url_expire");G.url_mp3=D.getAttribute("url_mp3");G.relative_url_mp3=D.getAttribute("efs_relative_url_mp3");G.width=D.getAttribute("width");G.height=D.getAttribute("height");
G.length=D.getAttribute("length");G.enable_thumb=D.getAttribute("enable_thumb");G.withAttachMsg=D.getAttribute("withAttachMsg");G.md5=D.getAttribute("md5");if(G.withAttachMsg){p=true;}A.push(G);}B.fileList=A;B["withAttachMsg"]=p;}}else{if(z[J].getAttribute("xmlns")=="http://jabber.org/protocol/geoloc"||z[J].namespaceURI=="http://jabber.org/protocol/geoloc"){var w=z[J].getElementsByTagName("geoloc");
if(w&&w[0]){var a=w[0];if(a.childNodes&&a.childNodes.length>=4){var l=new GeolocInfo();if(typeof window.XMLSerializer!="undefined"){l.accuracy=a.getElementsByTagName("accuracy")[0].textContent;l.lat=a.getElementsByTagName("lat")[0].textContent;l.lon=a.getElementsByTagName("lon")[0].textContent;l.locality=a.getElementsByTagName("locality")[0].textContent;
}else{l.accuracy=a.getElementsByTagName("accuracy")[0].text;l.lat=a.getElementsByTagName("lat")[0].text;l.lon=a.getElementsByTagName("lon")[0].text;l.locality=a.getElementsByTagName("locality")[0].text;}var M=a.getElementsByTagName("coord");if(M){var s=new Array();for(var H=0;H<M.length;H++){var c=M[H];
l.type=c.getAttribute("type");l.lat=c.getAttribute("lat");l.lon=c.getAttribute("lon");break;}}B.geolocInfo=l;}}}else{if(z[J].getAttribute("xmlns")=="qzuc.bulletin.notification"||z[J].namespaceURI=="qzuc.bulletin.notification"){var t={};var Q=z[J].getElementsByTagName("bulletin");if(Q&&Q[0]){if(typeof window.XMLSerializer!="undefined"){t=Q[0].textContent;
}else{t=Q[0].text;}if(t){t=JSON.parse(t);}}B.bulletinNotify=t;}else{if(z[J].getAttribute("xmlns")=="qzuc.bill.notification"||z[J].namespaceURI=="qzuc.bill.notification"){var x={};var o=z[J].getElementsByTagName("bill");if(o&&o[0]){if(typeof window.XMLSerializer!="undefined"){x.bill=o[0].textContent;}else{x.bill=o[0].text;
}if(x.bill){x.bill=JSON.parse(x.bill);}}var y=z[J].getElementsByTagName("reason");if(y&&y[0]){if(typeof window.XMLSerializer!="undefined"){x.reason=y[0].textContent;}else{x.reason=y[0].text;}if(x.reason){x.reason=JSON.parse(x.reason);}}B.billNotify=x;}else{if(z[J].getAttribute("xmlns")=="qzuc.msg"||z[J].namespaceURI=="qzuc.msg"){var C={};
var R=z[J].getAttribute("type");var v=null;var I=null;if(typeof window.XMLSerializer!="undefined"){v=z[J].textContent;}else{v=z[J].text;}if(v){I=JSON.parse(v);}C.type=R;if(I){if(R=="voicemsg"){C.attach=I.attach;C.fromNumber=I.from_call_number;C.fromUser=I.from_user;}else{if(R=="fax"){C.fax=I.fax;}}}B.personalAssistant=C;
}else{if(z[J].getAttribute("xmlns")=="uc.qingzhi.xuser"||z[J].namespaceURI=="uc.qingzhi.xuser"){B.xuser=xml2json(z[J]);B.xuser.ni=k.getFromJID().getNode();}else{if(z[J].getAttribute("xmlns")=="uc.qingzhi.session"||z[J].namespaceURI=="uc.qingzhi.session"){var F=xml2json(z[J]);if(F.s){B.session={"id":F.s["#text"],"first":!(F.first===undefined)};
if(F.remotehost){B.session.remote_host=F.remotehost["#text"];}}}else{if(z[J].getAttribute("xmlns")=="uc.qingzhi.session/stop"||z[J].namespaceURI=="uc.qingzhi.session/stop"){B.session_stop=true;}else{if(z[J].getAttribute("xmlns")=="uc.onesoul.show.template/json"||z[J].namespaceURI=="uc.onesoul.show.template/json"){var v=null;
if(typeof window.XMLSerializer!="undefined"){v=z[J].textContent;}else{v=z[J].text;}if(v){try{B.showTemplateInfo=JSON.parse(v);}catch(P){}}}else{if(z[J].getAttribute("xmlns")=="onesoul.cn/inputing/preview"||z[J].namespaceURI=="onesoul.cn/inputing/preview"){B.inputingPreview={};B.inputingPreview.stop=z[J].getAttribute("stop");
}else{if(z[J].getAttribute("xmlns")=="uc.onesoul/extends"||z[J].namespaceURI=="uc.onesoul/extends"){var v=null;if(typeof window.XMLSerializer!="undefined"){v=z[J].textContent;}else{v=z[J].text;}if(v){try{B["extends"]=JSON.parse(v);}catch(P){}}}}}}}}}}}}}}var E=h.getElementsByTagName("callerInfo");if(E&&E.length>0){var O="";
if(typeof window.XMLSerializer!="undefined"){O=E[0].textContent;}else{O=E[0].text;}try{B.callerInfo=JSON.parse(new Base64().decode(O));B.callerInfoX=B.callerInfo;}catch(P){log.error("decode caller info error:"+P);}}}catch(P){log.error("[SXD]convertJsJacMessageToXmppMessage "+P);}return B;};SXC._handleBoshResponse=function(){if(SXD.onBoshResponse){SXD.onBoshResponse();
}};SXD._handlePacket=function(a){log.debug("[SXD]_handlePacket start:"+a.name);if(a.name=="a"){SXD._handleAck(a);}return true;};SXD._handleAck=function(d){log.debug("[SXD]_handleAck start");try{if(SXD.onMessageAck){var a={msg_id:d.getAttribute("id"),server_id:d.getAttribute("server_id")};var b=d.getNode().getElementsByTagName("t");
if(b&&(b.length>0)){a.server_time=b[0].textContent?b[0].textContent:b[0].text;SXD.onMessageAck(a);}}}catch(c){log.error("[SXD]_handleAck "+c);}log.debug("[SXD]_handleAck end.:");return true;};SXD.appendFileNode=function(a,f){var i=a.getDoc();var h=JSJaCBuilder.createElement(i,"x","uc.qingzhi-net.com/message#files");
var d=false;var b=i.createElement("file");for(var c in f){if(f[c]){try{b.setAttribute(c,f[c]);}catch(g){console.log("XmppDirectMessageMgr.generatorFileNode:"+g);}}if(c=="withAttachMsg"){d=true;}}if(d){h.setAttribute("withAttachMsg","true");}h.appendChild(b);a.getNode().appendChild(h);};SXD._handleMessage=function(a){log.debug("[SXD]_handleMessage start.");
try{var c=SXD.convertJsJacMessageToXmppMessage(a);if(SXD.onNewMessage2){SXD.onNewMessage2(c);}c.jMessage=null;}catch(b){log.error("[SXD]_handleMessage "+b);}log.debug("[SXD]_handleMessage end.xmppMessage:"+JSON.stringify(c));return true;};SXD._handlePresence=function(e){log.debug("[SXD]_handlePresence start.");
var f=new XmppMesssage();var c,d,a,b;f.from=e.getFromJID();f.type=e.getType();if(SXD.onNewPresence2){SXD.onNewPresence2(f,e);}log.debug("[SXD]_handlePresence end.xmppMessage:"+JSON.stringify(f));return true;};SXD._handleError=function(c){try{if(SXD.isConnected()){SXD._quit();}}catch(a){log.error("SXD._handleError, error:"+a+JSON.stringify(a));
}try{if(c!=null){log.error("connect error. please check the host, user id and token.");var b=c.message;try{if(c.getAttribute("type")){b=c.getAttribute("type");}}catch(d){}if(SXD.onAuthError2){SXD.onAuthError2(b);}}}finally{SXD.makeAutoConnect();}};SXD._handleStatusChanged=function(a){};SXD._handleDisconnected=function(){SXD.onDisconnect2();
};SimpleXmppDirectMessageMgr=SXD;var AGENT_STATUS_BUSY=1;var AGENT_CONVSTAT_INVITING=4;var AGENT_CONVSTAT_COMMUNICATING=8;var AGENT_CONVSTAT_SERVING=16;var AGENT_CONVSTAT_MONITORING=32;var AGENT_CONVSTAT_HOLDING=64;var AGENT_CONVSTAT_TRANSFERING=128;var AGENT_CONVSTAT_CALLING=8192;var AGENT_STATUS_AFTERCALLWORK=258;
var AGENT_STATUS_DONTDISTURB=512;var AGENT_STATUS_RESTING=1024;var AGENT_STATUS_FROZEN=2048;var AGENT_STATUS_BUSYNOTIFY=4096;var AGENT_STATUS_STRICTLY_DONTDISTURB=(AGENT_STATUS_DONTDISTURB|AGENT_STATUS_RESTING|AGENT_STATUS_FROZEN);var AGENT_STATUS_BUSY_EXT_MASK=983040;var AGENT_STATUS_MASK=65535;var PBarStateLst=[[AGENT_STATUS_MASK,0,'"CHS:就绪;ENU:IDLE"',1,1],[AGENT_STATUS_FROZEN,AGENT_STATUS_FROZEN,'"CHS:锁定;ENU:FROZEN"',8,8],[AGENT_CONVSTAT_INVITING,AGENT_CONVSTAT_INVITING,'"CHS:正在振铃;ENU:RINGING"',3,3],[AGENT_CONVSTAT_CALLING,AGENT_CONVSTAT_CALLING,'"CHS:正在呼叫;ENU:CALLING"',3,3],[AGENT_CONVSTAT_MONITORING,AGENT_CONVSTAT_MONITORING,'"CHS:正在监听;ENU:MONITORING"',2,2],[AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_TRANSFERING,'"CHS:转接中;ENU:Transfering"',2,2],[AGENT_CONVSTAT_SERVING,AGENT_CONVSTAT_SERVING,'"CHS:接待客户;ENU:SERVING"',2,2],[AGENT_CONVSTAT_COMMUNICATING,AGENT_CONVSTAT_COMMUNICATING,'"CHS:正在通话;ENU:COMMUNICATING"',2,2],[AGENT_CONVSTAT_HOLDING,AGENT_CONVSTAT_HOLDING,'"CHS:保持;ENU:HOLDING"',2,2],[AGENT_STATUS_AFTERCALLWORK,AGENT_STATUS_AFTERCALLWORK,'"CHS:事后处理;ENU:AFTERCALLWORK"',0,0],[AGENT_STATUS_DONTDISTURB,AGENT_STATUS_DONTDISTURB,'"CHS:请勿打扰;ENU:DONTDISTURB"',0,0],[AGENT_STATUS_RESTING,AGENT_STATUS_RESTING,'"CHS:小憩片刻;ENU:RESTING"',4,4],[AGENT_STATUS_BUSY,AGENT_STATUS_BUSY,'"CHS:忙;ENU:BUSY"',0,0]];
var PBarActionLst={usrDo_InviteByOID:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:邀请;ENU:Invite"',1],usrDo_InviteByContact:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:邀请线路;ENU:Invite Line"',1],usrDo_InviteByAgentID:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:邀请坐席;ENU:Invite Agent"',1],usrDo_InviteByAgentGroup:[AGENT_CONVSTAT_SERVING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_SERVING,0,'"CHS:服务请求;ENU:Invite Group"',1],usrDo_TransferByOID:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:转接;ENU:Transfer"',1],usrDo_TransferByContact:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:转接线路;ENU:Transfer to Line"',1],usrDo_TransferByAgentID:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:转接坐席;ENU:Transfer to Agent"',1],usrDo_TransferByAgentGroup:[AGENT_CONVSTAT_SERVING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_SERVING,0,'"CHS:转接请求;ENU:Transfer to Group"',1],usrDo_TransferBlindlyByAgentGroup:[AGENT_CONVSTAT_SERVING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_SERVING,0,'"CHS:盲转请求;ENU:Transfer to Group(Blindly)"',0],usrDo_TransferByOID2:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:转接;ENU:Transfer"',1],usrDo_TransferByContact2:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:转接线路;ENU:Transfer to Line"',1],usrDo_TransferByAgentID2:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:转接坐席;ENU:Transfer to Agent"',1],usrDo_TransferByAgentGroup2:[AGENT_CONVSTAT_SERVING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_SERVING,0,'"CHS:转接请求;ENU:Transfer to Group"',1],usrDo_ConfAfterTransfer:[AGENT_CONVSTAT_TRANSFERING,0,1,'"CHS:三方会议;ENU:Conference"',0],usrDo_KickAfterTransfer:[AGENT_CONVSTAT_TRANSFERING,0,1,'"CHS:挂断对方;ENU:Hangup Tresferee"',0],usrDo_AnswerForOID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:代答;ENU:Answer for"',1],usrDo_AnswerForContact:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:代答线路;ENU:Answer for Line"',1],usrDo_AnswerForAgentID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:代答坐席;ENU:Answer for Agent"',1],usrDo_AnswerForRequest:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:接听;ENU:Answer for"',1],usrDo_MonitorByOID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:监听;ENU:Monitor"',1],usrDo_MonitorByContact:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:监听线路;ENU:Monitor Line"',1],usrDo_MonitorByAgentID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:监听坐席;ENU:Monitor Agent"',1],usrDo_MonitorByConvOID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:监听;ENU:Monitor"',1],usrDo_ChimeInByOID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:插话;ENU:Chime in"',1],usrDo_ChimeInByContact:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:插话线路;ENU:Chime in Line"',1],usrDo_ChimeInByAgentID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:插话坐席;ENU:Chime in Agent"',1],usrDo_ChimeInByConvOID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:插话;ENU:Chime in"',1],usrDo_KickOutByOID:[AGENT_CONVSTAT_TRANSFERING|AGENT_CONVSTAT_COMMUNICATING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:打断;ENU:Kick out"',0],usrDo_KickOutByAgentID:[AGENT_CONVSTAT_TRANSFERING|AGENT_CONVSTAT_COMMUNICATING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:打断坐席;ENU:Kick out Agent"',0],usrDo_TakeOverByOID:[AGENT_CONVSTAT_TRANSFERING|AGENT_CONVSTAT_COMMUNICATING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:接管;ENU:Take over"',1],usrDo_TakeOverByAgentID:[AGENT_CONVSTAT_TRANSFERING|AGENT_CONVSTAT_COMMUNICATING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:接管坐席;ENU:Take over"',1],usrDo_ConvLeave:[AGENT_CONVSTAT_SERVING|AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_CALLING,0,1,'"CHS:挂断;ENU:Leave"',0],usrDo_ConvHold:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:保持;ENU:Hold"',0],usrDo_ConvRetrieve:[AGENT_CONVSTAT_HOLDING,AGENT_CONVSTAT_HOLDING,0,'"CHS:拾回;ENU:Retrieve"',0],usrDo_ConvRecStart:[AGENT_CONVSTAT_SERVING|AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_CALLING,0,1,'"CHS:录音开始;ENU:Record Start"',0],usrDo_ConvRecStop:[0,0,0,'"CHS:录音结束;ENU:Record Stop"',0],agtDo_Login:[0,0,0,'"CHS:签入;ENU:Login"',0],agtDo_Logout:[0,0,0,'"CHS:签出;ENU:Logout"',0],agtDo_ContactChange:[0,0,0,'"CHS:改变联系方式;ENU:Change Contact"',0],agtDo_VirtualBegin:[~(AGENT_STATUS_BUSY|AGENT_STATUS_DONTDISTURB),0,0,'"CHS:开始虚拟;ENU:Virtual Login"',0],agtDo_VirtualEnd:[0,0,0,'"CHS:结束虚拟;ENU:Virtual Logout"',0],agtDo_DontDisturb:[AGENT_STATUS_DONTDISTURB,0,0,'"CHS:请勿打扰;ENU:Don\'t Disturb"',0],agtDo_CanDisturb:[AGENT_STATUS_DONTDISTURB,AGENT_STATUS_DONTDISTURB,0,'"CHS:可以打扰;ENU:Can Disturb"',0],agtDo_Ready:[0,0,0,'"CHS:就绪;ENU:Idle"',0],agtDo_Busy:[0,0,0,'"CHS:置忙;ENU:Busy"',0],agtDo_AfterCallWorkDone:[AGENT_CONVSTAT_SERVING|AGENT_STATUS_AFTERCALLWORK|AGENT_CONVSTAT_HOLDING|AGENT_CONVSTAT_COMMUNICATING,AGENT_STATUS_AFTERCALLWORK,0,'"CHS:完成;ENU:Ready"',0],agtDo_WantResting:[AGENT_STATUS_RESTING,0,0,'"CHS:申请小憩;ENU:Resting"',0],agtDo_IVRTutor:[AGENT_CONVSTAT_COMMUNICATING|AGENT_CONVSTAT_TRANSFERING,AGENT_CONVSTAT_COMMUNICATING,0,'"CHS:IVR辅导;ENU:IVR tutor"',0],agtDo_GrantResting:[0,0,0,'"CHS:批准小憩;ENU:Grant Resting"',0],agtDo_Lock:[0,0,0,'"CHS:锁定坐席;ENU:Lock"',0],agtDo_Unlock:[0,0,0,'"CHS:解锁坐席;ENU:Unlock"',0],agtDo_ForceLogout:[0,0,0,'"CHS:强制签退;ENU:Force Logout"',0],agtDo_ForceIdle:[0,0,0,'"CHS:强制示闲;ENU:Force Idle"',0],agtDo_ForceBusy:[0,0,0,'"CHS:强制示忙;ENU:Force Busy"',0],usrDo_CallByOID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_AFTERCALLWORK|AGENT_STATUS_DONTDISTURB|AGENT_CONVSTAT_HOLDING),0,0,'"CHS:呼叫;ENU:Call"',1],usrDo_CallByContact:[~(AGENT_STATUS_BUSY|AGENT_STATUS_AFTERCALLWORK|AGENT_STATUS_DONTDISTURB|AGENT_CONVSTAT_HOLDING),0,0,'"CHS:呼叫线路;ENU:Call Line"',1],usrDo_CallByAgentID:[~(AGENT_STATUS_BUSY|AGENT_STATUS_AFTERCALLWORK|AGENT_STATUS_DONTDISTURB|AGENT_CONVSTAT_HOLDING),0,0,'"CHS:呼叫坐席;ENU:Call Agent"',1],usrDo_CallByAgentGroup:[~(AGENT_STATUS_BUSY|AGENT_STATUS_AFTERCALLWORK|AGENT_STATUS_DONTDISTURB|AGENT_CONVSTAT_HOLDING),0,0,'"CHS:呼叫请求;ENU:Call Group"',1]};
function checkCanDoAgentAction(b,c){var d=PBarActionLst[b];var a=(c&d[0])==d[1];return d[2]==1?!a:a;}function SAM(){}SAM.versionHistory=["1.0.0.68 支持 call_proceeding 事件","1.0.0.65 支持iqResponse.errorCode 获取操作错误码","1.0.0.51 支持主动呼出给视频客户端;","1.0.0.50 修订上一个版本(1.0.0.49)引入的连接失败后抛出异常的问题;"];SAM.version=SAM.versionHistory[0];
SAM.versionDescription="";SAM.getClient=function(){return SXC;};SAM._useInternalIpPhone=false;SAM.STATUS_OFFLINE="offline";SAM.STATUS_VERIFYING="verifying";SAM.STATUS_CONNECTING="connecting";SAM.STATUS_BREAK="break";SAM.STATUS_JOINING="joining";SAM.STATUS_LOGINED="logined";SAM.status=SAM.STATUS_OFFLINE;
SAM.EVENT_AGENT_STATUS_CHANGE="onAgentStatusChange";SAM.EVENT_SERVICE_START="service_start";SAM.EVENT_SERVICE_PICKUP="service_pickup";SAM.EVENT_SERVICE_END="service_end";SAM.EVENT_SERVICE_COMPLETE="service_complete";SAM.EVENT_SERVICE_PROCCEEDING="service_proceeding";SAM.EVENT_PARTNER_AGENT_STATUS_CHANGE="onAgentPartnerStatusChange";
SAM.EVENT_PARTNER_SERVICE_STATUS_CHANGE="event.partner_service_status_change";SAM.EVENT_PARTNER_XMPP_STATUS_CHANGE="event.partner_xmpp_status_change";SAM.EVENT_CALL_START="call_start";SAM.EVENT_CALL_END="call_end";SAM.EVENT_CALL_SUCCEED="call_succeed";SAM.EVENT_AGENT_STATUS_IS_RESTING="agent_resting";
SAM.addEventListener=function(a,b){SAM._dispatcher.addEventListener(a,null,b);};SAM.removeEventListener=function(a){SAM._dispatcher.removeEventListener(a);};SAM._dispatcher=new EventDispatcher("SAM");SAM._acdNodeId="acd";SAM.isConnected=function(){return SAM.getClient().isConnected();};SAM._lastAutoLogin=null;
SAM._lastChangedStatus=null;SAM.getTelOption=function(){if(SAM._lastAutoLogin){return SAM._lastAutoLogin.telOption;}else{return null;}};SAM.beforeHangup=function(a){if(window.confirm("确认要挂机吗？")){a();}};SAM.getMiniIconIndex=function(b){for(var a=0;a<PBarStateLst.length;a++){var c=PBarStateLst[a];if((b&c[0])==c[1]){return c[3];
}}return 1;};SAM.getAvailableActions=function(){var b="";if(SAM.getServiceStatus()){b=SAM.getServiceStatus().status;}var c="";if(SAM.getAgentStatus()){c=SAM.getAgentStatus().status;}var d="";if(SAM.getAgentDeviceStatus()){d=SAM.getAgentDeviceStatus().status;}var e={"connect":false,"disconnect":false};
if(SAM.status==SAM.STATUS_OFFLINE){e.connect=true;}else{if(SAM.status==SAM.STATUS_VERIFYING){}else{if(SAM.status==SAM.STATUS_CONNECTING){}else{if(SAM.status==SAM.STATUS_JOINING){e.disconnect=true;}else{if(SAM.status==SAM.STATUS_LOGINED){e.disconnect=true;if(SAM.getAgentStatus()){var a=SAM.getAgentStatus().nativeStatusCode;
e.busy=checkCanDoAgentAction("agtDo_Busy",a);e.ready=checkCanDoAgentAction("agtDo_Ready",a);e.complete=checkCanDoAgentAction("agtDo_AfterCallWorkDone",a);e.hangup=checkCanDoAgentAction("usrDo_ConvLeave",a);e.invite=checkCanDoAgentAction("usrDo_InviteByAgentID",a);e.transfer=checkCanDoAgentAction("usrDo_TransferByAgentID",a);
e.hold=checkCanDoAgentAction("usrDo_ConvHold",a);e.unhold=checkCanDoAgentAction("usrDo_ConvRetrieve",a);e.outbound=checkCanDoAgentAction("usrDo_CallByAgentID",a);e.dontDisturb=checkCanDoAgentAction("agtDo_DontDisturb",a);e.canDisturb=checkCanDoAgentAction("agtDo_CanDisturb",a);e.wantResting=checkCanDoAgentAction("agtDo_DontDisturb",a);
e.answerFor=checkCanDoAgentAction("usrDo_AnswerForAgentID",a);e.monitor=checkCanDoAgentAction("usrDo_MonitorByAgentID",a);e.chimeIn=checkCanDoAgentAction("usrDo_ChimeInByAgentID",a);e.kickOut=checkCanDoAgentAction("usrDo_KickOutByAgentID",a);e.takeOver=checkCanDoAgentAction("usrDo_TakeOverByAgentID",a);
e.lock=checkCanDoAgentAction("agtDo_Lock",a);e.unlock=checkCanDoAgentAction("agtDo_Unlock",a);e.forceIdle=checkCanDoAgentAction("agtDo_ForceIdle",a);e.forceBusy=checkCanDoAgentAction("agtDo_ForceBusy",a);e.forceLogout=checkCanDoAgentAction("agtDo_ForceLogout",a);e.executeIvrScript=checkCanDoAgentAction("agtDo_IVRTutor",a);
e.executeIVRScript=e.executeIvrScript;e.ivrTutor=e.executeIvrScript;e.executeScript=e.executeIvrScript;e.executeFlow=e.executeIvrScript;}}else{if(SAM.status==SAM.STATUS_BREAK){e.disconnect=true;}else{throw new Error("getAvailableActions, Unexpected for status:"+SAM.status);}}}}}}e.connect=e.connect&&SAMTool.getLastAction()!="connect";
e.disconnect=e.disconnect&&SAMTool.getLastAction()=="connect";return e;};SAM.getErrorReason=function(a){var b="method of getErrorReason deprecated. Please use iqResponse.errorReason instead";alert(b);throw new Error(b);};SAM.getErrorReasonWithBracket=function(a){var b=SAM.getErrorReason(a);if(b!=""){return"("+b+")";
}else{return b;}};SAM.monitorMode=false;SAM.connectWithoutLogin=function(b,a,c){SAM._loginToACD=function(){};SAM.monitorMode=true;SAM.connect(b,a,c);};SAM.connect=function(c,b,d){if(SAM.status==SAM.STATUS_LOGINED&&!SAM.isConnected()){SAM.disconnect();}if(SAM.status==SAM.STATUS_CONNECTING){try{SAM.disconnect();
}finally{log.error("connecting but connect again. so come to offline.");SAM.status=SAM.STATUS_OFFLINE;}}if(SAM.status==SAM.STATUS_OFFLINE||(SAM.status==SAM.STATUS_JOINING&&SXC.isConnected()&&SXC._useExistsXmppDirectMessageMgr)){if(b==null){throw new Error("telOption must be provied.");}log.debug("status come to verifying");
SAM.status=SAM.STATUS_VERIFYING;var a={eventType:"onVerifying"};SAM._dispatcher.dispatchEvent(a);SAM._autoReLogin=true;SAM._lastAutoLogin={telOption:b,agentStatus:d};SAM.getClient().connect(c);}else{if(SAM.status==SAM.STATUS_LOGINED){throw new Error("Already logined.");}else{throw new Error("Now status:"+SAM.status+" cannot call login, Please wait status change.");
}}};SAM.logout=function(){SAM._autoReLogin=false;SAM._lastChangedStatus=null;SAM._sendAction({action:"logout"},function(){var a=SAM.status;log.debug("agent logout success come to offline.");SAM.status=SAM.STATUS_OFFLINE;SAM._resetAgentStatus();var b={eventType:"onLogout",reason:"direct_logout"};if(a!=SAM.STATUS_OFFLINE){SAM._dispatcher.dispatchEvent(b);
}},function(b){var a={eventType:"onLogoutFailed",reason:"logout",reasonText:"操作失败，无法在ACD上登出:"+b.errorReason};SAM._dispatcher.dispatchEvent(a);});};SAM.disconnect=function(){SAM._autoReLogin=false;SAM._lastChangedStatus=null;if(SAM.status==SAM.STATUS_JOINING||SAM.status==SAM.STATUS_CONNECTING){log.debug("disconnect will come to offline when joining.");
SAM.status=SAM.STATUS_OFFLINE;SAM._resetAgentStatus();SAM.getClient().disconnect();var b={eventType:"onCancel"};SAM._dispatcher.dispatchEvent(b);}else{if(SAM.status==SAM.STATUS_LOGINED||SAM.status==SAM.STATUS_BREAK){var a=SAM.status;log.debug("disconnect will come to offline when logined or break.");
SAM.status=SAM.STATUS_OFFLINE;SAM._resetAgentStatus();SAM.getClient().disconnect();var b={eventType:"onLogout",reason:"direct_disconnect"};if(a!=SAM.STATUS_OFFLINE){SAM._dispatcher.dispatchEvent(b);}}else{SAM.getClient().disconnect();}}};SAM.isLogined=function(){return SAM.isConnected()&&SAM.status==SAM.STATUS_LOGINED&&SAM.getAgentStatus()!=null&&SAM.getAgentStatus().status!="offline";
};SAM.isAcdOnline=false;SAM._autoReLogin=true;SAM.checkAutoReLogin=function(){if(SXC.isConnected()&&SAM._autoReLogin&&SAM.isAcdOnline&&SAM._lastAutoLogin&&!SAM.isLogined()){var a=SAM._lastAutoLogin.telOption;var b=SAM._lastAutoLogin.agentStatus;if(SAM._lastChangedStatus){b=SAM._lastChangedStatus;}SAM._loginToACD(a,b);
}};SAM._initialize=function(a){if(a!=null){SAM._acdNodeId=a;}log.debug("[SAM.initialize]start");SXC.removeEventListener(SAM._onConnectionEvent);SXC.addEventListener(SAM._onConnectionEvent,"SAM._onConnectionEvent");log.debug("[SAM.initialize]end");};SAM.doAfterUCMOnLineStatusUpdate=function(){var a={eventType:SAM.EVENT_PARTNER_XMPP_STATUS_CHANGE};
SAM._dispatcher.dispatchEvent(a);};SAM.isAgentReady=function(a){if(SAM.getCurrentAgentId()==a||a==null){return SAM.getAgentStatus()&&SAM.getAgentStatus().status=="ready";}else{return SAM.getMonitorAgentById(a)&&SAM.getMonitorAgentById(a).agentStatus&&SAM.getMonitorAgentById(a).agentStatus.status=="ready";
}};SAM.isAgentRing=function(a){if(SAM.getCurrentAgentId()==a||a==null){return(SAM.getServiceStatus()&&SAM.getServiceStatus().status=="before_service");}else{return SAM.getMonitorAgentById(a)&&SAM.getMonitorAgentById(a).serviceStatus&&SAM.getMonitorAgentById(a).serviceStatus.status=="before_service";}};
SAM.isAgentAfterService=function(a){if(SAM.getCurrentAgentId()==a||a==null){return(SAM.getServiceStatus()&&SAM.getServiceStatus().status=="after_service");}else{return SAM.getMonitorAgentById(a)&&SAM.getMonitorAgentById(a).serviceStatus&&SAM.getMonitorAgentById(a).serviceStatus.status=="after_service";
}};SAM.isAgentInService=function(b){if(SAM.getCurrentAgentId()==b||b==null){var c=SAM.getServiceStatus()&&SAM.getServiceStatus().status=="service";var a=SAM._lastServiceEvent=="service_pickup";return c||a;}else{return SAM.getMonitorAgentById(b)&&SAM.getMonitorAgentById(b).serviceStatus&&SAM.getMonitorAgentById(b).serviceStatus.status=="service";
}};SAM.getAgentStatus=function(){return SAM._lastAgentStatus;};SAM.getAgentDeviceStatus=function(){return SAM._lastAgentDeviceStatus;};SAM.isHolding=function(){return SAM.getAgentDeviceStatus()&&SAM.getAgentDeviceStatus().status=="holding";};SAM.getSkillText=function(){var b=SAM.getAgentInfo();if(!b){return"";
}var c="";for(var a in b.skills){c+=b.skills[a].name;if(a<(b.skills.length-1)){c+=", ";}}if(c!=""){c="["+c+"]";}return c;};SAM.getServiceStatus=function(){return SAM._lastServiceStatus;};SAM.getAgentInfo=function(){if(SXC.getAccountInfo()){return SXC.getAccountInfo().agent;}else{return null;}};SAM.getACDEvent=function(){return SAM._lastACDEvent;
};SAM.getCurrentTel=function(){return SAM._tel;};SAM.LOGIN_MODE_ONLINE=1;SAM.LOGIN_MODE_FOR_PC=3;SAM._checkParamsForLogin=function(a,b){if(!(a instanceof Object)){throw new Error("telOption must be object");}if(b!="ready"&&b!="not_ready"){throw new Error("agentStatus invalid value of:"+b);}if(a.type=="softPhone"){}else{if(a.type=="ipPhone"){if(a.phone==""||a.phone==null){throw new Error("telOption.phone invalid value:"+a.type);
}}else{if(a.type=="pstnPhone"){}else{throw new Error("telOption.type invalid value:"+a.type);}}}};SAM.executeSatisfaction=function(c,b){var a={"action":"satisfaction"};SAM._sendAction(a,c,b);};SAM.shiftToVisualAgent=function(a,b,e,d){var c={"action":"virtualBegin","tel":a,"isReady":b};SAM._sendAction(c,e,d);
};SAM._sendLoginActionToACD=function(i,g,p){SAM._checkParamsForLogin(i,g);if(!SXC.isConnected()){log.debug("check:SXC.isConnected() is:"+SXC.isConnected());log.error("cannot SAM._sendLoginActionToACD for: xmpp not connected.");return;}if(SXC.getAccountInfo().number_prefix==null||SXC.getAccountInfo().number_prefix==""){i.realPhone=i.phone;
}else{if(i.type=="softPhone"){i.realPhone=SXC.getAccountInfo().ln;}else{if(i.type=="ipPhone"){i.realPhone="1084"+SXC.getAccountInfo().number_prefix+i.phone;}else{if(i.type=="pstnPhone"){i.realPhone=i.phone;}else{throw new Error("telOption.type invalid value:"+i.type);}}}}var d=SAM.getCurrentAgentId();
if(!d){log.error("SAM._sendLoginActionToACD Cancel for agentId is null.");return;}var j=new JSJaCIQ();j.setType("set");j.setTo(SAM._acdNodeId+"@"+SXC.getChtsvrDomain());var o=j.getDoc();var m=JSJaCBuilder.createElement(o,"login","http://acd.qingzhi.com/agents");var c=o.createElement("agent");c.setAttribute("id",d);
var h=function(t,q,u){var r=o.createElement(q);var s=o.createTextNode(u);r.appendChild(s);t.appendChild(r);};h(c,"password",SXC.getAccountInfo().agent.agent_password);h(c,"ctiCapicity","1");h(c,"jid",SXC.getFullJid());h(c,"nickname",SXC.getAccountInfo().p.n);h(c,"loginMode",i.loginMode);h(c,"autoComplete",-1);
if(i.agentGroupIds&&i.agentGroupIds!=""){h(c,"group",i.agentGroupIds);}var b=o.createElement("agentStatus");b.setAttribute("status",g);c.appendChild(b);b=o.createElement("agentstatus");b.setAttribute("status",g);c.appendChild(b);var a=o.createElement("tel");if(i.type=="softPhone"){a.setAttribute("type","line");
}else{a.setAttribute("type","uc");}a.setAttribute("resourceId",SXC.getResource());var n=o.createTextNode(i.realPhone);a.appendChild(n);c.appendChild(a);m.appendChild(c);j.getNode().appendChild(m);var l=function(r){log.error("deal error: SAM._sendLoginActionToACD failed actionName is:login. come to offline.");
SAM.status=SAM.STATUS_OFFLINE;SAM._resetAgentStatus();var q={eventType:"onLoginFailed",reason:"loginToAcdFailed"};if(r){var t=r.getNode().getElementsByTagName("error");if(t.length>0){q.error=t[0].xml;}var e=SXC._getIqErrorReason(r);if(r.getFrom()==null){if(e==""){e="ACD节点不在线";}else{e="ACD节点不在线("+e+")";
}}else{if(e==null||e==""){e="登录ACD失败(错误原因不明)";}}q.reasonText=e;}else{q.reasonText="ACD无响应";}try{SAM._dispatcher.dispatchEvent(q);}finally{var s=Math.random()*10+5;setTimeout(function(){SAM.checkAutoReLogin();},s*1000);}};log.debug("[SAM] do before send iq: _sendLoginActionToACD.");try{var f={eventType:"onBeforeSendLoginIQ",reason:""};
SAM._dispatcher.dispatchEvent(f);}catch(k){}SXC.sendIq(j,function(q){if(q.getType()=="result"){log.debug("status come to logined.");SAM.status=SAM.STATUS_LOGINED;var r=q.getAttribute("t");var e={eventType:"onLoginSuccess"};SAM._dispatcher.dispatchEvent(e);if(SAM._subscribeFlag){SAM.startAgentMonitor();
}if(SAM._queueMonitor){SAM.startQueueMonitor();}if(p){p();}}else{l(q);}},function(){l();});};SAM._loginToACD=function(a,b){setTimeout(function(){log.debug("try do SAM._loginToACD");SAM._sendLoginActionToACD(a,b,function(){SAM._tel=a.realPhone;setTimeout(function(){SAM._getAgentStatus();},1500);});},1000);
};SAM.busy=function(b){var a=SAM.getAvailableActions();if(!a.busy){log.error("SAM.complete cannot do busy.");return;}if(!b){b="";}SAM._sendAction({action:"busy",reason:b});if(a.complete){SAM.complete();}};SAM.ready=function(){var a=SAM.getAvailableActions();if(!a.ready){log.error("SAM.complete cannot do ready.");
return;}SAM._sendAction({action:"ready"});if(a.complete){SAM.complete();}};SAM.startRecord=function(b,a){SAM._sendAction({action:"startRecord"},b,a);};SAM.stopRecord=function(b,a){SAM._sendAction({action:"stopRecord"},b,a);};SAM._triggerAgentStatusChange=function(){var a={eventType:SAM.EVENT_AGENT_STATUS_CHANGE};
SAM._dispatcher.dispatchEvent(a);};SAM.reject=function(){SAM._sendAction({action:"reject"});};SAM.hangup=function(){var a=SAM.getAvailableActions();if(!a.hangup){log.error("SAM.complete cannot do hangup.");return;}SAM._sendAction({action:"hangup"});};SAM.answerForAgent=function(b,e,c){var d={action:"answerFor",target:{type:"agent",text:b}};
var a=70;return SAM._sendAction(d,e,c,a);};SAM.sendIMReady=function(b,f,d){if(b&&!b.nick){var c="options.nick cannot be null or empty.";if(d){d({"errorReason":c});return;}else{throw new Error(c);}}var e={"action":"im_ready","qz_id":SXC._lastAccountInfo&&SXC._lastAccountInfo.q?SXC._lastAccountInfo.q:0,"nick":b&&b.nick?b.nick:"未知座席","ability":b&&b.ability?b.ability:5,"dmains":b&&b.domains?b.domains:["webchat","weixin","qq","app"]};
if(b&&b.qz_id){e.qz_id=b.qz_id;}var a=10;return SAM._sendAction(e,f,d,a);};SAM.imReady=function(c,a,e,f,d){var b={"qz_id":c,"ability":e,"nick":a};return SAM.sendIMReady(b,f,d);};SAM.sendIMBusy=function(d,b){var c={"action":"im_busy","qz_id":SXC._lastAccountInfo&&SXC._lastAccountInfo.q?SXC._lastAccountInfo.q:0};
var a=10;return SAM._sendAction(c,d,b,a);};SAM.imBusy=function(b,e,c){var d={"action":"im_busy","qz_id":b};var a=10;return SAM._sendAction(d,e,c,a);};SAM.monitorAgent=function(b,e,c){var d={action:"monitor",target:{type:"agent",text:b}};var a=70;return SAM._sendAction(d,e,c,a);};SAM._sendWaitSubscribeIq=function(a,j,h,e){if(a!="subscribe"&&a!="unsubscribe"){throw new Error("unexpected action of:"+a);
}var c=new JSJaCIQ();c.setType("set");c.setTo(SAM._acdNodeId+"@"+SXC.getChtsvrDomain());var f=c.getDoc();var d=JSJaCBuilder.createElement(f,a,"http://acd.qingzhi.com/agents/waiting");c.getNode().appendChild(d);if(j!=null){var g=f.createElement("domains");var i=SAM.getArrayLinkStr(j,", ");var b=f.createTextNode(i);
g.appendChild(b);d.appendChild(g);}SXC.sendIq(c,function(k){if(k.getType()=="result"){if(h){h();}}else{if(e){e(k);}}},function(){if(e){e({"errorReason":"timeout"});}});};SAM.startWaitServiceMonitor=function(a,c,b){SAM._sendWaitSubscribeIq("subscribe",a,c,b);};SAM.stopWaitServiceMonitor=function(b,a){SAM._sendWaitSubscribeIq("unsubscribe","PSTN,weixin,qq,app,webchat",b,a);
};SAM.chimeInAgent=function(b,e,c){var d={action:"chimeIn",target:{type:"agent",text:b}};var a=70;return SAM._sendAction(d,e,c,a);};SAM.kickOutAgent=function(b,e,c){var d={action:"kickOut",target:{type:"agent",text:b}};var a=10;return SAM._sendAction(d,e,c,a);};SAM.lockAgent=function(b,e,c){var d={action:"lock",target:{type:"agent",text:b}};
var a=10;return SAM._sendAction(d,e,c,a);};SAM.unlockAgent=function(b,e,c){var d={action:"unlock",target:{type:"agent",text:b}};var a=10;return SAM._sendAction(d,e,c,a);};SAM.takeOverAgent=function(b,e,c){var d={action:"takeOver",target:{type:"agent",text:b}};var a=70;return SAM._sendAction(d,e,c,a);
};SAM.forceIdleAgent=function(b,e,c){var d={action:"forceIdle",target:{type:"agent",text:b}};var a=10;return SAM._sendAction(d,e,c,a);};SAM.forceBusyAgent=function(b,e,c){var d={action:"forceBusy",target:{type:"agent",text:b}};var a=10;return SAM._sendAction(d,e,c,a);};SAM.forceLogoutAgent=function(b,e,c){var d={action:"forceLogout",target:{type:"agent",text:b}};
var a=10;return SAM._sendAction(d,e,c,a);};SAM.wantResting=function(a,d,b){var c={"action":"wantResting","reason":a};return SAM._sendAction(c,d,b);};SAM.grantResting=function(a,d,b){var c={"action":"grantResting","target":{"type":"agent","text":a}};return SAM._sendAction(c,d,b);};SAM.dontDisturb=function(c,a){var b={action:"dontDisturb"};
return SAM._sendAction(b,function(f){if(f.getType()=="result"){var e=f.getNode();var g=e.getElementsByTagName("dontDisturb");if(g.length>0){var d=QzXmlTool.getChildTextContentByName(g[0],"version");if(c){c(d);}}else{if(a){a({"errorReason":"no found of 'version' element."});}}}else{if(a){a(f);}}},a);};
SAM.canDisturb=function(a,d,b){var c={"action":"canDisturb","version":a};return SAM._sendAction(c,d,b);};SAM.inviteToAgent=function(a,c,b){return SAM._sendMakeCallInviteAction("invite",{targetType:"agent",targetText:a},c,b);};SAM.inviteToPhone2=function(b,a,f,d){var e={"action":"invite","target":{type:"tel",text:b},"callerNumber":a};
var c=70;return SAM._sendAction(e,f,d,c);};SAM.inviteToPhone=function(a,c,b){return SAM._sendMakeCallInviteAction("invite",{targetType:"tel",targetText:a},c,b);};SAM.inviteToGroup=function(a,c,b){return SAM._sendMakeCallInviteAction("invite",{targetType:"group",targetText:a},c,b);};SAM.transferToAgent=function(b,a,d,c){return SAM.transferTo("agent",b,a,d,c);
};SAM.transferToPhone=function(a,b,d,c){return SAM.transferTo("tel",a,b,d,c);};SAM.transferToGroup=function(a,b,d,c){return SAM.transferTo("group",a,b,d,c);};SAM.transferTo=function(d,e,c,h,f){var a=SAM.getAvailableActions();if(!a.transfer){log.error("SAM.complete cannot do transfer.");return;}var g={action:"transfer",target:{type:d,text:e},kind:c};
var b=70;return SAM._sendAction(g,h,f,b);};SAM.makeCallToAgent=function(b,c,a){return SAM._sendMakeCallInviteAction("makeCall",{targetType:"agent",targetText:b.agentId?b.agentId:b,"video":b.video},c,a);};SAM.makeCallToPhone=function(a,d,c){var b=a.tel?a:{"tel":a};b.targetType="tel";b.targetText=b.tel;
return SAM._sendMakeCallInviteAction("makeCall",b,d,c);};SAM.makeCallToGroup=function(a,c,b){return SAM._sendMakeCallInviteAction("makeCall",{targetType:"group",targetText:a},c,b);};SAM._sendMakeCallInviteAction=function(b,e,g,d){var a=SAM.getAvailableActions();if(b=="makeCall"){if(!a["outbound"]){log.error("SAM.complete cannot do "+b);
return;}}else{if(!a[b]){log.error("SAM.complete cannot do "+b);return;}}var f=e;f.action=b;f.target={type:e.targetType,text:e.targetText};f.callReason=e.callReason?JSON.stringify(e.callReason):"";var c=70;return SAM._sendAction(f,g,d,c);};SAM.cancelAction=function(b){var a={action:"cancel",actionId:b};
SAM._sendAction(a);};SAM.complete=function(){var a=SAM.getAvailableActions();if(!a.complete){log.error("SAM.complete cannot do complete.");return;}if(SAM.getAgentInfo()){SAM._sendAction({action:"complete"});}};SAM.getArrayLinkStr=function(c,b){var a="";if(c.length){return c.join(b);}else{return c+"";
}};SAM._LastActionId=0;SAM.appendTextNodeToElement=function(h,b,a,f){var g=f.length?f:[f];for(var c in g){var j=g[c];if(a[j]){var e=h.createElement(j);var d=h.createTextNode(a[j]);e.setAttribute("id",a[j]);e.appendChild(d);b.appendChild(e);}}};SAM.options={"service":{}};SAM._lastId_=null;SAM._tryDealWithNotifyMsg=function(f){if(f.getID()==SAM._lastId_){return;
}SAM._lastId_=f.getID();var a=f.getBody();try{var c=JSON.parse(a);if(c.kickedJid&&c.kickedJid!=SXC.getFullJid()){var b={"eventType":"onKickOtherSession"};SAM._dispatcher.dispatchEvent(b);}}catch(d){}};SAM._trySendNotifyToOtherWhenKicked=function(){if(true){var a={"kickedJid":SXC.getFullJid()};var b={"to":SXD.userArgs.username+"","type":"normal","body":JSON.stringify(a)};
SIM.sendSimpleMsg(b);}};SAM._sendAction=function(i,c,q,b){var n=0;if(!i||i.action==""){log.error("SAM._sendAction Cancel for actionObject.action is null.");return;}var p=SAM.getCurrentAgentId();if(!p||p==""){log.error("SAM._sendAction Cancel for agentId is null.");return;}var e=new JSJaCIQ();e.setType("set");
if(i.iqType){e.setType(i.iqType);}if(i.action.indexOf("get")==0){e.setType("get");}e.setTo(SAM._acdNodeId+"@"+SXC.getChtsvrDomain());var r=e.getDoc();var d=JSJaCBuilder.createElement(r,i.action,i.xmlns?i.xmlns:"http://acd.qingzhi.com/agents");if(i.actionId){d.setAttribute("actionId",i.actionId);}else{SAM._LastActionId++;
n=SAM._LastActionId;d.setAttribute("actionId",n);}if(i.action!="subscribe"&&i.action!="unsubscribe"){var m=r.createElement("agent");m.setAttribute("id",p);if(i.domains){var g=r.createElement("domains");var h=SAM.getArrayLinkStr(i.domains,", ");var a=r.createTextNode(h);g.appendChild(a);m.appendChild(g);
}SAM.appendTextNodeToElement(r,m,i,["nick","reason","ability","qz_id"]);if(i.tel&&i.action=="virtualBegin"){var j=r.createElement("tel");if(i.tel.indexOf("1081")==0){j.setAttribute("type","line");}else{j.setAttribute("type","normal");}var a=r.createTextNode(i.tel);j.appendChild(a);m.appendChild(j);var l=r.createElement("agentStatus");
if(i.isReady==true){a=r.createTextNode("ready");}else{a=r.createTextNode("busy");}l.appendChild(a);m.appendChild(l);}d.appendChild(m);}if(i.action=="subscribe"){if(SAM._deptMonitor&&SXC.getAccountInfo()&&SXC.getAccountInfo().dept_id&&SXC.getAccountInfo().dept_id!="-1"&&SXC.getAccountInfo().dept_id!="0"){var g=r.createElement("department");
g.setAttribute("id",SXC.getAccountInfo().dept_id);d.appendChild(g);}}if(i.action=="setCustomerCtx"){var f=r.createElement("call");var k=r.createElement("context");var a=r.createTextNode(i.context);k.appendChild(a);f.appendChild(k);d.appendChild(f);}if(i.target!=null){var o=r.createElement("target");o.setAttribute("type",i.target.type);
var a=r.createTextNode(i.target.text);o.appendChild(a);d.appendChild(o);}SAM.appendTextNodeToElement(r,d,i,["callerNumber","callReason","video","flow","voiceService","params","version","reason","kind","campaignId","taskId","groupId","onlineStatus"]);e.getNode().appendChild(d);SXC.sendIq(e,function(s){if(s.getType()=="result"){if(c){c(s);
}}else{log.error("SAM.sendSimpleActionToACD failed actionName is:"+i.action);if(q){q(s);}}},function(){log.error("SAM.sendSimpleActionToACD failed actionName is:"+i.action);if(q){q({"errorReason":"timeout","errorReason2":"timeout for "+b+" seconds."});}},b);return n;};SAM._lastAgentStatus=null;SAM._lastServiceStatus=null;
SAM._lastACDEvent=null;SAM.getDisplayStatusAgent=function(b,a,c){if(a=="before_service"){if(c=="ring"){return"正在振铃";}else{if(c=="calling"){return"正在呼叫";}else{return"正在振铃";}}}else{if(a=="service"){if(c=="monitoring"){return"监听";}else{if(c=="holding"){return"保持";}else{if(c=="transfering"){return"转接中";}else{if(c=="talking"){return"接待客户";
}else{return"接待客户";}}}}}else{if(a=="after_service"){return"事后处理";}else{if(c=="monitoring"){return"监听";}else{if(c=="holding"){return"保持";}else{if(c=="transfering"){return"转接中";}else{if(c=="talking"){return"正在通话";}else{if(c=="ring"){return"正在振铃";}else{if(c=="calling"){return"正在呼叫";}else{if(c=="dont_disturb"){return"请勿打扰";
}else{if(c=="offline"){return"离线";}else{if(b=="not_ready"){if(b.reason=="frozen"){return"锁定";}else{if(b.reason=="resting"){return"小憩";}else{if(b.reason!=null&&b.reason!=""){return b.reason;}else{return"忙";}}}}else{return"就绪";}}}}}}}}}}}}};SAM.isInHoldOperation=false;SAM.hold=function(d,c){var a=SAM.getAvailableActions();
if(!a.hold){log.error("SAM.hold cannot do hold.");if(c){c({"errorReason":"无法进行保持操作"});}return;}if(SAM.isInHoldOperation){alert("请不要频繁操作。");if(c){c({"errorReason":"禁止频繁操作"});}return;}var b={action:"hold"};SAM.isInHoldOperation=true;SAM._sendAction(b,function(){SAM.isInHoldOperation=false;if(d){d();}},function(e){SAM.isInHoldOperation=false;
if(c){c(e);}});};SAM.unhold=function(d,c){var a=SAM.getAvailableActions();if(!a.unhold){log.error("SAM.unhold cannot do unhold.");if(c){c({"errorReason":"无法进行拾回操作"});}return;}var b={action:"retrieve"};SAM._sendAction(b,d,c);};SAM.getDisplayStatus=function(){if(!SAM.isConnected()){return"未登录";}else{if(SAM.status!=SAM.STATUS_LOGINED){return"未登录";
}else{if(SAM.getAgentStatus()!=null){return SAM.getAgentStatus().text;}else{return"未知";}}}};SAM.timeDisplaySplitter=":";SAM.getDisplayStatusDuration=function(){var f=SAM.timeDisplaySplitter;if(!SAM.isLogined()){return"--"+f+"--"+f+"--";}var c=SAM.getStatusDurationSeconds();if(c<0){return"--"+f+"--"+f+"--";
}else{var e="";var a=Math.floor(c/3600);if(a<10){e+="0";}e+=a+f;var d=Math.floor(c%3600/60);if(d<10){e+="0";}e+=d+f;var b=Math.floor(c%60);if(b<10){e+="0";}e+=b;return e;}};SAM.getStatusDurationSeconds=function(){if(SAM.getAgentStatus()!=null){var a=SAM.getAgentStatus().timeStamp;var b=SAM.getAgentStatus().duration;
return SAM.getRealDuration(a,b);}else{return -1;}};SAM.imStart=function(){SimpleIM.start();};SAM.imStop=function(){SimpleIM.stop();};SAM.isIMStarted=function(){return SimpleIM.isStarted();};SAM.parseXmlMsg=function(a){return SimpleIM.parseXmlMsg(a);};SAM.sendMsg=function(c,d,b,a){return SimpleIM.sendMsg(c,d,b,a);
};SAM.isCurrentResting=function(){return SAM.getAgentStatus()&&((SAM.getAgentStatus().nativeStatusCode&AGENT_STATUS_RESTING)==AGENT_STATUS_RESTING);};SAM.isCurrentAfterCallWork=function(){return SAM.getAgentStatus()&&SAM.getAgentStatus().text=="事后处理";};SAM.getRealDurationFromMili=function(b,d){if(d<0&&SAM.onDebug){SAM.onDebug("SAM.getRealDurationFromMili","mili duration is < 0, of:"+d);
}d+=(new Date().getTime()-b);var c=d/1000;if(c<0&&SAM.onDebug){SAM.onDebug("SAM.getRealDurationFromMili","duration is < 0, of:"+c);}var a=Math.floor(c);return a;};SAM.getRealDuration=function(a,b){b+=(new Date().getTime()-a)/1000;return Math.floor(b);};SAM.createAgentBarComponent=function(a){SAU.createUI(a);
};SAM.setUseInternalIpPhone=function(a){if(a){SAM._useInternalIpPhone=true;}else{SAM._useInternalIpPhone=false;}};SAM.getIMOnlineList=function(b,e,c){if(!e){throw new Error("SAM.getIMAgents error of callback is NULL.");}var d={"iqType":"get","action":"im_list","xmlns":"http://www.onesoul.cn/im_agents","onlineStatus":"online","groupId":b&&b.groupId?b.groupId:null};
var a=10;return SAM._sendAction(d,function(h){var g=QzXmlTool.getChildByNameAndNameSpace(h.getNode(),"im_list");if(g){var j=QzXmlTool.getChildByNameAndNameSpace(g,"agentList");var k=QzXmlTool.getChildByNameAndNameSpaceWithFilter(g,"sessionList",function(p){return(p.parentNode.tagName!="agent");});var l={};
var m=[];var o=[];function f(){var r=k.getElementsByTagName("session");if(r.length>0){for(var q=0;q<r.length;q++){var p=r[q];if(QzXmlTool.getChildTextContentByName(p,"status")==""){continue;}var s={"id":p.getAttribute("id"),"customerChatTargetId":QzXmlTool.getChildTextContentByName(p,"customerNodeId"),"agent":QzXmlTool.getChildTextContentByName(p,"currentAgent"),"status":QzXmlTool.getChildTextContentByName(p,"status"),"startTime":QzXmlTool.getChildTextContentByName(p,"startTime").replace("T"," ").substring(0,19),"sessionSeconds":parseInt(QzXmlTool.getChildTextContentByName(p,"duration")),"queueSeconds":QzXmlTool.getChildTextContentByName(p,"queueDuration"),"serviceSeconds":QzXmlTool.getChildTextContentByName(p,"serviceDuration")};
s.domain=SIM.getDomainFromNodeId(s.customerChatTargetId);if(s.status=="agent"){s.serviceSeconds=parseInt(s.serviceSeconds);}else{delete s.serviceSeconds;delete s.agent;}if(s.status=="queue"){s.queueSeconds=parseInt(s.queueSeconds);}else{delete s.queueSeconds;}l[s.id]=s;m.push(s);}}}function n(){var u=j.getElementsByTagName("agent");
if(u.length>0){for(var t=0;t<u.length;t++){var s=u[t];var v={"id":s.getAttribute("id"),"chatTargetId":QzXmlTool.getChildTextContentByName(s,"qz_id"),"status":QzXmlTool.getChildTextContentByName(s,"status"),"nick":QzXmlTool.getChildTextContentByName(s,"nick"),"ability":parseInt(QzXmlTool.getChildTextContentByName(s,"ability")),"sessionList":[]};
var q=QzXmlTool.getChildByNameAndNameSpace(s,"sessionList");var p=q.getElementsByTagName("session");if(p.length>0){for(var r=0;r<p.length;r++){var s=p[r];var w=s.getAttribute("id");if(l[w]){v.sessionList.push(l[w]);}}}if(v.sessionList.length<=0){v.idleSeconds=parseInt(QzXmlTool.getChildTextContentByName(s,"idleSeconds"));
}o.push(v);}}}f();n();var i={"agentList":o,"sessionList":m};e(i);}},c,a);};SAM.checkLicense=function(c){if(c==null){throw new Error("Unexpected SAM.checkLicense callback is NULL.");}if(window.SXC&&window.SXC.getAccountInfo()){}else{throw new Error("Unexpected window.SXC.getWebChatUrl() is NULL, so cannot check License.");
}var a=window.SXC.getWebChatUrl(window.SXC.getAccountInfo().service);var b=a.substring(0,a.lastIndexOf("/"));b+="/dataservice?methodname=get_license_json";$.post(b,{}).done(function(d){try{d=JSON.parse(d);}catch(f){}if(d.time&&d.time.indexOf("1970")>=0){c({"status":"active","time":"always"});return;}if(d.time){d.time=d.time.substring(0,19).replace("T"," ");
}if(d.status=="error"){delete d.left_seconds;c(d);return;}if(d.status=="active"){c(d);return;}});};SAM._onConnectionEvent=function(d){log.debug("[SAM._onConnectionEvent]start. EventObject.eventType = "+d.eventType);if(d.eventType=="onVerifyFailed"){log.error("verify failed come to offline.");SAM.status=SAM.STATUS_OFFLINE;
var b={eventType:"onLoginFailed",reason:d.eventType,reasonText:"后台身份验证失败。"};SAM._dispatcher.dispatchEvent(b);}else{if(d.eventType=="onVerifySuccess"){var i=d.data;log.debug("verify failed come to connecting.");SAM.status=SAM.STATUS_CONNECTING;if(SAM._useInternalIpPhone&&i.service.cm_host){i.cm_url=i.service.cm_host+":"+i.service.cm_sip_port;
try{SimplePhone.init(i.cm_url,i.ln,i.lp,i.q,SXC._buildResource());}catch(h){var b={eventType:"onPhoneInitError",data:h};SAM._dispatcher.dispatchEvent(b);}}else{i.cm_url="";}SAM._dispatcher.dispatchEvent(d);}else{if(d.eventType=="onPresence"){var f=d.data;if(f.from==SAM._acdNodeId||f.from&&f.from._node==SAM._acdNodeId||f._node==SAM._acdNodeId){if(f.type==null||f.type&&f.type==""||f.type&&f.type=="available"){log.debug(SAM._acdNodeId+" is online.");
SAM.isAcdOnline=true;var j=Math.random()*10+1;setTimeout(function(){SAM.checkAutoReLogin();var e={eventType:"onAcdOnline"};SAM._dispatcher.dispatchEvent(e);},j*1000);}else{if(f.type&&f.type=="unavailable"){log.error(SAM._acdNodeId+" is offline.");SAM.isAcdOnline=false;var g=SAM.status;log.error("status come to offline.");
SAM.status=SAM.STATUS_OFFLINE;SAM._resetAgentStatus();var a={eventType:"onLogout",reason:"acd_offline"};if(g!=SAM.STATUS_OFFLINE){SAM._dispatcher.dispatchEvent(a);}var a={eventType:"onAcdOffline"};SAM._dispatcher.dispatchEvent(a);}}}}else{if(d.eventType=="onConnect"){var g=SAM.status;log.debug("onConnect: status come to joining.");
SAM.status=SAM.STATUS_JOINING;setTimeout(function(){var e=new JSJaCPresence();e._setChildNode("service-push","enable");SXC.send(e);},100);var a={eventType:"onXmppConnect",data:d.data};SAM._dispatcher.dispatchEvent(a);if(SAM._lastAutoLogin&&SAM._autoReLogin){var c=SAM._lastAutoLogin.agentStatus;if(SAM._lastChangedStatus){c=SAM._lastChangedStatus;
}SAM._loginToACD(SAM._lastAutoLogin.telOption,c);}else{log.error("cannot login for condition is not ok. SAM._lastAutoLogin is:"+SAM._lastAutoLogin+" ,SAM._autoReLogin:"+SAM._autoReLogin);}}else{if(d.eventType=="onDisconnect"){var g=SAM.status;log.error("ondisconnect come to offline.");SAM.status=SAM.STATUS_OFFLINE;
SAM._resetAgentStatus();var a={eventType:"onLogout",reason:d.eventType};if(g!=SAM.STATUS_OFFLINE){SAM._dispatcher.dispatchEvent(a);}var a={eventType:"onXmppDisconnect"};SAM._dispatcher.dispatchEvent(a);}else{if(d.eventType=="onRecvNormalMsg"){var f=d.data;SAM.dealMessageFromACD(f.jMessage);SAM._tryDealWithNotifyMsg(f.jMessage);
}else{if(d.eventType=="onAuthError"){log.error("on auth error come to offline.");SAM.status=SAM.STATUS_OFFLINE;var a={eventType:"onLoginFailed"};if(d.data=="auth"){a.reason=d.eventType;a.reasonText="chtsvr身份验证失败。";}else{a.reason=d.data;a.reasonText=d.data;}SAM._dispatcher.dispatchEvent(a);}}}}}}}log.debug("[SAM._onConnectionEvent]end.");
};SAM.isChatService=function(a){return SimpleDetector.isChatService(a);};SAM.setHAChatService=function(a,b){SimpleHA.setService(a,b);};SAM._updateAgentTimeKey="SAM._updateAgentTimeKey";SAM._tel=null;SAM._agentsMap={};SAM._queue=[];SAM.getMonitorAgentById=function(c){var b=this._agentsMap[c];if(b==null){return null;
}var a=b.agent;return SAM._getMonitorAgentByEAgent(c,a,b.timeStamp);};SAM._getMonitorAgentByEAgent=function(q,l,h){if(h==null||h==""){h=new Date().getTime();}var g=QzXmlTool.getChildTextContentByName(l,"status");var a=parseInt(QzXmlTool.getChildAttributeByName(l,"status","duration"));var m=parseInt(QzXmlTool.getChildAttributeByName(l,"status","nativeStatusCode"));
var k=QzXmlTool.getChildTextContentByName(l,"controller");if(a<0&&SAM.onDebug){SAM.onDebug("SAM._getMonitorAgentByEAgent","duration is < 0, of:"+a);}var j=(new Date().getTime()-h)/1000;if(j<0&&SAM.onDebug){SAM.onDebug("SAM._getMonitorAgentByEAgent","seconds is < 0, of:"+j);}a+=Math.round(j);var r=QzXmlTool.getChildTextContentByName(l,"nickname");
var f=QzXmlTool.getChildTextContentByName(l,"jid");var d=f.substring(0,f.indexOf("@"));var o=QzXmlTool.getChildTextContentByName(l,"tel");var e=q.substring(q.indexOf(".")+1);var c={"status":QzXmlTool.getChildAttributeByName(l,"agentStatus","status"),"reason":QzXmlTool.getChildAttributeByName(l,"agentStatus","reason")};
var i={"status":QzXmlTool.getChildAttributeByName(l,"serviceStatus","status"),"reason":QzXmlTool.getChildAttributeByName(l,"serviceStatus","reason")};var s={"status":QzXmlTool.getChildAttributeByName(l,"deviceStatus","status"),"reason":QzXmlTool.getChildAttributeByName(l,"deviceStatus","reason")};var n=QzXmlTool.getChildTextContentByName(l,"group");
var p=n!=""?n.split(","):[];var b={id:q,qz_id:d,name:r,groups:p,loginName:e,displayStatus:g,durationSeconds:a,nativeStatusCode:m,displayDuration:DateTimeUtils.beautifulTimeAtSecond(a," "),"controller":k,contact:o,"agentStatus":c,"serviceStatus":i,"deviceStatus":s};return b;};SAM.getLoginTel=function(){return SAM._tel;
};SAM._AGENT_CACHE_HOLD_MILI_SECONDS=5*60*1000;SAM._lastServiceEvent=null;SAM.parseContextToMap=function(d){if(d==null||!d){return{};}var g={};var a=d.split("\n");for(var c=0;c<a.length;c++){var e=a[c];if(!e){continue;}var h=e.indexOf("=");if(h>0){var b=e.substring(0,h);var f=e.substring(h+1);g[b]=f;
}}return g;};SAM.executeFlow=function(b,d,e,c){if(d==null){d={};}var a=60*2;var d={"action":"flowTutor","voiceService":b,"params":SAM.stringifyContext(d)};SAM._sendAction(d,function(f){var h=QzXmlTool.getChildByNameAndNameSpace(f.getNode(),"flowTutor");var g=QzXmlTool.getChildTextContentByName(h,"result");
SAM.lastIQResult=f;if(e){e(SAM.parseContextToMap(g));}},c,a);};SAM.executeScript=function(b,d,e,c){if(d==null){d={};}var a=60*2;var d={"action":"tutor","flow":b,"params":SAM.stringifyContext(d)};SAM._sendAction(d,function(f){var h=QzXmlTool.getChildByNameAndNameSpace(f.getNode(),"tutor");var g=QzXmlTool.getChildTextContentByName(h,"result");
if(e){e(SAM.parseContextToMap(g));}},c,a);};SAM.dealMessageFromACD=function(D){log.debug("SAM.dealMessageFromACD start");try{var B=D.getNode();var l=QzXmlTool.getChildAttributeByName(B,"event","type");var a=QzXmlTool.getChildAttributeByName(B,"event","xmlns");var C=QzXmlTool.getChildByNameAndNameSpace(B,"event");
if((l=="service_start")||(l=="service_pickup")||(l=="service_end")||(l=="service_complete")||(l.indexOf("service_")==0)){var t=C.getElementsByTagName("service");if(t.length<=0){log.error("SAM.dealMessageFromACD - error of Unexpected service xml no found.");return true;}if(!SAM.getCurrentAgentId()){log.error("SAM.dealMessageFromACD - error of current AgentId is NULL. So ignore this event.");
return true;}var q=QzXmlTool.getChildAttributeByName(t[0],"agent","id");SAM._dealWithServiceEvent(q,t[0],"event");if(!q||q==SAM.getCurrentAgentId()){SAM._lastServiceEvent=l;if(l=="service_start"){SAM._lastServiceStatus={"status":"before_service"};}}var f=C.getElementsByTagName("call");if(f.length>0){SAM._dealWithCallEvent(q,f[0],"event");
}var y=C.getElementsByTagName("request");if(y.length>0){SAM._dealWithRequestEvent(q,y[0],"event");}SAM._dispatchServiceEvent(q,l);}else{if(l=="agent_status"){var s=QzXmlTool.getChildByNameAndNameSpace(C,"agent");var q=s.getAttribute("id");var b={"status":QzXmlTool.getChildAttributeByName(s,"agentStatus","status"),"reason":QzXmlTool.getChildAttributeByName(s,"agentStatus","reason"),"text":QzXmlTool.getChildTextContentByName(s,"status"),"timeStamp":new Date().getTime(),"duration":parseInt(QzXmlTool.getChildAttributeByName(s,"status","duration")),"nativeStatusCode":parseInt(QzXmlTool.getChildAttributeByName(s,"status","nativeStatusCode"))};
var k={"status":QzXmlTool.getChildAttributeByName(s,"serviceStatus","status"),"reason":QzXmlTool.getChildAttributeByName(s,"serviceStatus","reason")};var E={"status":QzXmlTool.getChildAttributeByName(s,"deviceStatus","status"),"reason":QzXmlTool.getChildAttributeByName(s,"deviceStatus","reason")};var p=QzXmlTool.getChildTextContentByName(s,"controller");
if(q==SAM.getCurrentAgentId()){var g=SAM.isCurrentResting();var v=SAM.isCurrentAfterCallWork();if(b.status=="offline"||p=="xmpp:"+SXC.getFullJid()){SAM._lastAgentStatus=b;SAM._lastAgentDeviceStatus=E;if(b.status=="ready"||b.status=="not_ready"){SAM._lastChangedStatus=b.status;}if(SAM._lastServiceStatus&&SAM._lastServiceStatus.reason=="simulate"&&SAM._lastServiceStatus.status=="after_service"){}else{if(k.status!=""){SAM._lastServiceStatus=k;
}}}if(b.status!="offline"){var w={eventType:SAM.EVENT_AGENT_STATUS_CHANGE};SAM._dispatcher.dispatchEvent(w);var h=SAM.isCurrentResting();if(h&&!g){var w={eventType:SAM.EVENT_AGENT_STATUS_IS_RESTING};SAM._dispatcher.dispatchEvent(w);}var o=SAM.isCurrentAfterCallWork();if(o&&!v){var w={eventType:"agent_after_call_work"};
SAM._dispatcher.dispatchEvent(w);}}else{var m=SAM.status;log.error("agent come to offline for some reason.");SAM.status=SAM.STATUS_OFFLINE;SAM._resetAgentStatus();SAM._lastChangedStatus=null;var w={eventType:"onLogout",reason:"status_changed"};if(p!="xmpp:"+SXC.getFullJid()){if(p==""||p==null){w.reason="virtual_agent";
}else{w.reason="kicked";}w.by=p;SAM._autoReLogin=false;}if(w.reason=="kicked"){SAM._trySendNotifyToOtherWhenKicked();}if(m!=SAM.STATUS_OFFLINE){SAM._dispatcher.dispatchEvent(w);}try{SimpleXmppDirectMessageMgr.disconnect();}catch(z){}}}SAM._agentsMap[q]={"timeStamp":new Date().getTime(),"agentId":q,"agent":s,"isOffline":b.status=="offline","_agentData":SAM._getMonitorAgentByEAgent(q,s),"getAgentData":function(){return SAM._getMonitorAgentByEAgent(this.agentId,this.agent,this.timeStamp);
}};try{if(SAM._needCacheAgent){if(b.status=="offline"){SAM._cachedAgentMap[q]=false;}else{SAM._cachedAgentMap[q]=SAM._agentsMap[q];}}else{var w={eventType:SAM.EVENT_PARTNER_AGENT_STATUS_CHANGE,agentId:q};SAM._dispatcher.dispatchEvent(w);}}finally{if(b.status=="offline"){delete SAM._agentsMap[q];}}}else{if(l=="call_missed"){var f=C.getElementsByTagName("call");
if(f.length>0){var r=SAM._parseCallEvent(f[0]);if(r.expectedAgent==SAM.getCurrentAgentId()){var w={"eventType":l,"acdCall":r};SAM._dispatcher.dispatchEvent(w);}}}else{if(l=="call_start"||l=="call_end"||l=="call_succeed"||l.indexOf("call_")==0){var s=QzXmlTool.getChildByNameAndNameSpace(C,"agent");var q=s.getAttribute("id");
if(q!=SAM.getCurrentAgentId()){return;}var w={"eventType":l};var j=QzXmlTool.getChildByNameAndNameSpace(C,"call");if(j){w.context=QzXmlTool.getChildTextContentByName(j,"context");if(w.context){w.contextMap=SAM.parseContextToMap(w.context);w.username=w.contextMap["@phonebar.username"];}w.peerAgent=QzXmlTool.getChildAttributeByName(j,"peerAgent","id");
w.action=QzXmlTool.getChildTextContentByName(j,"action");w.actionType=SAM._serviceActionToTypeMap[w.action];if(w.actionType==null){w.actionType=w.action;}w.caller=QzXmlTool.getChildTextContentByName(j,"caller");var c=QzXmlTool.getChildTextContentByName(j,"error");if(c){var n=c.split(":");if(n.length>=2){w.error=n[1];
}}}SAM._dispatcher.dispatchEvent(w);}else{if(l=="want_resting"){var s=QzXmlTool.getChildByNameAndNameSpace(C,"agent");var w={"eventType":l,"agentId":s.getAttribute("id"),"reason":QzXmlTool.getChildTextContentByName(s,"reason")};SAM._dispatcher.dispatchEvent(w);}else{if(a=="http://acd.qingzhi.com/agents/waiting"&&l=="changed"){for(var x=0;
x<C.childNodes.length;x++){var A=C.childNodes[x];if(A.tagName!="agent"){var w={"eventType":"wait_service_changed","info":{"domain":A.tagName,"wait_count":parseInt(A.textContent?A.textContent:A.text)}};SAM._dispatcher.dispatchEvent(w);}}}else{if(l=="request_start"||l=="request_cancelled"||l=="request_changed"||l=="request_satisified"||l.indexOf("request_")==0){var d=SAM.parseQueueRequest(C);
function u(){var e=SAM._findQueueIndex(d.id);if(l=="request_start"||l=="request_changed"){if(e>=0){SAM._queue[e]=d;}else{SAM._queue.push(d);}}else{if(l=="request_cancelled"||l=="request_satisified"){SAM._queue.splice(e,1);}}}if(SAM._needCacheQueue){SAM._cachedQueueMap[d.id]={"eventType":l,"request":d};
}else{u();var w={"eventType":l,"request":d};SAM._dispatcher.dispatchEvent(w);}}}}}}}}}finally{log.debug("SAM.dealMessageFromACD end");}};SAM._findQueueIndex=function(b){if(!SAM._queue){return -1;}for(var a=0;a<SAM._queue.length;a++){if(SAM._queue[a].id==b){return a;}}return -1;};SAM._dispatchServiceEvent=function(c,b,d){if(!c||c==SAM.getCurrentAgentId()){var a={eventType:b,reason:d,isServiceEvent:true};
SAM._dispatcher.dispatchEvent(a);}};SAM._resetAgentStatus=function(){SAM._lastAgentStatus=null;SAM._lastAgentDeviceStatus=null;SAM._lastServiceStatus=null;SAM._lastACDEvent=null;SAM._lastServiceEvent=null;SAM._tel=null;};SAM.getCurrentAgentId=function(){if(!SXC._lastAccountInfo){return null;}return SXC._lastAccountInfo.agent.agent_id;
};SAM.getCurrentUserId=function(){if(!SXC._lastAccountInfo){return null;}return SXC._lastAccountInfo.user_id;};SAM.getOnlineAgentById=function(a){return SAM._agentsMap[a];};SAM.getOnLineAgentMap=function(){return SAM._agentsMap;};SAM.queryAgentList=function(b,a){SAM._getAgentStatus("all",b,a);};SAM._queueMonitor=false;
SAM._cachedQueueMap={};SAM._needCacheQueue=false;SAM._gcInterval=null;SAM._startQueueGC=function(){if(SAM._gcInterval){SAM._stopQueueGC();}SAM._gcInterval=setInterval(function(){SAM._queryQueueList();},2*60*1000+Math.round(Math.random()*90)*1000);};SAM._stopQueueGC=function(){if(SAM._gcInterval){clearInterval(SAM._gcInterval);
SAM._gcInterval=null;}};SAM.startQueueMonitor=function(b,a){SAM._queueMonitor=true;SAM._cachedQueueMap={};SAM._needCacheQueue=true;SAM._sendQueueIq("subscribe",null,a);SAM._queryQueueList(function(i){SAM._needCacheQueue=false;for(var f in SAM._cachedQueueMap){var h=SAM._cachedQueueMap[f];var g=h.request;
var e=h.eventType;var d=SAM._findQueueIndex(g.id);if(e=="request_cancelled"||e=="request_satisified"){if(d>=0){SAM._queue.splice(d,1);}}else{if(d>=0){SAM._queue[d]=g;}else{SAM._queue.push(g);}}}try{if(b){b(SAM._queue);}}finally{for(var f in SAM._cachedQueueMap){var h=SAM._cachedQueueMap[f];var c=h;SAM._dispatcher.dispatchEvent(c);
}SAM._cachedQueueMap={};SAM._startQueueGC();}},function(c){SAM._needCacheQueue=false;if(a){a(c);}});MonitorTool._needStopQueueMonitor=false;};SAM.isQueueMonitor=function(){return SAM._queueMonitor;};SAM._sendQueueIq=function(b,f,e){if(b!="subscribe"&&b!="unsubscribe"){throw new Error("unexpected queue action of:"+b);
}var d=new JSJaCIQ();d.setType("set");d.setTo(SAM._acdNodeId+"@"+SXC.getChtsvrDomain());var c=d.getDoc();var a=JSJaCBuilder.createElement(c,b,"http://acd.qingzhi.com/queues");d.getNode().appendChild(a);SXC.sendIq(d,function(g){if(g.getType()=="result"){if(f){f();}}else{if(e){e(g);}}},function(){if(e){e({"errorReason":"timeout"});
}});};SAM.stopQueueMonitor=function(b,a){if(MonitorTool.isEnabled){MonitorTool._needStopQueueMonitor=true;return;}SAM._queueMonitor=false;SAM._sendQueueIq("unsubscribe",function(){SAM._queue=[];if(b){b();}},a);SAM._stopQueueGC();};SAM.getQueueList=function(){if(SAM._queue==null){SAM._queue=[];}return SAM._queue;
};SAM._queryQueueList=function(e,d){var c=new JSJaCIQ();c.setType("get");c.setTo(SAM._acdNodeId+"@"+SXC.getChtsvrDomain());var b=c.getDoc();var a=JSJaCBuilder.createElement(b,"list","http://acd.qingzhi.com/queues");c.getNode().appendChild(a);SXC.sendIq(c,function(f){if(f.getType()=="result"){var g=[];
var l=QzXmlTool.getChildByNameAndNameSpace(f.getNode(),"list");if(l){var k=l.getElementsByTagName("request");if(k.length>0){for(var j=0;j<k.length;j++){var h=k[j];var m=SAM.parseQueueRequest(h);if(m){g.push(m);}}}}SAM._queue=g;if(e){e(SAM._queue);}}else{if(d){d(f);}}},function(){if(d){d({"errorReason":"timeout"});
}});};SAM.parseQueueRequest=function(d){var c=QzXmlTool.getChildByNameAndNameSpace(d,"call");var g=QzXmlTool.getChildByNameAndNameSpace(d,"request");if(!c||!g){return null;}var a=QzXmlTool.getChildByNameAndNameSpace(g,"agent");var b=new Date().getTime();var h=parseInt(QzXmlTool.getChildTextContentByName(g,"duration"));
var f=QzXmlTool.getChildAttributeByName(d,"request","id");var e={"id":f,"startTime":QzXmlTool.getChildTextContentByName(g,"startTime"),"getDuration":function(){return SAM.getRealDurationFromMili(b,h);},"getDisplayDuration":function(){return DateTimeUtils.beautifulTimeAtSecond(this.getDuration()," ");
},"direction":QzXmlTool.getChildTextContentByName(c,"direction"),"caller":QzXmlTool.getChildTextContentByName(c,"caller"),"callee":QzXmlTool.getChildTextContentByName(c,"callee"),"appData":QzXmlTool.getChildTextContentByName(c,"appData"),"User_Oid":QzXmlTool.getChildTextContentByName(c,"User_Oid"),"callId":QzXmlTool.getChildTextContentByName(c,"callId"),"context":QzXmlTool.getChildTextContentByName(c,"context"),"contextMap":SAM.parseContextToMap(QzXmlTool.getChildTextContentByName(c,"context"))};
if(a){e.agentId=a.getAttribute("id");e.agentContext=QzXmlTool.getChildTextContentByName(a,"context");e.agentContextMap=SAM.parseContextToMap(e.agentContext);}return e;};SAM.getCurrentAgentGroups=function(a,d,b){var c={"self":true};$.extend(c,a);SAM._getAgentGroups(c,d,b);};SAM.getAgentGroups=function(b,a){SAM._getAgentGroups(null,b,a);
};SAM.getEnterpriseAgentGroups=function(a,c,b){SAM._getAgentGroups({"enterpriseAccountName":a},c,b);};SAM._getAgentGroups=function(l,k,h){var e=new JSJaCIQ();e.setType("get");e.setTo(SAM._acdNodeId+"@"+SXC.getChtsvrDomain());var j=e.getDoc();var g=JSJaCBuilder.createElement(j,"list","http://acd.onesoul.cn/agentgroups");
if(true){var i=l&&l.enterpriseAccountName?l.enterpriseAccountName:null;if(!i){var b=SAM.getCurrentAgentId()?SAM.getCurrentAgentId():l.agentId;if(!b||b==""){log.error("SAM._getAgentGroups Cancel for agentId is null.");if(h){h({"errorReason":"agentId is null"});}return;}b+="";var f=b.split(".");if(f.length>=2){i=f[0];
}}if(i){var d=j.createElement("enterpriseAccountName");var c=j.createTextNode(i);d.appendChild(c);g.appendChild(d);}}if(l&&l.self){var b=SAM.getCurrentAgentId()?SAM.getCurrentAgentId():l.agentId;if(!b||b==""){log.error("SAM._sendAction Cancel for agentId is null.");if(h){h({"errorReason":"agentId is null"});
}return;}var a=j.createElement("agent");a.setAttribute("id",b);g.appendChild(a);}e.getNode().appendChild(g);SXC.sendIq(e,function(m){if(m.getType()=="result"){var o=[];var s=QzXmlTool.getChildByNameAndNameSpace(m.getNode(),"list");if(s){var r=s.getElementsByTagName("agentGroup");if(r.length>0){for(var q=0;
q<r.length;q++){var n=r[q];var p={"id":n.getAttribute("id"),"name":QzXmlTool.getChildTextContentByName(n,"name"),"enterpirseAccountName":QzXmlTool.getChildTextContentByName(n,"enterpirseAccountName"),"state":QzXmlTool.getChildTextContentByName(n,"state")};o.push(p);}}}SAM._lastGroupList=o;if(k){k(SAM._lastGroupList);
}}else{if(h){h(m);}}},function(){if(h){h({"errorReason":"timeout"});}});};SAM._cachedAgentMap={};SAM._needCacheAgent=false;SAM.startAgentMonitor=function(b,a){SAM._cachedAgentMap={};SAM._needCacheAgent=true;SAM.setEnableSubscribe(true);MonitorTool._needStopAgentMonitor=false;SAM.queryAgentList(function(f){SAM._needCacheAgent=false;
for(var d in SAM._cachedAgentMap){var e=SAM._cachedAgentMap[d];if(!e){delete SAM._agentsMap[d];}else{SAM._agentsMap[d]=e;}}if(b){b(f);}for(var d in SAM._cachedAgentMap){var c={eventType:SAM.EVENT_PARTNER_AGENT_STATUS_CHANGE,agentId:d};SAM._dispatcher.dispatchEvent(c);}SAM._cachedAgentMap={};},function(c){SAM._needCacheAgent=false;
if(a){a(c);}});};SAM.stopAgentMonitor=function(b,a){if(MonitorTool.isEnabled){MonitorTool._needStopAgentMonitor=true;return;}SAM.setEnableSubscribe(false,b,a);};SAM._getAgentStatus=function(d,i,g){var b=SAM.getCurrentAgentId();if(!b){log.error("Cancel get agent status for agentId is null.");return;}var e=new JSJaCIQ();
e.setType("get");e.setTo(SAM._acdNodeId+"@"+SXC.getChtsvrDomain());var h=e.getDoc();var f=JSJaCBuilder.createElement(h,"status","http://acd.qingzhi.com/agents");if(d!="all"){var a=h.createElement("agent");a.setAttribute("id",b);f.appendChild(a);}if(SAM._deptMonitor&&SXC.getAccountInfo()&&SXC.getAccountInfo().dept_id&&SXC.getAccountInfo().dept_id!="-1"&&SXC.getAccountInfo().dept_id!="0"){var c=h.createElement("department");
c.setAttribute("id",SXC.getAccountInfo().dept_id);f.appendChild(c);}e.getNode().appendChild(f);SXC.sendIq(e,function(j){if(j.getType()=="result"){if(d=="all"){SAM._agentsMap={};}SAM._dealAgentStatusResponse(j);if(i){i(SAM._agentsMap);}}else{log.error("SAM._getAgentStatus response iq failed 可能该座席尚未登录为座席.");
if(g){g(j);}}},function(){log.error("SAM._getAgentStatus response iq failed 可能该座席尚未登录为座席.");if(g){g({"errorReason":"timeout"});}});};SAM._dealAgentStatusResponse=function(f){var g=QzXmlTool.getChildByNameAndNameSpace(f.getNode(),"status");if(g){var d=g.getElementsByTagName("agent");if(d.length>0){for(var c=0;
c<d.length;c++){var a=d[c];var e=a.getAttribute("id");if(e==SAM.getCurrentAgentId()){SAM._dealWithAgentStatusResponseData(a);var b={eventType:SAM.EVENT_AGENT_STATUS_CHANGE};SAM._dispatcher.dispatchEvent(b);}if(SAM._agentsMap[e]==null){SAM._agentsMap[e]={"timeStamp":new Date().getTime(),"agentId":e,"agent":a,"isOffline":false,"_agentData":SAM._getMonitorAgentByEAgent(e,a),"getAgentData":function(){this._agentData=SAM._getMonitorAgentByEAgent(this.agentId,this.agent,this.timeStamp);
return this._agentData;}};}var b={eventType:SAM.EVENT_PARTNER_AGENT_STATUS_CHANGE,agentId:e};SAM._dispatcher.dispatchEvent(b);}}}};SAM._dealWithAgentStatusResponseData=function(a){var b=a.firstChild;while(b){if(!b.tagName){b=b.nextSibling;continue;}if(b.tagName.toLowerCase()=="agentstatus"){if(SAM._lastAgentStatus==null){SAM._lastAgentStatus={"status":b.getAttribute("status"),"reason":b.getAttribute("reason"),"timeStamp":new Date().getTime(),"text":QzXmlTool.getChildTextContentByName(a,"status"),"duration":parseInt(QzXmlTool.getChildAttributeByName(a,"status","duration")),"nativeStatusCode":parseInt(QzXmlTool.getChildAttributeByName(a,"status","nativeStatusCode"))};
}}else{if(b.tagName.toLowerCase()=="devicestatus"){if(SAM._lastAgentDeviceStatus==null){SAM._lastAgentDeviceStatus={"status":b.getAttribute("status"),"reason":b.getAttribute("reason")};}}else{if(b.tagName.toLowerCase()=="servicestatus"){if(SAM._lastServiceStatus==null){SAM._lastServiceStatus={"status":b.getAttribute("status"),"reason":b.getAttribute("reason")};
}}else{if(b.tagName=="call"){SAM._dealWithCallEvent(SAM.getCurrentAgentId(),b,"iqResponse");}else{if(b.tagName=="request"){SAM._dealWithRequestEvent(SAM.getCurrentAgentId(),b,"iqResponse");}else{if(b.tagName=="service"){SAM._dealWithServiceEvent(SAM.getCurrentAgentId(),b,"iqResponse");}}}}}}b=b.nextSibling;
}};SAM._parseCallEvent=function(a){var c=new ACDCall();c.id=a.getAttribute("id");c.startTime=new Date(QzXmlTool.getChildTextContentByName(a,"startTime"));c.caller=QzXmlTool.getChildTextContentByName(a,"caller");c.callee=QzXmlTool.getChildTextContentByName(a,"callee");c.appData=QzXmlTool.getChildTextContentByName(a,"appData");
c.context=QzXmlTool.getChildTextContentByName(a,"context");c.contextMap=SAM.parseContextToMap(c.context);if(c.contextMap.callReason){try{c.callReason=JSON.parse(c.contextMap.callReason);}catch(b){}}c.campaignId=c.contextMap["@campaigns.i_no"];c.taskId=c.contextMap["@tasks.i_no"];c.callId=QzXmlTool.getChildTextContentByName(a,"callId");
c.direction=QzXmlTool.getChildTextContentByName(a,"direction");c.isOutBound=(c.direction=="out");c.isVideo=(c.contextMap["video"]=="1");c.expectedAgent=QzXmlTool.getChildAttributeByName(a,"expectedAgent","id");log.debug("SAM.call.callId:"+c.callId);return c;};SAM._dealWithCallEvent=function(b,a,d){var c=SAM._parseCallEvent(a);
if(!b||b==SAM.getCurrentAgentId()){if(d=="event"||!SAM._lastACDEvent||!SAM._lastACDEvent.acdCall){SAM._checkLastACDEvent();SAM._lastACDEvent.acdCall=c;}}};SAM._checkLastACDEvent=function(){if(!SAM._lastACDEvent){SAM._lastACDEvent=new ACDEvent();}};SAM._dealWithRequestEvent=function(b,d,c){var a=new ACDRequest();
a.id=d.getAttribute("id");a.queueId=QzXmlTool.getChildAttributeByName(d,"queue","id");a.startTime=new Date(QzXmlTool.getChildTextContentByName(d,"startTime"));if(!b||b==SAM.getCurrentAgentId()){if(c=="event"||!SAM._lastACDEvent||!SAM._lastACDEvent.acdRequest){SAM._checkLastACDEvent();SAM._lastACDEvent.acdRequest=a;
}}};SAM._serviceActionToTypeMap={"10":"邀请用户","11":"邀请外线","12":"邀请座席","15":"转接用户","16":"转接外线","17":"转接座席","18":"转接组","19":"盲转组","20":"主动接听","22":"主动接听","23":"代答","25":"监听用户","27":"监听座席","28":"监听会话","30":"对用户插话","32":"对座席插话","33":"对会话插话","35":"打断用户","36":"打断电话","37":"打断座席","40":"接管用户","41":"接管电话","42":"接管座席","45":"离开会话","46":"保持当前会话","47":"拾回指定会话","48":"录音开始","49":"录音停止","53":"登录成虚拟座席","57":"就绪","58":"置忙","59":"完成","60":"坐席申请[小憩]","61":"IVR辅导","65":"令指定坐席[小憩]","66":"锁定指定坐席","67":"解锁指定坐席","68":"强制签退指定坐席","80":"呼叫用户","81":"呼叫外线","82":"呼叫座席","100":"二步转接用户","101":"二步转接外线","102":"二步转接座席","103":"二步转接组","17":"transfer","12":"invite","22":"answerFor","32":"chimeIn","23":"outbound","82":"callAgent","13":"acd"};
SAM._dealWithServiceEvent=function(c,a,d){var b=new ACDService();b.agentId=c;b.id=a.getAttribute("id");b.type=a.getAttribute("type");b.uid=a.getAttribute("uid");b.startTime=QzXmlTool.getChildTextContentByName(a,"startTime");b.pickupTime=QzXmlTool.getChildTextContentByName(a,"pickupTime");b.endTime=QzXmlTool.getChildTextContentByName(a,"endTime");
b.callee=QzXmlTool.getChildTextContentByName(a,"callee");b.callId=QzXmlTool.getChildTextContentByName(a,"callId");b.peerAgent=QzXmlTool.getChildTextContentByName(a,"peerAgent");b.action=QzXmlTool.getChildTextContentByName(a,"action");b.errorCode=QzXmlTool.getChildTextContentByName(a,"errorCode");b.errorInfo=QzXmlTool.getChildTextContentByName(a,"errorInfo");
b.actionType=SAM._serviceActionToTypeMap[b.action];if(b.actionType==null){b.actionType=b.action;}log.debug("SAM.service.callId:"+b.callId);if(!c||c==SAM.getCurrentAgentId()){if(d=="event"||!SAM._lastACDEvent||!SAM._lastACDEvent.acdService){SAM._checkLastACDEvent();SAM._lastACDEvent.acdService=b;}}};SAM._subscribeFlag=false;
SAM.setEnableSubscribe=function(a,c,b){SAM._subscribeFlag=a;if(a){SAM._sendSubscribe(c,b);}else{SAM._sendUnSubscribe(c,b);}};SAM._deptMonitor=false;SAM.setDeptMonitor=function(a){SAM._deptMonitor=a;};SAM.isDeptMonitor=function(){return SAM._deptMonitor;};SAM.isEnableSubscribe=function(){return SAM._subscribeFlag;
};SAM._sendSubscribe=function(b,a){SAM._sendAction({action:"subscribe"},b,a);};SAM._sendUnSubscribe=function(b,a){SAM._sendAction({action:"unsubscribe"},b,a);};SAM.getCustomerCtx=function(b,a){SAM._sendAction({action:"getCustomerCtx"},function(d){if(b){var h=QzXmlTool.getChildByNameAndNameSpace(d.getNode(),"getCustomerCtx");
var c=QzXmlTool.getChildByNameAndNameSpace(h,"call");var f=QzXmlTool.getChildAttributeByName(h,"call","id");var e=QzXmlTool.getChildTextContentByName(c,"context");var g={"call_id":f,"context":e,"contextMap":SAM.parseContextToMap(e)};b(g);}},a);};SAM.stringifyContext=function(c){var b="";for(var a in c){b+=a+"="+c[a]+"\n";
}return b;};SAM.setCustomerCtx=function(a,c,b){SAM._sendAction({action:"setCustomerCtx",context:SAM.stringifyContext(a)},c,b);};SAM.pickupRequest=function(b,e,c){var d={action:"answerFor",target:{type:"request",text:b}};var a=70;return SAM._sendAction(d,e,c,a);};SAM.getAgentPower=function(){var b={};
var c=SXC&&SXC._lastAccountInfo&&SXC._lastAccountInfo.agent&&SXC._lastAccountInfo.agent.feature&&SXC._lastAccountInfo.agent.role;if(c){var a=JSON.stringify(SXC._lastAccountInfo.agent.role);b.leader=a.indexOf("leader")>=0;b.quality=a.indexOf("quality")>=0;b.manager=a.indexOf("manager")>=0;}if(SXC&&SXC._lastAccountInfo&&SXC._lastAccountInfo.roles){b.superAdmin=(SXC._lastAccountInfo.roles.indexOf("super_admin")>=0);
b.normalAdmin=(SXC._lastAccountInfo.roles.indexOf("normal_admin")>=0);}return b;};SAM.packet_type="CROSS_BROWSER_SAM_PACKET";SAM._CAMResultFeature="onesoul.csamresult.feature";SAM._CAMCallbackParamFeature="_cam_call_back_param_feature_";SAM.targetWindow=null;SAM._privateEventDealer=function(a){var c={"packet_type":SAM.packet_type,"type":"onSAMEvent","event":a};
var b=JSON.stringify(c);if(SAM.targetWindow){SAM.targetWindow.postMessage(b,"*");}else{window.postMessage(b,"*");}};SAM.startCrossBrowserService=function(c,b){if(c&&!c.postMessage){throw new Error("传入的窗口对象不支持 postMessage 机制。");}SAM.targetWindow=c;SAM.removeEventListener(SAM._privateEventDealer);SAM.addEventListener(SAM._privateEventDealer);
var a=function(e){var g=e.source;delete e["source"];e.packet_type=SAM.packet_type;var f=JSON.stringify(e);if(g&&g.postMessage){g.postMessage(f,"*");}else{window.postMessage(f,"*");}};var d=function(g){var l=g.data;var r=g.origin;var f=g.source;var h=JSON.parse(l);if(h.packet_type!=SAM.packet_type){return;
}if(h.type=="request"){for(var m=0;m<h.params.length;m++){if(h.params[m]&&h.params[m].indexOf&&h.params[m].indexOf(SAM._CAMCallbackParamFeature)>=0){var k=h.params[m];h.params[m]=function(){var s=[];for(var i=0;i<arguments.length;i++){s[i]=arguments[i];}var e={"id":h.id,"type":k,"params":s,"source":f};
a(e);};}}var o=window[h.method]?window[h.method]:SAM[h.method];if(!o){var j={"id":h.id,"type":"result","result":null,"error":new Error("methodNotFound"),"source":f};a(j);return;}var q="";if(window[h.method]){q=h.method;}else{q="SAM."+h.method;}if(b){if(!b(q,r)){var j={"id":h.id,"type":"result","result":null,"error":new Error("methodNotPermit"),"source":f};
a(j);return;}}try{var p=o.apply(null,h.params);var j={"id":h.id,"type":"result","result":p,"error":null,"source":f};a(j);}catch(n){var j={"id":h.id,"type":"result","result":null,"error":n,"source":f};a(j);return;}}};if(typeof window.addEventListener!="undefined"){window.addEventListener("message",d,false);
}else{if(typeof window.attachEvent!="undefined"){window.attachEvent("onmessage",d);}}};function ACDCall(a){this.id="";this.startTime=new Date();this.caller="";this.callee="";this.appData="";this.context="";this.callId="";this.direction="";this.isOutBound=true;}function ACDRequest(){this.id="";this.queueId="";
this.startTime=new Date();}function ACDEvent(){this.acdCall=null;this.acdRequest=null;this.acdService=null;}function ACDRecord(){this.startTime=new Date();this.elapseSeconds=0;this.fileName="20120523163011890000.wav";}function ACDService(){this.id="";this.type="cti";this.uid="";this.agentId="";this.callee="";
this.startTime=new Date();this.pickupTime=new Date();this.callId="";this.records=new Array();}SimpleAgentMgr=SAM;var MonitorTool={"isEnabled":false,"_needStopQueueMonitor":false,"_needStopAgentMonitor":false,"start":function(){if(this.isEnabled){return;}this.isEnabled=true;if(!SAM.isEnableSubscribe()){SAM.startAgentMonitor();
this._needStopAgentMonitor=true;}if(!SAM.isQueueMonitor()){SAM.startQueueMonitor();this._needStopQueueMonitor=true;}},"stop":function(){if(!this.isEnabled){return;}this.isEnabled=false;if(this._needStopQueueMonitor){SAM.stopQueueMonitor();this._needStopQueueMonitor=false;}if(this._needStopAgentMonitor){SAM.stopAgentMonitor();
this._needStopAgentMonitor=false;}},"lastChangeTick":0,"agentOfReady":{"ready":0,"other":0},"agentOfStatus":{},"refresh":function(){this.checkToRefreshValue();},"queueStat":{"队列客户总数":0,"等待接听数":0,"最小等待时长":0,"最大等待时长":0,"平均等待时长":0},"queueDesend":[],"queueSum":{"0-5":0,"6-10":0,"11-15":0,"16-30":0,"31-60":0,"61-90":0,">90":0},"queueOfSkill":{},"agentOfSkill":{},"_parseAllGroupList":function(){var e=[];
var a={};for(var h in SAM._agentsMap){var j=SAM._agentsMap[h];var c=j.getAgentData();for(var d=0;d<c.groups.length;d++){var g=c.groups[d];if(g!=null&&g!=""){if(a[g]==null){a[g]=1;e.push(g);}}}}for(var d=0;d<SAM._queue.length;d++){var f=SAM._queue[d];var b=f.contextMap["@request_skill"];if(b!=null&&b!=""&&(b.indexOf("E")!=0)){if(a[b]==null){a[b]=1;
e.push(b);}}}return e;},"statBySkill":{},"_reCalculateData":function(){this.statBySkill={};var e={"任意":0};var b={"所有":0};var a=this._parseAllGroupList();for(var d=0;d<a.length;d++){var c=a[d];this._calculateWithFilter(c);this.statBySkill[c]={"agentOfStatus":this.agentOfStatus,"queueStat":this.queueStat,"queueDesend":this.queueDesend,"queueSum":this.queueSum};
e[c]=this.queueOfSkill[c];b[c]=this.agentOfSkill[c];}this._calculateWithFilter();this.statBySkill["任意"]={"agentOfStatus":this.agentOfStatus,"queueStat":this.queueStat,"queueDesend":this.queueDesend,"queueSum":this.queueSum};e["任意"]=this.queueOfSkill["任意"];b["所有"]=this.agentOfSkill["所有"];this.queueOfSkill=e;
this.agentOfSkill=b;},"listToMap":function(c){var d={};for(var a=0;a<c.length;a++){var b=c[a]+"";if(b!=null){d[b]=true;}}return d;},"_calculateWithFilter":function(f){var m=0;var b=0;this.agentOfStatus={};this.agentOfStatus["在线"]=0;this.agentOfSkill={"所有":0};for(var l in SAM._agentsMap){var n=SAM._agentsMap[l];
var e=n.getAgentData();if(e._groupMap==null){e._groupMap=this.listToMap(e.groups);}if(f!=null&&e._groupMap[f]==null){continue;}if(e.agentStatus=="ready"){b++;}var h=this.agentOfStatus[e.displayStatus];if(h==null){this.agentOfStatus[e.displayStatus]=1;}else{this.agentOfStatus[e.displayStatus]=h+1;}m++;
}this.agentOfSkill={"所有":m};this.agentOfSkill[f]=m;this.agentOfStatus["在线"]=m;this.agentOfReady.ready=b;this.agentOfReady.other=m-b;this.queueStat={"队列客户总数":0,"等待接听数":0,"最小等待时长":0,"最大等待时长":0,"平均等待时长":0};this.queueDesend=[];this.queueSum={"0-5":0,"6-10":0,"11-15":0,"16-30":0,"31-60":0,"61-90":0,">90":0};
this.queueOfSkill={"任意":0};var a=0;for(var g=0;g<SAM._queue.length;g++){var k=SAM._queue[g];var d=k.contextMap["@request_skill"];if(f!=null&&d!=f){continue;}var c=k.getDuration();if(k.agentId!=null){this.queueStat["等待接听数"]++;}this.queueDesend.push(c);if(c<=5){this.queueSum["0-5"]++;}else{if(c<=10){this.queueSum["0-5"]++;
}else{if(c<=15){this.queueSum["6-15"]++;}else{if(c<=30){this.queueSum["16-30"]++;}else{if(c<=60){this.queueSum["31-60"]++;}else{if(c<=90){this.queueSum["61-90"]++;}else{this.queueSum[">90"]++;}}}}}}if(d==null||d==""){d="任意";}var j=this.queueOfSkill[d];if(j==null){j=0;}this.queueOfSkill[d]=j+1;a+=c;}this.queueDesend.sort(function(o,i){return i-o;
});if(this.queueDesend.length>0){this.queueStat["队列客户总数"]=this.queueDesend.length;this.queueStat["最小等待时长"]=this.queueDesend[this.queueDesend.length-1];this.queueStat["最大等待时长"]=this.queueDesend[0];this.queueStat["平均等待时长"]=Math.round(a/this.queueDesend.length);}},"checkToRefreshValue":function(){var a=new Date().getTime()-this.lastChangeTick;
if(a<1000){return;}this._reCalculateData();this.lastChangeTick=new Date().getTime();}};(function(){var d=null;var h=SAM.connect;var j=SAM.disconnect;var g=[];function c(l){var m={"type":"wait","time":new Date().getTime(),"stop_time":new Date().getTime()+l,"mark":""};return m;}function k(){if(d==null){d=setInterval(function(){if(g.length<=0){clearInterval(d);
d=null;return;}var l=g[0];if(l.type=="connect"){i("connectProc");try{h.apply(SAM,l.arguments);}finally{g[0]=c(5*1000);}}else{if(l.type=="disconnect"){i("disconnectProc");try{j();}finally{g[0]=c(1*1000);}}else{if(l.type=="wait"&&(new Date().getTime()>l.stop_time)){i("wait");g.shift();}}}},500);}}function f(l){for(var m=g.length-1;
m>=0;m--){var n=g[m];if(n.type==l){g.splice(m,1);i("job removed:"+l);}}}var b="";function a(){b="connect";i("doConnect");f("connect");var l={"type":"connect","time":new Date().getTime(),"arguments":arguments,"mark":""};g.push(l);k();}function e(){b="disconnect";i("doDisconnect");f("connect");f("disconnect");
if(g.length<=0){i("disconnectProc");j();}else{var l={"type":"disconnect","time":new Date().getTime(),"mark":""};g.push(l);k();}}function i(l){if(SAMTool.listener){SAMTool.listener(l);}}SAM.connect=a;SAM.disconnect=e;window.SAMTool={"listener":null,"getLastAction":function(){return b;}};})();function SAU(){}var js=document.scripts;
SAU._imgPath=js[js.length-1].src.substring(0,js[js.length-1].src.lastIndexOf("/")+1);SAU.imgBasePath=null;SAU.onBeforeConnect=function(){return true;};SAU.getAccessInfo=function(){if(SAU.onConnectParams){var a=SAU.onConnectParams();if(a.accessInfo){return a.accessInfo;}else{throw new Error("Unexpected SAU.onConnectParams accessInfo is NULL");
}}else{throw new Error("Unexpected SAU.onConnectParams is NULL");}};SAU.getFullImgUrl=function(b){var c=SAU.getAccessInfo().service_base_url;if(c){var d="chat";var a=c.lastIndexOf(d);if(a==c.length-d.length){return b;}else{if(SAU.imgBasePath){return SAU.imgBasePath+b;}else{return SAU._imgPath+"../"+b;
}}}else{throw new Error("Unexpected SAU.onConnectParams service_base_url is NULL");}};SAU.$container=null;SAU.createUI=function(a){var e=null;if(typeof(a)=="string"){if($("#"+a).length<=0){throw new Error("未找到此Id对应的Html容器组件:"+a);}e=$("#"+a);}else{if(a.length>0){e=a;}else{throw new Error("未预期的传入数据:"+a);
}}SAU.$container=e;var b="";b+='<table id="agentBarTable" border="0" cellpadding="0" cellspacing="0" width="100%" style="margin-left:5px;">';b+='<tr id="agentBarRowImage">';b+='<td clickId="imgConnect" width="80" height="30" style="text-align: center;" ><img id="imgConnect" alt="" title="" src="'+SAU.getFullImgUrl("images/icon19_off.png")+'" class="icon"></td>';
b+='<td id="simpleReady" width="60" height="30" style="text-align: center;display:none;padding-right:5px;" >'+'<a id="simpleReadyLink" style="position: relative;-webkit-box-shadow: inset 0 1px 4px rgba(0,0,0,0.4);-moz-box-shadow: inset 0 1px 4px rgba(0,0,0,0.4);outline-style: none;text-decoration: none;font-weight:bold;display: inline-block;padding: 0 10px 0 30px;color: white;line-height: 22px;border-radius: 27px;cursor: pointer;min-width:70px;background: #19b5de left center no-repeat;">就绪</a>'+"</td>";
b+='<td id="simpleConnectStatus" clickId="tdDuration" width="80" height="30" style="text-align: center;" >持续时间</td>';b+='<td id="simpleStatusDuration" width="80" height="30" clickId="" align="center" class="buttonText" style="color:white;padding-right:5px;font-weight:bold;display:none;" >--:--:--</td>';
b+='<td class="videoChatTag" width="80" height="30" style="text-align: center;display:none;" ><img width="30px" height="30px"  alt="" title="" src="'+SAU.getFullImgUrl("images/videoChat.png")+'" class="icon"></td>';b+='<td clickId="imgReady" width="30" height="30" style="text-align: center;" ><img id="imgReady" alt="就绪" title="就绪" src="'+SAU.getFullImgUrl("images/na.gif")+'" class="icon"></td>';
b+='<td clickId="imgBusy" width="30" height="30" style="text-align: center;" ><img id="imgBusy" alt="忙" title="忙" src="'+SAU.getFullImgUrl("images/na.gif")+'" class="icon"></td>';b+='<td clickId="imgRest" width="30" height="30" style="text-align: center;" ><img id="imgRest" alt="小憩" title="小憩" src="'+SAU.getFullImgUrl("images/na.gif")+'" class="icon"></td>';
b+='<td clickId="simpleImgRest" width="30" height="30" style="text-align: center;" ><img id="simpleImgRest" width="28px" alt="小憩" title="小憩" src="'+SAU.getFullImgUrl("images/rest.png")+'" class="icon"></td>';b+='<td clickId="imgAfterService" width="30" height="30" style="text-align: center;" ><img id="imgAfterService" alt="完成事后处理" title="完成事后处理" src="'+SAU.getFullImgUrl("images/call1.png")+'" class="icon"></td>';
b+='<td clickId="imgHangUp" width="40" height="30" style="text-align: center;" ><img id="imgHangUp" alt="挂断" title="挂断" src="'+SAU.getFullImgUrl("images/hund1.png")+'" class="icon"></td>';b+='<td clickId="imgHold" width="40" height="30" style="text-align: center;" ><img id="imgHold" alt="保持" title="保持" src="'+SAU.getFullImgUrl("images/hold1.png")+'" class="icon"></td>';
b+='<td clickId="imgUnHold" width="40" height="30" style="text-align: center;" ><img id="imgUnHold" alt="拾回" title="拾回" src="'+SAU.getFullImgUrl("images/pickup1.png")+'" class="icon"></td>';b+='<td clickId="imgOutbound" width="60" height="30" style="text-align: center;" ><img id="imgOutbound" alt="呼叫电话" title="呼叫电话" src="'+SAU.getFullImgUrl("images/out1.png")+'" class="icon"></td>';
b+='<td clickId="imgCallAgent" width="60" height="30" style="text-align: center;" ><img id="imgCallAgent" alt="呼叫座席" title="呼叫座席" src="'+SAU.getFullImgUrl("images/invi1.png")+'" class="icon"></td>';b+='<td clickId="imgTransferOutbound" width="60" height="30" style="text-align: center;" ><img id="imgTransferOutbound" alt="转接电话" title="转接电话" src="'+SAU.getFullImgUrl("images/transOut1.png")+'" class="icon"></td>';
b+='<td clickId="imgTransfer" width="60" height="30" style="text-align: center;" ><img id="imgTransfer" alt="转接座席" title="转接座席" src="'+SAU.getFullImgUrl("images/zhu1.png")+'" class="icon"></td>';b+='<td clickId="imgInviteOutbound" width="60" height="30" style="text-align: center;" ><img id="imgInviteOutbound" alt="邀请电话" title="邀请电话" src="'+SAU.getFullImgUrl("images/inviOut1.png")+'" class="icon"></td>';
b+='<td clickId="imgInvite" width="60" height="30" style="text-align: center;" ><img id="imgInvite" alt="邀请座席" title="邀请座席" src="'+SAU.getFullImgUrl("images/invi1.png")+'" class="icon"></td>';b+='<td clickId="imgQueue" width="60" height="30" style="text-align: center;display:none;" ><img id="imgQueue" alt="等待队列" title="等待队列" src="'+SAU.getFullImgUrl("images/wait.png")+'" class="icon"></td>';
b+='<td clickId="imgAgentMonitor" width="60" height="30" style="text-align: center;" ><img id="imgAgentMonitor" alt="查看座席列表并进行相应操作" title="查看座席列表并进行相应操作" src="'+SAU.getFullImgUrl("images/agents.png")+'" class="icon"></td>';b+='<td clickId="imgSetup" class="imgSetup" width="60" height="30" style="text-align: center;" ><img id="imgSetup" alt="设置" title="设置" src="'+SAU.getFullImgUrl("images/setup.png")+'" class="icon"></td>';
b+='<td id="agentHint" rowspan="2" style="color: white;padding-right:5px;width:auto;"></td>';b+="</tr>";b+='<tr id="agentBarRowText">';b+='<td id="tdConnect" align="center" height="20" style="color:white;font-weight:bold;" >未登录</td>';b+='<td id="simpleReadyText" align="center" height="20" style="color:blue;font-weight:bold;display:none;" >状态切换</td>';
b+='<td id="statusDuration" clickId="" align="center" class="buttonText" style="color:blue;font-weight:bold;" >--:--:--</td>';b+='<td id="simpleStatusDuration" clickId="" align="center" class="buttonText" style="display:none;" >--:--:--</td>';b+='<td class="videoChatTag" alt="视频窗口" title="视频窗口" align="center" height="20" style="color:blue;font-weight:bold;display:none;" >视频会话</td>';
b+='<td clickId="imgReady" align="center" class="buttonText" >就绪</td>';b+='<td clickId="imgBusy" align="center" class="buttonText" >忙</td>';b+='<td clickId="imgRest" align="center" class="buttonText" >小憩</td>';b+='<td clickId="simpleImgRest" align="center" class="buttonText" style="display:none;" >小憩</td>';
b+='<td clickId="imgAfterService" align="center" class="buttonText" >完成</td>';b+='<td clickId="imgHangUp" align="center" class="buttonText" >挂断</td>';b+='<td clickId="imgHold" align="center" class="buttonText" style="">保持</td>';b+='<td clickId="imgUnHold" align="center" class="buttonText" style="" >拾回</td>';
b+='<td clickId="imgOutbound" align="center" class="buttonText" >呼叫电话</td>';b+='<td clickId="imgCallAgent" align="center" class="buttonText" >呼叫座席</td>';b+='<td clickId="imgTransferOutbound" align="center" class="buttonText" style="" >转接电话</td>';b+='<td clickId="imgTransfer" align="center" class="buttonText" style="">转接座席</td>';
b+='<td clickId="imgInviteOutbound" align="center" class="buttonText" style="" >邀请电话</td>';b+='<td clickId="imgInvite" align="center" class="buttonText" style="">邀请座席</td>';b+='<td clickId="imgQueue" style="display:none;" align="center" class="buttonText" >等待队列</td>';b+='<td clickId="imgAgentMonitor" style="" align="center" class="buttonText" >所有座席</td>';
b+='<td id="imgSetupText" clickId="imgSetup" align="center" class="buttonText imgSetup" >设置</td>';b+='<td align="center">&nbsp;</td>';b+="</tr>";b+="</table>";SAU.$container.find("#agentBarTable").css("","");e.append(b);SAU.$container.find("#agentBarTable").css("background","url('"+SAU.getFullImgUrl("images/gray-bg.gif")+"') repeat-x scroll");
SAU.$container.find("#agentBarTable td").css("word-break","break-all");SAU.$container.find("#agentBarTable td").css("font-size","13px");SAU.$container.find("#agentBarTable th").css("word-break","break-all");SAU.$container.find("#agentBarTable th").css("font-size","13px");SAU.$container.find("#agentBarTable .icon").css("cursor","pointer");
SAU.$container.find("#agentBarTable .buttonText").css("cursor","pointer");SAU.$container.find("#agentBarTable img").css("margin","0px");SAU.getStatusTextObj().text("未登录");if(SAU.getStyle()!="simple"){SAU.getStatusTextObj().css("color","red");}SAU.$container.find("#imgConnect").attr("title","点击登录");var c=SAU.getAccessInfo();
SAM.addEventListener(SAU._doOnEvents,"SAU._doOnEvents");function d(){if(SAM.isLogined()){SAM.disconnect();}else{if(SAU.onBeforeConnect){var f=SAU.onBeforeConnect();if(!f){return;}}SAU.$container.find("#agentHint").text("");SAM.connect(c,SAU.onConnectParams().telOption,SAU.onConnectParams().agentStatus);
}}SAU.$container.find("#agentBarTable").find("td").unbind("click").bind("click",function(){var h=$(this);var i=h.attr("clickId");if(i==null||i==""){return;}if(i=="imgConnect"){d();}else{var g=(i=="imgReady")||(i=="imgBusy")||(i=="imgRest")||(i=="simpleImgRest")||(i=="imgHangUp")||(i=="imgAgentMonitor")||(i=="imgAfterService");
if(g&&!SAM.isLogined()&&!SAM.monitorMode){alert("请在座席已登录情况下操作。");return;}if(i=="imgReady"){SAM.ready("");}else{if(i=="imgBusy"){SAM.busy("");}else{if(i=="imgHangUp"){actionMap=SAM.getAvailableActions();if(actionMap.hangup){if(SAM.beforeHangup){SAM.beforeHangup(function(){SAM.hangup();});}else{SAM.hangup();
}}}else{if(i=="imgAfterService"){actionMap=SAM.getAvailableActions();if(actionMap.complete){SAM.complete();}}else{if(i=="imgHold"){actionMap=SAM.getAvailableActions();if(actionMap.hold){SAM.hold();}}else{if(i=="imgUnHold"){actionMap=SAM.getAvailableActions();if(actionMap.unhold){SAM.unhold();}}}}}}}}var f={eventType:"onButtonClicked",buttonId:i};
SAM._dispatcher.dispatchEvent(f);});SAU._timer=setInterval(function(){if(window.SAM&&SAM.getAgentStatus()&&SAU.$container){SAU.$container.find("#statusDuration").text(SAM.getDisplayStatusDuration());SAU.$container.find("#simpleStatusDuration").text(SAM.getDisplayStatusDuration());SAU.updateStatusDuration();
}},1000);};SAU.hideSetup=function(){SAU.$container.find(".imgSetup").hide();};SAU.getStatusTextObj=function(){if(SAU.getStyle()=="simple"){return SAU.$container.find("#simpleConnectStatus");}else{return SAU.$container.find("#tdConnect");}};SAU._showActions=true;SAU.hideActionButtons=function(){SAU._showActions=false;
SAU.$container.find("#imgAgentMonitor").parent().hide();SAU.$container.find("#imgSetup").parent().hide();};SAU.triggerCallPhoneEvent=function(b){var a={eventType:"onButtonClicked",buttonId:"imgOutbound",phone:b};SAM._dispatcher.dispatchEvent(a);};SAU.getStyle=function(){return SAU.style?SAU.style:"full";
};SAU.setStyle=function(a){if(a=="simple"){SAU.$container.find("#imgConnect").parent().css("height","45px");SAU.$container.find("#agentBarTable").css("background","");SAU.$container.find("#simpleConnectStatus").css("color","white");SAU.$container.find("#agentBarRowText").hide();SAU.$container.find("#imgReady").parent().hide();
SAU.$container.find("#imgBusy").parent().hide();SAU.$container.find("#imgRest").parent().hide();SAU.updateStatusDuration();SAU.$container.find("#simpleReadyLink").unbind("click").bind("click",function(){if(SAM.isLogined()&&SAM.getAgentStatus()){if(SAM.getAgentStatus().status=="ready"){SAM.busy("");}else{if(SAM.getAgentStatus().status=="not_ready"){SAM.ready("");
}}}});}else{if(a=="full"){SAU.$container.find("#agentBarRowText").show();}else{throw new Error("未知的 style");}}SAU.style=a;if(SAM.isLogined()){SAU.getStatusTextObj().css("color",SAU.getStyle()=="simple"?"white":"blue");}else{if(SAU.getStyle()!="simple"){SAU.getStatusTextObj().css("color","red");}}SAU.getStatusTextObj().text(SAM.getDisplayStatus());
if(a=="simple"){SAU.$container.find("#agentBarTable").css("width","auto");SAU.$container.find("#agentBarTable td").css("width","auto");SAU.$container.find("#agentBarTable td").css("padding-right","5px");SAU.$container.find("#imgConnect").parent().css("padding-left","5px");SAU.$container.find("#agentBarTable .splitter").css("width","10px");
SAU.$container.find("#simpleReady").css("width","75px");SAU.$container.find("#simpleConnectStatus").css("width","75px");SAU.$container.find("#simpleStatusDuration").css("width","75px");SAU.$container.find("#agentHint").css("width","auto");SAU.$container.find("#simpleReady").css("width","auto");}SAU.updateComponentImg();
};SAU.showVideoChatTag=function(){SAU.$container.find(".videoChatTag").show();};SAU.hideVideoChatTag=function(){SAU.$container.find(".videoChatTag").hide();};SAU.setVideoChatTagClick=function(a){SAU.$container.find(".videoChatTag").unbind("click").bind("click",a);};SAU._doOnEvents=function(a){if(a.eventType=="onConnect"){if(SAM.isLogined()){SAU.getStatusTextObj().text(SAM.getDisplayStatus());
SAU.getStatusTextObj().css("color",SAU.getStyle()=="simple"?"white":"blue");}else{SAU.getStatusTextObj().text("未登录");if(SAU.getStyle()!="simple"){SAU.getStatusTextObj().css("color","red");}}}else{if(a.eventType=="onLoginSuccess"){SAU.$container.find("#imgConnect").attr("title","点击登出");if(SAM.isLogined()){SAU.getStatusTextObj().text(SAM.getDisplayStatus());
SAU.getStatusTextObj().css("color",SAU.getStyle()=="simple"?"white":"blue");}SAU.$container.find("#agentHint").text("");}else{if(a.eventType=="onLogout"||a.eventType=="onLoginFailed"||a.eventType=="onCancel"){SAU.$container.find("#imgReady").attr("src",SAU.getFullImgUrl("images/na.gif"));SAU.$container.find("#imgBusy").attr("src",SAU.getFullImgUrl("images/na.gif"));
SAU.$container.find("#imgRest").attr("src",SAU.getFullImgUrl("images/na.gif"));SAU.getStatusTextObj().text("未登录");if(SAU.getStyle()!="simple"){SAU.getStatusTextObj().css("color","red");}SAU.$container.find("#statusDuration").text("--:--:--");SAU.$container.find("#simpleStatusDuration").text("--:--:--");
SAU.$container.find("#simpleReady").attr("title","");SAU.$container.find("#imgConnect").attr("title","点击登录");SAU.hideVideoChatTag();SAU.updateComponentImg();if(a.reason=="virtual_agent"){SAU.$container.find("#agentHint").text("您已切换为虚拟座席。");}else{if(a.reason=="kicked"){var b="您已在其他终端上线。";if(a.by&&a.by.indexOf("mobile.ios")>=0){b="您已在苹果终端上线。";
}else{if(a.by&&a.by.indexOf("mobile.android")>=0){b="您已在安卓终端上线。";}else{if(a.by&&a.by.indexOf("pc")>=0){b="您已在其他PC终端上线。";}}}SAU.$container.find("#agentHint").text(b);}else{if(a.reason=="onDisconnect"){SAU.$container.find("#agentHint").text("通讯断开。");}else{if(a.reason=="acd_offline"){SAU.$container.find("#agentHint").text("ACD离线。");
}else{if(a.eventType=="cancel"){SAU.$container.find("#agentHint").text("登录操作被取消。");}else{if(a.reason=="onVerifyFailed"){SAU.$container.find("#agentHint").text("后台身份验证失败。");}else{if(a.reason=="onAuthError"){SAU.$container.find("#agentHint").text("chtsvr 身份验证失败。");}else{if(a.reason=="loginToAcdFailed"){SAU.$container.find("#agentHint").text(a.reasonText);
}else{if(a.reason=="connect_error"){SAU.$container.find("#agentHint").text("目标主机连接不上。");}else{if(a.eventType=="onLoginFailed"){SAU.$container.find("#agentHint").text("登录ACD失败。");}else{SAU.$container.find("#agentHint").text("您已主动登出。");}}}}}}}}}}}else{if(a.eventType=="onRecvChatMsg"){}else{if(a.eventType=="onAgentStatusChange"){}else{if(a.eventType=="onAgentServiceStatusChange"){if(SAM.isLogined()){SAU.getStatusTextObj().text(SAM.getDisplayStatus());
SAU.getStatusTextObj().css("color",SAU.getStyle()=="simple"?"white":"blue");}}}}}}}SAU.updateComponentImg();};SAU.updateComponentImg=function(){var c="";if(SAM.getServiceStatus()){c=SAM.getServiceStatus().status;}var e="";if(SAM.getAgentStatus()){e=SAM.getAgentStatus().status;}var f="";if(SAM.getAgentDeviceStatus()){f=SAM.getAgentDeviceStatus().status;
}if(c=="service"){SAU.$container.find("#imgConnect").attr("src",SAU.getFullImgUrl("images/icon19_talking.png"));}else{if(e=="ready"){SAU.$container.find("#imgConnect").attr("src",SAU.getFullImgUrl("images/icon19_on.png"));}else{if(e=="not_ready"){SAU.$container.find("#imgConnect").attr("src",SAU.getFullImgUrl("images/icon19_disturb.png"));
}else{if(SAM.isLogined()){SAU.$container.find("#imgConnect").attr("src",SAU.getFullImgUrl("images/icon19_on.png"));}else{SAU.$container.find("#imgConnect").attr("src",SAU.getFullImgUrl("images/icon19_off.png"));}}}}var a=SAM.getAvailableActions();if(SAU.getStyle()=="simple"&&!SAU._showActions){a={};}if(a.outbound){SAU.$container.find("#imgOutbound").attr("src",SAU.getFullImgUrl("images/out.png"));
SAU.$container.find("#imgCallAgent").attr("src",SAU.getFullImgUrl("images/invi.png"));}else{SAU.$container.find("#imgOutbound").attr("src",SAU.getFullImgUrl("images/out1.png"));SAU.$container.find("#imgCallAgent").attr("src",SAU.getFullImgUrl("images/invi1.png"));}if(SAU.getStyle()=="simple"){if(a.outbound){SAU.$container.find("#imgOutbound").parent().show();
SAU.$container.find("#imgCallAgent").parent().show();}else{SAU.$container.find("#imgOutbound").parent().hide();SAU.$container.find("#imgCallAgent").parent().hide();}if(a.hangup){SAU.$container.find("#imgHangUp").parent().show();}else{SAU.$container.find("#imgHangUp").parent().hide();}if(a.invite){SAU.$container.find("#imgInvite").parent().show();
SAU.$container.find("#imgInviteOutbound").parent().show();}else{SAU.$container.find("#imgInvite").parent().hide();SAU.$container.find("#imgInviteOutbound").parent().hide();}if(a.transfer){SAU.$container.find("#imgTransfer").parent().show();SAU.$container.find("#imgTransferOutbound").parent().show();}else{SAU.$container.find("#imgTransfer").parent().hide();
SAU.$container.find("#imgTransferOutbound").parent().hide();}if(a.hold){SAU.$container.find("#imgHold").parent().show();}else{SAU.$container.find("#imgHold").parent().hide();}if(a.unhold){SAU.$container.find("#imgUnHold").parent().show();}else{SAU.$container.find("#imgUnHold").parent().hide();}if(a.hold){SAU.$container.find("#imgHold").parent().show();
}else{SAU.$container.find("#imgHold").parent().hide();}if(SAM.isLogined()&&a.ready){SAU.$container.find("#imgAgentMonitor").parent().show();}else{SAU.$container.find("#imgAgentMonitor").parent().hide();}if(a.complete){SAU.$container.find("#imgAfterService").parent().show();}else{SAU.$container.find("#imgAfterService").parent().hide();
}}if(a.hangup){SAU.$container.find("#imgHangUp").attr("src",SAU.getFullImgUrl("images/hund.png"));}else{SAU.$container.find("#imgHangUp").attr("src",SAU.getFullImgUrl("images/hund1.png"));}if(a.invite){SAU.$container.find("#imgInvite").attr("src",SAU.getFullImgUrl("images/invi.png"));SAU.$container.find("#imgInviteOutbound").attr("src",SAU.getFullImgUrl("images/inviOut.png"));
}else{SAU.$container.find("#imgInvite").attr("src",SAU.getFullImgUrl("images/invi1.png"));SAU.$container.find("#imgInviteOutbound").attr("src",SAU.getFullImgUrl("images/inviOut1.png"));}if(a.transfer){SAU.$container.find("#imgTransfer").attr("src",SAU.getFullImgUrl("images/zhu.png"));SAU.$container.find("#imgTransferOutbound").attr("src",SAU.getFullImgUrl("images/transOut.png"));
}else{SAU.$container.find("#imgTransfer").attr("src",SAU.getFullImgUrl("images/zhu1.png"));SAU.$container.find("#imgTransferOutbound").attr("src",SAU.getFullImgUrl("images/transOut1.png"));}if(a.hold){SAU.$container.find("#imgHold").attr("src",SAU.getFullImgUrl("images/hold.png"));}else{SAU.$container.find("#imgHold").attr("src",SAU.getFullImgUrl("images/hold1.png"));
}if(a.unhold){SAU.$container.find("#imgUnHold").attr("src",SAU.getFullImgUrl("images/pickup.png"));}else{SAU.$container.find("#imgUnHold").attr("src",SAU.getFullImgUrl("images/pickup1.png"));}if(SAM.isLogined()){SAU.$container.find("#imgAgentMonitor").attr("src",SAU.getFullImgUrl("images/agents.png"));
}else{SAU.$container.find("#imgAgentMonitor").attr("src",SAU.getFullImgUrl("images/agents.png"));}if(a.complete){SAU.$container.find("#imgAfterService").attr("src",SAU.getFullImgUrl("images/call.png"));}else{SAU.$container.find("#imgAfterService").attr("src",SAU.getFullImgUrl("images/call1.png"));}var d=false;
if(SAM.getAgentStatus()){if(SAM.getAgentStatus().status=="ready"){SAU.$container.find("#imgReady").attr("src",SAU.getFullImgUrl("images/active.gif"));SAU.$container.find("#imgBusy").attr("src",SAU.getFullImgUrl("images/na.gif"));SAU.$container.find("#imgRest").attr("src",SAU.getFullImgUrl("images/na.gif"));
SAU.$container.find("#simpleReadyLink").text("就绪");SAU.$container.find("#simpleReadyLink").css("background","rgb(65, 0, 191) left center no-repeat");SAU.$container.find("#simpleReadyLink").css("padding","0 10px 0 30px");}else{if(SAM.getAgentStatus().status=="not_ready"){SAU.$container.find("#imgReady").attr("src",SAU.getFullImgUrl("images/na.gif"));
SAU.$container.find("#imgBusy").attr("src",SAU.getFullImgUrl("images/active.gif"));SAU.$container.find("#simpleReadyLink").text("忙");SAU.$container.find("#simpleReadyLink").css("background","red right center no-repeat");SAU.$container.find("#simpleReadyLink").css("padding","0 30px 0 10px");}else{d=true;
}}SAU.$container.find("#simpleReadyLink").css("background-image","url("+SAU.getFullImgUrl("images/btnCircle.png")+")");SAU.$container.find("#simpleReadyLink").css("background-size","22px");if(SAM.isCurrentResting()){SAU.$container.find("#imgRest").attr("src",SAU.getFullImgUrl("images/active.gif"));SAU.$container.find("#simpleImgRest").parent().hide();
}else{SAU.$container.find("#imgRest").attr("src",SAU.getFullImgUrl("images/na.gif"));if(SAU.getStyle()=="simple"&&SAU._showActions){SAU.$container.find("#simpleImgRest").parent().show();}}}else{d=true;}if(d){SAU.$container.find("#imgReady").attr("src",SAU.getFullImgUrl("images/na.gif"));SAU.$container.find("#imgBusy").attr("src",SAU.getFullImgUrl("images/na.gif"));
SAU.$container.find("#imgRest").attr("src",SAU.getFullImgUrl("images/na.gif"));SAU.$container.find("#simpleImgRest").parent().hide();}if(SAM.isLogined()){SAU.getStatusTextObj().text(SAM.getDisplayStatus());SAU.getStatusTextObj().css("color",SAU.getStyle()=="simple"?"white":"blue");}SAU.$container.find("#statusDuration").text(SAM.getDisplayStatusDuration());
SAU.$container.find("#simpleStatusDuration").text(SAM.getDisplayStatusDuration());if(SAU.getStyle()=="simple"){if(SAM.isLogined()){var b=SAU.$container.find("#simpleConnectStatus").text();if(b!="事后处理"&&b!="小憩片刻"){SAU.$container.find("#simpleReady").show();}else{SAU.$container.find("#simpleReady").hide();
}}else{SAU.$container.find("#simpleReady").hide();SAU.$container.find("#simpleReady").attr("title","");}SAU.updateStatusDuration();if(SAU.$container.find("#simpleConnectStatus").text()==SAU.$container.find("#simpleReadyLink").text()){SAU.$container.find("#simpleConnectStatus").hide();}else{SAU.$container.find("#simpleConnectStatus").show();
}}};SAU.updateStatusDuration=function(){if(SAU.getStyle()=="simple"){if(SAM.isLogined()){var a=SAU.$container.find("#simpleConnectStatus").text();SAU.$container.find("#simpleReady").attr("title",a+", 持续时间: "+SAM.getDisplayStatusDuration());if(a!="忙"&&a!="就绪"&&a!="小憩片刻"){SAU.$container.find("#simpleStatusDuration").show();
}else{SAU.$container.find("#simpleStatusDuration").hide();}}else{SAU.$container.find("#simpleReady").attr("title","");SAU.$container.find("#simpleStatusDuration").hide();}}else{SAU.$container.find("#simpleStatusDuration").hide();}};SAU.onConnectParams=function(){throw new Error("SAU.onConnectParams should be override.");
};SimpleAgentUIComponent=SAU;(function(){function e(s){var r=new JSJaCMessage();r.setType("normal");var t=new Array();t.push(["i",{"l_id":s}]);r.appendNode("server_holds",{xmlns:"uc.qingzhi-net.com"},t);SXC.send(r);}function d(r){if(r&&r.replace&&r.substring){r=r.replace("T"," ");r=r.substring(0,"2017-01-16T17:58:58".length);
}return r;}function g(s){delete s["jMessage"];var r=JSON.parse(JSON.stringify(s));delete r["server_time"];delete r["htmlbody"];if(r.sendTime){r.sendTime=d(r.sendTime);}r.domain=o(r.from);return r;}function h(r){if(r.eventType=="onRecvChatMsg"){var v=r.data;if(v&&v.server_id){setTimeout(function(){e(v.server_id);
},0);}var u=v.jMessage;try{var t=g(v);var s={"eventType":"recv_msg","msg":t};SAM._dispatcher.dispatchEvent(s);}finally{v.jMessage=u;}}}function m(r){setTimeout(function(){e(r.server_id);},0);r.server_time=d(r.server_time);if(CommonReqMgr.hasRequest(r.msg_id)){CommonReqMgr.triggerCallback(r.msg_id,r);
}}function j(r){r=r.replace(/\</g,"&lt;");r=r.replace(/\>/g,"&gt;");return r;}var n="_wt";var i="wx.";var p="weixin.";var b="qq";var a="qq";var f="weixin";var c="webchat";var l="app";function o(r){if(r.indexOf(i)==0||r.indexOf(p)==0){return f;}else{if(r.indexOf(b)==0){return a;}else{if(r.indexOf(n)>=0){return c;
}else{return l;}}}}function k(v){if(v==null){throw new Error("SimpleIM error of msg is NULL.");}if(!v.to){throw new Error("SimpleIM error of msg.to is empty.");}var t=new JSJaCMessage();var u=v.to.indexOf("@")>=0?v.to:v.to+"@"+SXC.getChtsvrDomain();t.setTo(new JSJaCJID(u));t.setBody(v.body?j(v.body):"");
if(v.type){t.setType(v.type);}if(v.xProducts&&v.xProducts.length){for(var x=0;x<v.xProducts.length;x++){var r=JSON.stringify(v.xProducts[x]);var w=JSJaCBuilder._text(t.getDoc(),r);t.appendNode("x",{"xmlns":"uc.onesoul.show.template/json"},[w]);}}if(v["extends"]&&v["extends"].length){var s=JSON.stringify(v["extends"]);
var w=JSJaCBuilder._text(t.getDoc(),s);t.appendNode("x",{"xmlns":"uc.onesoul/extends"},[w]);}if(v.fileList&&v.fileList.length){for(var x=0;x<v.fileList.length;x++){v.fileList[x].thumb_url=v.fileList[x].url;SXD.appendFileNode(t,v.fileList[x]);}}var y=new Array();y.push(["t",{}]);t.appendNode("r",{},y);
var z=JSJaCBuilder._text(t.getDoc(),v.nick_name?v.nick_name:"");t.appendNode("n",{"xmlns":"jabber:client"},[z]);if(v.session_stop&&v.session_stop==true){t.appendNode("x",{"xmlns":"uc.qingzhi.session/stop"},[""]);}return t;}var q={"sendSimpleMsg":function(s){var r=k(s);r.setID(CommonReqMgr.getNextReqId());
SXD.send(r);return r.getID();},"sendMsg":function(v,w,u,r){if(!q.isStarted()){q.start();}var t=k(v);t.setID(CommonReqMgr.getNextReqId());if(w||u){var s=CommonReqMgr.CALL_TIMEOUT_MILI_SECONDS;if(r!=null){s=r*1000;}CommonReqMgr.putRequest(t.getID(),w,function(){var x={"msg_id":t.getID(),"reason":"timeout"};
if(u){u(x);}},s);}SXD.send(t);return t.getID();},"start":function(){if(window.SAM==null){throw new Error("SAM(SimpleAgentMgr is not defined. so simpleIM cannot initialized.)");}if(window.SXC==null){throw new Error("SXC(SimpleXmppClient is not defined. so simpleIM cannot initialized.)");}SXC.removeEventListener(h);
SXC.addEventListener(h,"SIM._onConnectionEvent");SXD.onMessageAck=m;},"stop":function(){SXC.removeEventListener(h);SXD.onMessageAck=null;},"isStarted":function(){return SXD.onMessageAck!=null;},"parseXmlMsg":function(r){try{var u=XmlDocument.create("doc");u.loadXML(r);var s=JSJaCPacket.wrapNode(u.documentElement);
var v=SXD.convertJsJacMessageToXmppMessage(s);return g(v);}catch(t){throw new Error("parse chat msg content error:"+t);}},"getDomainFromNodeId":function(r){return o(r);}};window.SIM=q;window.SimpleIM=q;})();(function(){var j=3000;var i=5000;var n=5000;var f=null;var k=null;var e=null;var b=false;var q=null;
var l=false;var h=false;var d=0;var m=0;var g={};function s(){g={"main":null,"backup":null};}s();function a(w,u,t){if(t){g.main=(u=="online");}else{g.backup=(u=="online");}if(!e){return;}var v={"host":w,"type":u,"is_main":t};e(v);}function p(v,t){var u=v.substring(0,v.length-"chat".length)+"dataservice";
try{var x=$.ajax({"url":u,"timeout":j,"type":"get","data":{"methodname":"is_online","node_id":"acd"},"dataType":"text","success":function(y){if(t){l=false;}else{h=false;}if(y.indexOf("online")>=0){a(v,"online",t);}else{if(window.console){window.console.log("detected finish and acd is offline. isMain:"+t+", data:"+y);
}a(v,"offline",t);}},"complete":function(z,y){if(t){l=false;}else{h=false;}if(window.console&&(y=="timeout"||y=="error")){window.console.log("detected complete and host is offline. isMain:"+t+", status:"+y);}if(y=="timeout"){a(v,"offline",t);}else{if(y=="error"){a(v,"offline",t);}}}});}catch(w){setTimeout(function(){throw w;
},0);}}function o(){if(!b){return;}var u=new Date().getTime()-d;var t=new Date().getTime()-m;if(f&&!l&&u>=i){l=true;d=new Date().getTime();p(f,true);}if(k&&!h&&t>=n){h=true;setTimeout(function(){m=new Date().getTime();p(k,false);},1000);}}function c(u,t){return(u.length-u.indexOf(t))==t.length;}var r={"isChatService":function(t){return t&&c(t,"/chat");
},"setService":function(t,u){if(t&&!c(t,"/chat")){throw new Error("非法的 服务地址, 服务地址应为 /chat 结尾:"+t);}if(u&&!c(u,"/chat")){throw new Error("非法的 服务地址, 服务地址应为 /chat 结尾:"+u);}f=t;k=u;if(f&&k){r.start();}else{r.stop();}},"setEventListener":function(t){e=t;},"getDestHost":function(){if(g.main===null){if((SXD.getCurrentHttpBase()==f)&&SXD.isConnected()){g.main=true;
}}if(k&&!g.main&&g.backup){return k;}else{return f;}},"start":function(){isFirstData=false;if(b){return;}b=true;q=setInterval(o,1000);},"stop":function(){isFirstData=false;if(b){b=false;clearInterval(q);q=null;}s();},"getBackupHost":function(){return k;},"isStarted":function(){return b;}};window.SimpleDetector=r;
})();(function(){var e=null;var f=0;var d={};var h=null;var g=null;function a(){SimpleDetector.stop();d={};clearTimeout(h);clearTimeout(g);h=null;g=null;}function c(i,j){try{if(e){e(i,j);}}finally{clearTimeout(h);clearTimeout(g);h=setTimeout(function(){SXD._disconnect();},3000);g=setTimeout(function(){SXD.doConnect("sha_shift_connect");
},3600);}}SimpleDetector.setEventListener(function(k){d[k.host]=k.type;var i=SimpleDetector.getDestHost();var j=d[i]=="online";if(SXD.isConnected()&&j&&i!=SXD.getCurrentHttpBase()){c(SXD.getCurrentHttpBase(),i);}});if(window.SXD==null){throw new Error("SXD(SimpleXmppDirectMessageMgr is not defined. so simpleHA cannot initialized.)");
}SXD.onAfterDisconnect=function(){a();};SXD.onBeforeConnect=function(k){try{var i=SimpleDetector.getDestHost();if(i&&i!=k.httpbase){var j=JSON.parse(JSON.stringify(k));j.httpbase=i;return j;}return k;}finally{SimpleDetector.start();}};var b={"setService":function(i,j){SimpleDetector.setService(i,j);},"setListener":function(i){e=i;
}};window.SHA=b;window.SimpleHA=b;})();